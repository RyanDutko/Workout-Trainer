{% extends "base.html" %}

{% block title %}Plan Philosophy - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-brain me-2"></i>Your Training Philosophy</h1>
    <small class="text-muted">Understanding the "why" behind your workout plan</small>
</div>

<!-- Overall Philosophy Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Overall Training Philosophy</h5>
            </div>
            <div class="card-body">
                <div id="overallPhilosophy">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading your training philosophy...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily Plan Philosophy Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Daily Plan Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="dailyPhilosophyAccordion">
                    <!-- Will be populated via JavaScript -->
                </div>

                <div class="text-center mt-4">
                    <button id="refreshPhilosophyBtn" class="btn btn-outline-primary">
                        <i class="fas fa-sync me-2"></i>Refresh Philosophy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Integration Info -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-robot me-2"></i>
            <strong>AI Integration:</strong> Your training philosophy is automatically updated when you discuss changes with Grok in your regular chat. Just tell Grok about modifications to your approach and this page will reflect those updates!
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPhilosophy = {};
let currentPlan = {};

// Load philosophy on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPhilosophy();
    startPhilosophyWatcher();
    checkForPendingUpdates();
});

// Refresh button handler
document.getElementById('refreshPhilosophyBtn').addEventListener('click', function() {
    loadPhilosophy();
});

async function loadPhilosophy() {
    try {
        // Show loading state
        document.getElementById('overallPhilosophy').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading your training philosophy...</p>
            </div>
        `;

        // Load both context and weekly plan
        const [contextResponse, planResponse] = await Promise.all([
            fetch('/get_stored_context'),
            fetch('/api/weekly_plan')
        ]);

        const contextData = await contextResponse.json();
        const planData = await planResponse.json();

        currentPhilosophy = contextData;
        currentPlan = planData;

        displayOverallPhilosophy(contextData);
        displayDailyBreakdown(contextData, planData);

        // Show success message if this was triggered by an update
        if (window.philosophyJustUpdated) {
            showUpdateNotification();
            window.philosophyJustUpdated = false;
        }

    } catch (error) {
        console.error('Error loading philosophy:', error);
        document.getElementById('overallPhilosophy').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error loading philosophy. Please try again.
            </div>
        `;
    }
}

// Auto-refresh philosophy when updates are detected
function startPhilosophyWatcher() {
    // Check for updates every 5 seconds
    setInterval(async () => {
        try {
            // Check for pending updates first
            checkForPendingUpdates();
            
            // Then check for actual philosophy changes
            const response = await fetch('/get_stored_context');
            const newData = await response.json();
            
            // Compare updated dates to detect changes
            if (currentPhilosophy?.plan_context?.updated_date !== newData?.plan_context?.updated_date) {
                console.log('ðŸ§  Philosophy update detected, refreshing...');
                window.philosophyJustUpdated = true;
                loadPhilosophy();
            }
        } catch (error) {
            // Silently handle errors in background polling
        }
    }, 5000);
}

function showUpdateNotification() {
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
    notification.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Philosophy Updated!</strong> Your training philosophy has been updated successfully.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Check for pending philosophy updates from chat
async function checkForPendingUpdates() {
    try {
        const response = await fetch('/api/get_pending_philosophy_update');
        const data = await response.json();
        
        if (data.has_pending) {
            showPhilosophyConfirmationDialog(data);
        }
    } catch (error) {
        console.error('Error checking for pending updates:', error);
    }
}

function showPhilosophyConfirmationDialog(updateData) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'philosophyConfirmModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirm Philosophy Update
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Your Request:</strong> "${updateData.user_request}"
                    </div>
                    
                    <p><strong>Grok wants to update your training philosophy. Here are the proposed changes:</strong></p>
                    
                    <div class="row">
                        ${updateData.plan_philosophy ? `
                        <div class="col-12 mb-3">
                            <h6><i class="fas fa-brain me-2 text-primary"></i>Core Philosophy</h6>
                            <div class="border border-primary rounded p-3">
                                ${updateData.plan_philosophy}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${updateData.weekly_structure ? `
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-calendar me-2 text-success"></i>Weekly Structure</h6>
                            <div class="border border-success rounded p-2">
                                ${updateData.weekly_structure}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${updateData.progression_strategy ? `
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-chart-line me-2 text-info"></i>Progression Strategy</h6>
                            <div class="border border-info rounded p-2">
                                ${updateData.progression_strategy}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${updateData.special_considerations ? `
                        <div class="col-12 mb-3">
                            <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Special Considerations</h6>
                            <div class="border border-warning rounded p-2">
                                ${updateData.special_considerations}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${updateData.reasoning ? `
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Reasoning:</strong> ${updateData.reasoning}
                        </small>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="rejectPhilosophyUpdate(${updateData.update_id})">
                        <i class="fas fa-times me-2"></i>Reject Changes
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmPhilosophyUpdate(${updateData.update_id})">
                        <i class="fas fa-check me-2"></i>Apply Changes
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show the modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up when modal is hidden
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

async function confirmPhilosophyUpdate(updateId) {
    try {
        const response = await fetch('/api/confirm_philosophy_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ update_id: updateId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('philosophyConfirmModal'));
            modal.hide();
            
            // Refresh philosophy and show success
            loadPhilosophy();
            showUpdateNotification();
        } else {
            alert('Error applying changes: ' + result.error);
        }
    } catch (error) {
        alert('Error applying changes: ' + error.message);
    }
}

async function rejectPhilosophyUpdate(updateId) {
    try {
        const response = await fetch('/api/reject_philosophy_update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ update_id: updateId })
        });
        
        const result = await response.json();
        
        // Close modal regardless of result
        const modal = bootstrap.Modal.getInstance(document.getElementById('philosophyConfirmModal'));
        modal.hide();
        
        if (result.success) {
            console.log('Philosophy update rejected');
        }
    } catch (error) {
        console.error('Error rejecting update:', error);
    }
}

function displayOverallPhilosophy(data) {
    const container = document.getElementById('overallPhilosophy');

    if (!data.plan_context) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No philosophy found.</strong> Start chatting with Grok about your training approach to automatically populate your philosophy!
            </div>
        `;
        return;
    }

    const ctx = data.plan_context;

    let html = '<div class="row">';

    if (ctx.plan_philosophy) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-brain me-2 text-primary"></i>Core Philosophy</h6>
                <p class="border-start border-primary ps-3">${ctx.plan_philosophy}</p>
            </div>
        `;
    }

    if (ctx.weekly_structure) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-calendar me-2 text-success"></i>Weekly Structure</h6>
                <p class="border-start border-success ps-3">${ctx.weekly_structure}</p>
            </div>
        `;
    }

    if (ctx.progression_strategy) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-chart-line me-2 text-info"></i>Progression Strategy</h6>
                <p class="border-start border-info ps-3">${ctx.progression_strategy}</p>
            </div>
        `;
    }

    if (ctx.special_considerations) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Special Considerations</h6>
                <p class="border-start border-warning ps-3">${ctx.special_considerations}</p>
            </div>
        `;
    }

    html += '</div>';

    // Add creation/update info
    if (ctx.created_by_ai) {
        html += `
            <div class="mt-3 text-muted small">
                <i class="fas fa-robot me-1"></i>
                Created by AI analysis on ${ctx.created_date || 'unknown date'}
                ${ctx.updated_date ? ` â€¢ Last updated: ${ctx.updated_date}` : ''}
            </div>
        `;
    }

    container.innerHTML = html;
}

function displayDailyBreakdown(contextData, planData) {
    const container = document.getElementById('dailyPhilosophyAccordion');

    if (!planData || Object.keys(planData).length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-calendar-times me-2"></i>
                No weekly plan found. Set up your weekly plan first.
            </div>
        `;
        return;
    }

    const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = {
        'monday': 'Monday',
        'tuesday': 'Tuesday', 
        'wednesday': 'Wednesday',
        'thursday': 'Thursday',
        'friday': 'Friday',
        'saturday': 'Saturday',
        'sunday': 'Sunday'
    };

    let html = '';

    dayOrder.forEach((day, index) => {
        if (planData[day] && planData[day].length > 0) {
            const exercises = planData[day];
            const dayName = dayNames[day];

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${day}">
                        <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapse${day}">
                            <i class="fas fa-dumbbell me-2"></i>
                            <strong>${dayName}</strong>
                            <span class="badge bg-secondary ms-2">${exercises.length} exercises</span>
                        </button>
                    </h2>
                    <div id="collapse${day}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                         data-bs-parent="#dailyPhilosophyAccordion">
                        <div class="accordion-body">
            `;

            // Day overview
            html += `
                <div class="mb-4 p-3 bg-light rounded">
                    <h6><i class="fas fa-info-circle me-2"></i>${dayName} Overview</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Exercise Count:</strong> ${exercises.length} exercises<br>
                            <strong>Structure:</strong> ${getWorkoutStructure(exercises)}
                        </div>
                        <div class="col-md-6">
                            <strong>Focus:</strong> ${getWorkoutFocus(exercises)}<br>
                            <strong>Volume:</strong> ${getTotalSets(exercises)} total sets
                        </div>
                    </div>
                </div>
            `;

            // Exercise breakdown
            html += '<div class="table-responsive">';
            html += `
                <table class="table table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Exercise</th>
                            <th>Sets Ã— Reps</th>
                            <th>Weight</th>
                            <th>Purpose</th>
                            <th>Progression</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            exercises.forEach(exercise => {
                const metadata = getExerciseMetadata(exercise.exercise, contextData);
                html += `
                    <tr>
                        <td><strong>${exercise.exercise}</strong></td>
                        <td>${exercise.sets} Ã— ${exercise.reps}</td>
                        <td>${exercise.weight}</td>
                        <td>${metadata.purpose}</td>
                        <td><span class="badge bg-${getProgressionColor(metadata.progression)}">${metadata.progression}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div></div></div>';
        }
    });

    if (html === '') {
        html = `
            <div class="alert alert-info">
                <i class="fas fa-calendar-plus me-2"></i>
                No training days found. Add exercises to your weekly plan to see daily philosophy breakdowns.
            </div>
        `;
    }

    container.innerHTML = html;
}

function getExerciseMetadata(exerciseName, contextData) {
    if (!contextData.exercise_metadata) {
        return {
            purpose: 'General strength and hypertrophy',
            progression: 'normal'
        };
    }

    const metadata = contextData.exercise_metadata.find(ex => 
        ex.exercise_name.toLowerCase() === exerciseName.toLowerCase()
    );

    if (metadata) {
        return {
            purpose: metadata.primary_purpose || 'General strength and hypertrophy',
            progression: metadata.progression_logic || 'normal'
        };
    }

    // Fallback based on exercise name
    const exerciseLower = exerciseName.toLowerCase();
    if (exerciseLower.includes('curl') || exerciseLower.includes('raise') || exerciseLower.includes('fly')) {
        return { purpose: 'Isolation hypertrophy', progression: 'slow' };
    } else if (exerciseLower.includes('press') || exerciseLower.includes('squat') || exerciseLower.includes('deadlift')) {
        return { purpose: 'Compound strength', progression: 'aggressive' };
    } else if (exerciseLower.includes('ab') || exerciseLower.includes('crunch')) {
        return { purpose: 'Core strengthening', progression: 'aggressive' };
    }

    return { purpose: 'General strength and hypertrophy', progression: 'normal' };
}

function getProgressionColor(progression) {
    switch (progression) {
        case 'aggressive': return 'success';
        case 'slow': return 'warning';
        case 'maintain': return 'secondary';
        default: return 'primary';
    }
}

function getWorkoutStructure(exercises) {
    if (exercises.length <= 3) return 'Focused';
    if (exercises.length <= 5) return 'Moderate';
    return 'High Volume';
}

function getWorkoutFocus(exercises) {
    const exerciseNames = exercises.map(ex => ex.exercise.toLowerCase()).join(' ');

    if (exerciseNames.includes('bench') || exerciseNames.includes('chest')) {
        return 'Upper Body Push';
    } else if (exerciseNames.includes('row') || exerciseNames.includes('pull')) {
        return 'Upper Body Pull';
    } else if (exerciseNames.includes('squat') || exerciseNames.includes('leg')) {
        return 'Lower Body';
    } else if (exerciseNames.includes('ab') || exerciseNames.includes('core')) {
        return 'Core & Accessories';
    }
    return 'Full Body';
}

function getTotalSets(exercises) {
    return exercises.reduce((total, ex) => total + (ex.sets || 0), 0);
}
</script>
{% endblock %}