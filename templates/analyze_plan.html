{% extends "base.html" %}

{% block title %}Plan Analysis - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-brain me-2"></i>Training Philosophy & Plan Analysis</h1>
    <div class="btn-toolbar">
        <button class="btn btn-primary me-2" onclick="triggerFullPlanReview()">
            <i class="fas fa-search me-2"></i>Full Plan Review
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshPhilosophy()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Core Philosophy Section (Static) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-compass me-2"></i>Core Training Philosophy</h5>
                <small>Your fundamental training approach - remains consistent</small>
                <button class="btn btn-light btn-sm ms-3" onclick="openPhilosophyEditor()">
                    <i class="fas fa-edit me-1"></i>Edit Philosophy
                </button>
            </div>
            <div class="card-body">
                <div id="corePhilosophy">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading your core training philosophy...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plan Priorities Section (Dynamic) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Current Plan Priorities</h5>
                    <small>Specific, ordered goals that drive your current plan</small>
                </div>
                <button class="btn btn-light btn-sm" onclick="openPriorityEditor()">
                    <i class="fas fa-edit me-1"></i>Update Priorities
                </button>
            </div>
            <div class="card-body">
                <div id="planPriorities">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading your current priorities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Intelligent Plan Modifications Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Smart Plan Modifications</h5>
                <small>AI-powered suggestions based on your priorities and current plan</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="priorityInput"
                                   placeholder="e.g., I want better leg aesthetics as priority #2">
                            <button class="btn btn-warning" onclick="processPriorityChange()">
                                <i class="fas fa-wand-magic me-2"></i>Analyze & Suggest Changes
                            </button>
                        </div>
                        <small class="text-muted">Tell me how you want to adjust your priorities, and I'll intelligently modify your plan.</small>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-outline-warning" onclick="showQuickPriorityOptions()">
                                <i class="fas fa-list me-2"></i>Quick Options
                            </button>
                        </div>
                    </div>
                </div>
                <div id="modificationSuggestions" class="mt-3" style="display: none;">
                    <!-- AI suggestions will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Plan Context -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Weekly Plan Analysis</h5>
            </div>
            <div class="card-body">
                <div id="weeklyPlanAnalysis">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing your weekly plan...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Priority Editor Modal -->
<div class="modal fade" id="priorityEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Plan Priorities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Priority #1 (Most Important)</label>
                    <input type="text" class="form-control" id="priority1" placeholder="e.g., Midsection development">
                </div>
                <div class="mb-3">
                    <label class="form-label">Priority #2</label>
                    <input type="text" class="form-control" id="priority2" placeholder="e.g., Leg aesthetics">
                </div>
                <div class="mb-3">
                    <label class="form-label">Priority #3</label>
                    <input type="text" class="form-control" id="priority3" placeholder="e.g., Upper body strength">
                </div>
                <div class="mb-3">
                    <label class="form-label">Priority #4 (Optional)</label>
                    <input type="text" class="form-control" id="priority4" placeholder="e.g., Conditioning">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="savePriorities()">
                    <i class="fas fa-save me-2"></i>Save & Update Plan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Priority Options Modal -->
<div class="modal fade" id="quickPriorityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Priority Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="quickPriorityChange('Add leg aesthetics as priority 2')">
                        <i class="fas fa-plus me-2"></i>Add Leg Aesthetics Focus
                    </button>
                    <button class="btn btn-outline-primary" onclick="quickPriorityChange('Make upper body strength priority 1')">
                        <i class="fas fa-dumbbell me-2"></i>Prioritize Upper Body Strength
                    </button>
                    <button class="btn btn-outline-primary" onclick="quickPriorityChange('Add cardio conditioning as priority 3')">
                        <i class="fas fa-heartbeat me-2"></i>Add Conditioning Focus
                    </button>
                    <button class="btn btn-outline-primary" onclick="quickPriorityChange('Focus more on posterior chain development')">
                        <i class="fas fa-arrow-right me-2"></i>Emphasize Posterior Chain
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Philosophy Editor Modal -->
<div class="modal fade" id="philosophyEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Core Training Philosophy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="corePhilosophyText" class="form-label">Core Training Philosophy</label>
                    <textarea class="form-control" id="corePhilosophyText" rows="6" 
                              placeholder="Enter your core training philosophy - your fundamental approach to training that remains consistent..."></textarea>
                    <div class="form-text">
                        This should include your foundational training principles, preferred equipment/methods, and overall approach.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePhilosophy()">
                    <i class="fas fa-save me-2"></i>Save Philosophy
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPhilosophy = null;
let currentPriorities = [];

// Load philosophy and priorities on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPhilosophyAndPriorities();
});

async function loadPhilosophyAndPriorities() {
    try {
        const response = await fetch('/get_stored_context');
        const data = await response.json();

        currentPhilosophy = data;
        displayCorePhilosophy(data);
        displayPlanPriorities(data);
        displayWeeklyPlanAnalysis(data);
    } catch (error) {
        console.error('Error loading philosophy:', error);
        showErrorState();
    }
}

function displayCorePhilosophy(data) {
    const container = document.getElementById('corePhilosophy');

    if (!data.plan_context || !data.plan_context.plan_philosophy) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No core philosophy set yet.</strong>
                <p class="mb-2">Chat with Grok about your training approach to establish your core philosophy!</p>
                <button class="btn btn-primary btn-sm" onclick="window.location.href='/chat'">
                    <i class="fas fa-comments me-2"></i>Start Chat
                </button>
            </div>
        `;
        return;
    }

    const philosophy = data.plan_context.plan_philosophy;
    container.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <p class="lead">${philosophy}</p>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Philosophy Principles</h6>
                        <ul class="list-unstyled small">
                            ${extractPrinciples(philosophy).map(principle => `<li><i class="fas fa-check text-success me-2"></i>${principle}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayPlanPriorities(data) {
    const container = document.getElementById('planPriorities');

    // Extract priorities from philosophy or use default structure
    const priorities = extractPrioritiesFromPhilosophy(data);

    if (priorities.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>No specific priorities detected.</strong>
                <p class="mb-2">Update your priorities to get targeted plan suggestions.</p>
                <button class="btn btn-warning btn-sm" onclick="openPriorityEditor()">
                    <i class="fas fa-edit me-2"></i>Set Priorities
                </button>
            </div>
        `;
        return;
    }

    let html = '<div class="row">';
    priorities.forEach((priority, index) => {
        html += `
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 ${index === 0 ? 'border-success' : 'border-secondary'}">
                    <div class="card-body text-center">
                        <div class="badge ${index === 0 ? 'bg-success' : 'bg-secondary'} mb-2">Priority #${index + 1}</div>
                        <h6 class="card-title">${priority.title}</h6>
                        <p class="card-text text-muted small">${priority.description}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="adjustPriority(${index}, '${priority.title}')">
                            <i class="fas fa-adjust me-1"></i>Adjust
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
    currentPriorities = priorities;
}

async function displayWeeklyPlanAnalysis(data) {
    const container = document.getElementById('weeklyPlanAnalysis');

    try {
        // Get actual weekly plan data
        const response = await fetch('/api/weekly_plan');

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const weeklyPlan = await response.json();

        // Check if weeklyPlan has an error property
        if (weeklyPlan.error) {
            throw new Error(weeklyPlan.error);
        }

        // Analyze the plan
        const analysis = analyzeWeeklyPlan(weeklyPlan);

        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-pie me-2"></i>Plan Distribution</h6>
                    <div id="planDistributionChart">
                        ${generatePlanDistribution(analysis)}
                    </div>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Plan Insights</h6>
                    <div id="planGaps">
                        ${generatePlanInsights(analysis)}
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-calendar-week me-2"></i>Weekly Overview</h6>
                    <div id="weeklyOverviewSection">
                        ${generateWeeklyOverview(weeklyPlan)}
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <h6><i class="fas fa-scroll me-2"></i>Daily Training Philosophy</h6>
                    <div id="dailyPhilosophySection">
                        ${generateDailyPhilosophyCards(weeklyPlan)}
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;

        // Load progression notes for each exercise (with delay to ensure DOM is ready)
        setTimeout(() => {
            loadProgressionNotes();
        }, 100);

    } catch (error) {
        console.error('Error loading weekly plan analysis:', error);
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Could not load weekly plan analysis: ${error.message}
                <br><small class="mt-2 d-block">Please try refreshing the page.</small>
            </div>
        `;
    }
}

function analyzeWeeklyPlan(weeklyPlan) {
    const analysis = {
        totalExercises: 0,
        exerciseTypes: {
            compound: 0,
            isolation: 0,
            core: 0,
            cardio: 0
        },
        bodyParts: {
            legs: 0,
            chest: 0,
            back: 0,
            shoulders: 0,
            arms: 0,
            core: 0
        },
        weeklyVolume: 0,
        daysActive: Object.keys(weeklyPlan).length
    };

    // Analyze each day's exercises
    Object.keys(weeklyPlan).forEach(day => {
        weeklyPlan[day].forEach(exercise => {
            analysis.totalExercises++;

            const exerciseName = exercise.exercise.toLowerCase();

            // Categorize exercise types
            if (exerciseName.includes('squat') || exerciseName.includes('deadlift') ||
                exerciseName.includes('press') || exerciseName.includes('row')) {
                analysis.exerciseTypes.compound++;
            } else if (exerciseName.includes('curl') || exerciseName.includes('extension') ||
                      exerciseName.includes('raise') || exerciseName.includes('fly')) {
                analysis.exerciseTypes.isolation++;
            } else if (exerciseName.includes('ab') || exerciseName.includes('core') ||
                      exerciseName.includes('crunch') || exerciseName.includes('woodchop')) {
                analysis.exerciseTypes.core++;
            }

            // Categorize body parts
            if (exerciseName.includes('leg') || exerciseName.includes('squat') ||
                exerciseName.includes('glute') || exerciseName.includes('adductor')) {
                analysis.bodyParts.legs++;
            } else if (exerciseName.includes('chest') || exerciseName.includes('press') ||
                      exerciseName.includes('fly')) {
                analysis.bodyParts.chest++;
            } else if (exerciseName.includes('row') || exerciseName.includes('pull') ||
                      exerciseName.includes('lat')) {
                analysis.bodyParts.back++;
            } else if (exerciseName.includes('shoulder') || exerciseName.includes('lateral') ||
                      exerciseName.includes('rear delt')) {
                analysis.bodyParts.shoulders++;
            } else if (exerciseName.includes('curl') || exerciseName.includes('tricep')) {
                analysis.bodyParts.arms++;
            } else if (exerciseName.includes('ab') || exerciseName.includes('core') ||
                      exerciseName.includes('crunch')) {
                analysis.bodyParts.core++;
            }

            // Calculate estimated volume
            try {
                const sets = parseInt(exercise.sets) || 3;
                const reps = parseInt(exercise.reps.split('-')[0]) || 10;
                const weight = parseFloat(exercise.weight.replace(/[^\d.]/g, '')) || 0;
                analysis.weeklyVolume += sets * reps * weight;
            } catch (e) {
                // Skip volume calculation for this exercise
            }
        });
    });

    return analysis;
}

function generatePlanDistribution(analysis) {
    const bodyPartTotal = Object.values(analysis.bodyParts).reduce((a, b) => a + b, 0);

    let html = '<div class="mb-3">';

    // Body part distribution
    Object.entries(analysis.bodyParts).forEach(([bodyPart, count]) => {
        if (count > 0) {
            const percentage = Math.round((count / bodyPartTotal) * 100);
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-capitalize">${bodyPart}</span>
                    <div class="d-flex align-items-center">
                        <div class="progress me-2" style="width: 60px; height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">${count} (${percentage}%)</small>
                    </div>
                </div>
            `;
        }
    });

    html += '</div>';

    // Quick stats
    html += `
        <div class="row g-2">
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body text-center p-2">
                        <div class="h5 mb-0 text-primary">${analysis.totalExercises}</div>
                        <small class="text-muted">Total Exercises</small>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card bg-light">
                    <div class="card-body text-center p-2">
                        <div class="h5 mb-0 text-success">${analysis.daysActive}</div>
                        <small class="text-muted">Training Days</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    return html;
}

function generatePlanInsights(analysis) {
    const insights = [];

    // Check for potential imbalances
    if (analysis.bodyParts.legs > analysis.bodyParts.chest + analysis.bodyParts.back) {
        insights.push({
            type: 'info',
            text: 'Strong lower body focus - great for leg development!'
        });
    }

    if (analysis.bodyParts.core >= 3) {
        insights.push({
            type: 'success',
            text: 'Excellent core emphasis - aligns with midsection goals'
        });
    }

    if (analysis.exerciseTypes.compound < analysis.exerciseTypes.isolation) {
        insights.push({
            type: 'warning',
            text: 'Consider adding more compound movements for efficiency'
        });
    }

    if (analysis.daysActive >= 5) {
        insights.push({
            type: 'info',
            text: 'High training frequency - ensure adequate recovery'
        });
    }

    // Default positive insight if no specific issues
    if (insights.length === 0) {
        insights.push({
            type: 'success',
            text: 'Well-balanced plan with good exercise variety'
        });
    }

    let html = '';
    insights.forEach(insight => {
        const iconClass = insight.type === 'success' ? 'fa-check-circle' :
                         insight.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        const textClass = insight.type === 'success' ? 'text-success' :
                         insight.type === 'warning' ? 'text-warning' : 'text-info';

        html += `
            <div class="d-flex align-items-start mb-2">
                <i class="fas ${iconClass} ${textClass} me-2 mt-1"></i>
                <small>${insight.text}</small>
            </div>
        `;
    });

    return html;
}

function generateWeeklyOverview(weeklyPlan) {
    let html = '<div class="row g-2">';

    const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    dayOrder.forEach(day => {
        if (weeklyPlan[day] && weeklyPlan[day].length > 0) {
            html += `
                <div class="col-md-4 col-lg-3 mb-2">
                    <div class="card h-100">
                        <div class="card-header py-2">
                            <h6 class="mb-0 text-capitalize">${day}</h6>
                        </div>
                        <div class="card-body py-2">
                            <small class="text-muted">${weeklyPlan[day].length} exercises</small>
                            <div class="mt-1">
                                ${weeklyPlan[day].slice(0, 3).map(ex =>
                                    `<div class="text-truncate" style="font-size: 0.75rem;">${ex.exercise}</div>`
                                ).join('')}
                                ${weeklyPlan[day].length > 3 ? `<small class="text-muted">+${weeklyPlan[day].length - 3} more</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });

    html += '</div>';
    return html;
}

function generateDailyPhilosophyCards(weeklyPlan) {
    let html = '';

    // Philosophy color legend
    html += `
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body py-2">
                        <div class="row g-2 text-center">
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-danger me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>Midsection Focus</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-primary me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>Compound Strength</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-success me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>Machine Isolation</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-warning me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>Upper Isolation</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-info me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>Bodyweight</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-secondary me-2" style="width: 12px; height: 12px; border-radius: 50%;">&nbsp;</span>
                                    <small>General</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    dayOrder.forEach(day => {
        if (weeklyPlan[day] && weeklyPlan[day].length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleDayPhilosophy('${day}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-capitalize">
                                <i class="fas fa-calendar-day me-2"></i>${day}
                                <small class="text-muted ms-2">(${weeklyPlan[day].length} exercises)</small>
                            </h6>
                            <i class="fas fa-chevron-down" id="chevron-${day}"></i>
                        </div>
                    </div>
                    <div class="collapse" id="philosophy-${day}">
                        <div class="card-body">
                            <div class="row">
                                ${weeklyPlan[day].map((exercise, index) => {
                                    const philosophyData = getExercisePhilosophy(exercise.exercise);
                                    const exerciseName = exercise.exercise;
                                    return `
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-${philosophyData.colorClass}">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-start">
                                                        <div class="badge bg-${philosophyData.colorClass} me-2">${index + 1}</div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="card-title mb-1">${exercise.exercise}</h6>
                                                            <small class="text-muted">${exercise.sets}x${exercise.reps}@${exercise.weight}</small>
                                                            <p class="card-text mt-2 small">
                                                                <strong>Purpose:</strong> ${philosophyData.purpose}
                                                            </p>
                                                            <!-- Progression Notes Section -->
                                                            <div class="mb-3">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <h6 class="text-success mb-0">
                                                                        <i class="fas fa-chart-line me-1"></i>Progression Notes
                                                                    </h6>
                                                                </div>
                                                                <div class="border-start border-3 border-success ps-3" id="progression-notes-${exerciseName.replace(/\s+/g, '-')}">
                                                                    <div class="small">
                                                                        <div class="spinner-border spinner-border-sm text-muted me-2" role="status">
                                                                            <span class="visually-hidden">Loading...</span>
                                                                        </div>
                                                                        <span class="text-muted">Analyzing progression...</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });

    return html;
}

function loadProgressionNotes() {
    // Find all elements that need progression notes
    document.querySelectorAll('[id^="progression-notes-"]').forEach(container => {
        const exerciseId = container.id.replace('progression-notes-', '');
        const exerciseName = exerciseId.replace(/-/g, ' '); // Reconstruct the exercise name

        // Find the corresponding exercise data from the weekly plan
        const exerciseCard = container.closest('.card-body');
        if (exerciseCard) {
            const titleElement = exerciseCard.querySelector('.card-title');
            const exerciseDataElement = exerciseCard.querySelector('.text-muted');

            if (titleElement && exerciseDataElement) {
                const fullExerciseName = titleElement.textContent.trim();
                const exerciseDataText = exerciseDataElement.textContent;

                // Parse exercise data (format: "3x8-12@135lbs")
                const parts = exerciseDataText.match(/(\d+)x([\d-]+)@([\w\d.]+)/);
                let sets = '3';
                let reps = '8-12';
                let weight = 'bodyweight';

                if (parts && parts.length >= 4) {
                    sets = parts[1];
                    reps = parts[2];
                    weight = parts[3];
                }

                const exerciseData = {
                    exercise: fullExerciseName,
                    sets: sets,
                    reps: reps,
                    weight: weight
                };

                generateProgressionNotes(fullExerciseName, exerciseData).then(notes => {
                    if (notes && notes.length > 0) {
                        container.innerHTML = notes.map(note => `<div class="small mb-1">${note}</div>`).join('');
                    } else {
                        container.innerHTML = '<div class="small text-muted">No progression data available</div>';
                    }
                }).catch(error => {
                    console.error('Error loading progression notes:', error);
                    container.innerHTML = '<div class="small text-muted">Unable to load progression notes</div>';
                });
            } else {
                container.innerHTML = '<div class="small text-muted">Exercise data not found</div>';
            }
        }
    });
}


function generateProgressionNotes(exerciseName, exerciseData) {
    return new Promise((resolve, reject) => {
        // Validate input data
        if (!exerciseName || !exerciseData) {
            resolve([`<span class="text-muted"><i class="fas fa-info-circle me-1"></i>No exercise data available</span>`]);
            return;
        }

        // Get recent performance data for this exercise
        fetch(`/get_exercise_performance/${encodeURIComponent(exerciseName)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let progressionNotes = [];

                // Get current plan data for this exercise
                const currentWeight = parseFloat(exerciseData.weight.toString().replace(/[^\d.]/g, '')) || 0;
                const currentSets = exerciseData.sets || '3';
                const currentReps = exerciseData.reps || '8-12';

                // Check if there's recent performance data
                if (data && data.dates && data.dates.length > 0) {
                    const recentWeight = data.max_weights[data.max_weights.length - 1] || 0;
                    const progress = data.progress || 0;
                    const totalSessions = data.total_sessions || 0;

                    // Weight progression analysis
                    if (currentWeight > 0) {
                        if (recentWeight > currentWeight) {
                            progressionNotes.push(`<span class="text-success"><i class="fas fa-arrow-up me-1"></i>Bumped up from ${currentWeight}lbs - great progress!</span>`);
                        } else if (recentWeight < currentWeight && recentWeight > 0) {
                            progressionNotes.push(`<span class="text-warning"><i class="fas fa-target me-1"></i>Aim for ${currentWeight}lbs to match your plan</span>`);
                        }

                        // Next progression suggestion
                        if (recentWeight >= currentWeight && progress >= 0) {
                            const nextWeight = currentWeight + 5;
                            progressionNotes.push(`<span class="text-primary"><i class="fas fa-arrow-up me-1"></i>Consider ${nextWeight}lbs next week</span>`);
                        }
                    }

                    // Progress trend analysis
                    if (progress > 10) {
                        progressionNotes.push(`<span class="text-primary"><i class="fas fa-fire me-1"></i>Strong ${progress.toFixed(1)}% improvement - ready for next level</span>`);
                    } else if (progress < -5) {
                        progressionNotes.push(`<span class="text-info"><i class="fas fa-balance-scale me-1"></i>Focus on consistency before adding weight</span>`);
                    }

                    // Session consistency
                    if (totalSessions >= 3) {
                        progressionNotes.push(`<span class="text-success"><i class="fas fa-check-circle me-1"></i>${totalSessions} sessions logged - great consistency!</span>`);
                    } else if (totalSessions > 0) {
                        progressionNotes.push(`<span class="text-warning"><i class="fas fa-calendar-check me-1"></i>Log more sessions to track progress better</span>`);
                    }

                } else {
                    // No performance data - use plan-based suggestions
                    const exercise = exerciseName.toLowerCase();

                    if (exercise.includes('ab') || exercise.includes('crunch') || exercise.includes('core')) {
                        progressionNotes.push(`<span class="text-info"><i class="fas fa-target me-1"></i>Focus on full range of motion and control</span>`);
                        progressionNotes.push(`<span class="text-success"><i class="fas fa-plus me-1"></i>Add weight when ${currentReps} reps become easy</span>`);
                    } else if (exercise.includes('press') || exercise.includes('squat') || exercise.includes('deadlift')) {
                        progressionNotes.push(`<span class="text-primary"><i class="fas fa-dumbbell me-1"></i>Main lift - track every session for best results</span>`);
                        progressionNotes.push(`<span class="text-warning"><i class="fas fa-chart-line me-1"></i>Increase by 2.5-5lbs when all reps completed</span>`);
                    } else if (exercise.includes('curl') || exercise.includes('raise') || exercise.includes('fly')) {
                        progressionNotes.push(`<span class="text-info"><i class="fas fa-slow-down me-1"></i>Focus on form over weight for isolation work</span>`);
                        progressionNotes.push(`<span class="text-success"><i class="fas fa-plus me-1"></i>Progress slowly: 2.5lbs every 2-3 weeks</span>`);
                    } else {
                        progressionNotes.push(`<span class="text-primary"><i class="fas fa-play me-1"></i>Start logging workouts to get personalized progression tips</span>`);
                        progressionNotes.push(`<span class="text-info"><i class="fas fa-target me-1"></i>Aim to complete all ${currentSets} sets of ${currentReps} reps</span>`);
                    }
                }

                // Default progression note if none generated
                if (progressionNotes.length === 0) {
                    progressionNotes.push(`<span class="text-muted"><i class="fas fa-info-circle me-1"></i>Continue with current programming</span>`);
                }

                resolve(progressionNotes);
            })
            .catch(error => {
                console.error('Error fetching exercise performance:', error);
                resolve([`<span class="text-muted"><i class="fas fa-exclamation-circle me-1"></i>Unable to load progression data</span>`]);
            });
    });
}

function getExercisePhilosophy(exerciseName) {
    const exercise = exerciseName.toLowerCase();

    // Midsection focus - red
    if (exercise.includes('ab') || exercise.includes('crunch') || exercise.includes('woodchop') ||
        exercise.includes('back extension') || exercise.includes('strap ab')) {
        return {
            purpose: "Midsection hypertrophy and core strength development",
            philosophy: "Core work treated as main lift per plan philosophy - aggressive progression for maximum development",
            colorClass: "danger"
        };
    }

    // Compound strength - blue
    if (exercise.includes('press') || exercise.includes('chest supported row') ||
        exercise.includes('glute drive') || exercise.includes('leg press') ||
        exercise.includes('assisted pull') || exercise.includes('assisted dip')) {
        return {
            purpose: "Compound strength and mass building",
            philosophy: "Primary movement for building overall strength and mass",
            colorClass: "primary"
        };
    }

    // Isolation work - warning
    if (exercise.includes('curl') || exercise.includes('raise') || exercise.includes('fly') ||
        exercise.includes('lateral') || exercise.includes('rear delt') || exercise.includes('front raise') ||
        exercise.includes('leg curl') || exercise.includes('leg extension') || exercise.includes('glute slide')) {
        return {
            purpose: "Targeted muscle isolation and hypertrophy",
            philosophy: "Isolation work for specific muscle development and joint health",
            colorClass: "warning"
        };
    }

    // Bodyweight - info
    if (exercise.includes('pushup') || exercise.includes('push up') || exercise.includes('hanging leg') ||
        exercise.includes('split squat') || exercise.includes('goblet')) {
        return {
            purpose: "Bodyweight strength and movement quality",
            philosophy: "Progressive bodyweight training for functional strength",
            colorClass: "info"
        };
    }

    // Default
    return {
        purpose: "General strength and hypertrophy development",
        philosophy: "Progressive training for overall fitness development",
        colorClass: "secondary"
    };
}

function toggleDayPhilosophy(day) {
    const collapseElement = document.getElementById(`philosophy-${day}`);
    const chevron = document.getElementById(`chevron-${day}`);

    if (collapseElement) {
        const bsCollapse = new bootstrap.Collapse(collapseElement, {
            toggle: true
        });

        // Toggle chevron direction
        collapseElement.addEventListener('shown.bs.collapse', function () {
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
        });

        collapseElement.addEventListener('hidden.bs.collapse', function () {
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
        });
    }
}

function extractPrioritiesFromPhilosophy(data) {
    if (!data.plan_context || !data.plan_context.plan_philosophy) return [];

    const philosophy = data.plan_context.plan_philosophy.toLowerCase();
    const priorities = [];

    // Extract priorities based on keywords and context
    if (philosophy.includes('midsection') || philosophy.includes('core')) {
        priorities.push({
            title: 'Midsection Development',
            description: 'Core strength and muscle development'
        });
    }

    if (philosophy.includes('compound') || philosophy.includes('strength')) {
        priorities.push({
            title: 'Compound Strength',
            description: 'Heavy compound movements for overall mass'
        });
    }

    if (philosophy.includes('isolation') || philosophy.includes('machine')) {
        priorities.push({
            title: 'Joint-Safe Isolation',
            description: 'Machine-based isolation for targeted growth'
        });
    }

    if (philosophy.includes('progression') || philosophy.includes('aggressive')) {
        priorities.push({
            title: 'Aggressive Progression',
            description: 'Consistent strength and size gains'
        });
    }

    return priorities;
}

function extractPrinciples(philosophy) {
    const principles = [];
    const text = philosophy.toLowerCase();

    if (text.includes('progressive')) principles.push('Progressive Overload');
    if (text.includes('compound')) principles.push('Compound Movement Focus');
    if (text.includes('safety') || text.includes('machine')) principles.push('Joint Safety Priority');
    if (text.includes('consistency')) principles.push('Consistent Training');
    if (text.includes('recovery')) principles.push('Recovery Emphasis');

    return principles.length > 0 ? principles : ['Structured Training Approach'];
}

async function processPriorityChange() {
    const input = document.getElementById('priorityInput').value.trim();
    if (!input) return;

    const suggestionsContainer = document.getElementById('modificationSuggestions');
    suggestionsContainer.style.display = 'block';
    suggestionsContainer.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Analyzing...</span>
            </div>
            <p class="mt-2">Analyzing your request and generating smart plan modifications...</p>
        </div>
    `;

    try {
        // Send comprehensive plan analysis request to Grok
        const response = await fetch('/chat_stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=COMPREHENSIVE_PLAN_MODIFICATION_REQUEST: ${input}`
        });

        if (!response.ok) throw new Error('Network response was not ok');

        const reader = response.body.getReader();
        let fullResponse = '';
        let suggestions = [];

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = new TextDecoder().decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.content) {
                            fullResponse += data.content;
                        }
                        if (data.done) {
                            // Parse the complete response for modifications
                            suggestions = parseModificationSuggestions(fullResponse);
                            displayModificationSuggestions(suggestions, input);
                        }
                    } catch (e) {
                        // Continue processing
                    }
                }
            }
        }

    } catch (error) {
        console.error('Error processing priority change:', error);
        suggestionsContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error processing your request. Please try again.
            </div>
        `;
    }
}

function parseModificationSuggestions(response) {
    const suggestions = [];
    const lines = response.split('\n');

    let currentSuggestion = null;

    for (const line of lines) {
        const trimmed = line.trim();

        // Look for modification patterns
        if (trimmed.includes('ADD:') || trimmed.includes('MODIFY:') || trimmed.includes('REPLACE:')) {
            if (currentSuggestion) suggestions.push(currentSuggestion);

            currentSuggestion = {
                type: trimmed.includes('ADD:') ? 'add' : trimmed.includes('MODIFY:') ? 'modify' : 'replace',
                exercise: '',
                details: '',
                reasoning: '',
                day: ''
            };
        }

        // Extract exercise details
        if (trimmed.includes('Exercise:')) {
            if (currentSuggestion) currentSuggestion.exercise = trimmed.replace('Exercise:', '').trim();
        }

        if (trimmed.includes('Day:')) {
            if (currentSuggestion) currentSuggestion.day = trimmed.replace('Day:', '').trim();
        }

        if (trimmed.includes('Reasoning:')) {
            if (currentSuggestion) currentSuggestion.reasoning = trimmed.replace('Reasoning:', '').trim();
        }
    }

    if (currentSuggestion) suggestions.push(currentSuggestion);

    return suggestions;
}

function displayModificationSuggestions(suggestions, originalRequest) {
    const container = document.getElementById('modificationSuggestions');

    if (suggestions.length === 0) {
        // Show general response if no specific modifications detected
        container.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="fas fa-lightbulb me-2"></i>AI Analysis Complete</h6>
                <p>Based on your request "${originalRequest}", here are my recommendations:</p>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="triggerDetailedAnalysis('${originalRequest}')">
                        <i class="fas fa-search-plus me-2"></i>Get Detailed Plan Analysis
                    </button>
                </div>
            </div>
        `;
        return;
    }

    let html = `
        <div class="alert alert-success">
            <h6><i class="fas fa-magic me-2"></i>Smart Modifications Suggested</h6>
            <p>Based on "${originalRequest}", here's what I recommend:</p>
        </div>
    `;

    suggestions.forEach((suggestion, index) => {
        const typeIcon = suggestion.type === 'add' ? 'fa-plus' : suggestion.type === 'modify' ? 'fa-edit' : 'fa-exchange-alt';
        const typeColor = suggestion.type === 'add' ? 'success' : suggestion.type === 'modify' ? 'warning' : 'info';

        html += `
            <div class="card mb-3 border-${typeColor}">
                <div class="card-header bg-${typeColor} text-white">
                    <h6 class="mb-0">
                        <i class="fas ${typeIcon} me-2"></i>
                        ${suggestion.type.charAt(0).toUpperCase() + suggestion.type.slice(1)}: ${suggestion.exercise}
                    </h6>
                </div>
                <div class="card-body">
                    ${suggestion.day ? `<p><strong>Day:</strong> ${suggestion.day}</p>` : ''}
                    ${suggestion.details ? `<p><strong>Details:</strong> ${suggestion.details}</p>` : ''}
                    ${suggestion.reasoning ? `<p><strong>Why:</strong> ${suggestion.reasoning}</p>` : ''}
                    <div class="mt-3">
                        <button class="btn btn-${typeColor} me-2" onclick="applyModification(${index}, ${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                            <i class="fas fa-check me-2"></i>Apply This Change
                        </button>
                        <button class="btn btn-outline-secondary" onclick="getMoreDetails(${index})">
                            <i class="fas fa-info me-2"></i>More Details
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function applyModification(index, suggestion) {
    try {
        const response = await fetch('/modify_plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: suggestion.type,
                exercise_name: suggestion.exercise,
                day: suggestion.day,
                sets: 3, // Default values - should be extracted from suggestion
                reps: '8-12',
                weight: 'bodyweight',
                reasoning: suggestion.reasoning
            })
        });

        const result = await response.json();

        if (result.success) {
            // Show success and refresh
            alert(' ' + result.message);
            location.reload();
        } else {
            alert(' Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error applying modification:', error);
        alert(' Error applying modification');
    }
}

async function triggerFullPlanReview() {
    window.location.href = '/chat?message=' + encodeURIComponent('FULL_PLAN_REVIEW_REQUEST: Please analyze my complete training plan and philosophy for potential improvements');
}

function openPriorityEditor() {
    // Pre-fill current priorities
    currentPriorities.forEach((priority, index) => {
        const input = document.getElementById(`priority${index + 1}`);
        if (input) input.value = priority.title;
    });

    new bootstrap.Modal(document.getElementById('priorityEditorModal')).show();
}

function openPhilosophyEditor() {
    const container = document.getElementById('corePhilosophy');
    const philosophyTextElement = document.getElementById('corePhilosophyText');

    if (container && philosophyTextElement) {
        let currentPhilosophyText = '';
        const philosophyContent = container.querySelector('p.lead');
        if (philosophyContent) {
            currentPhilosophyText = philosophyContent.textContent;
        }
        philosophyTextElement.value = currentPhilosophyText;
        new bootstrap.Modal(document.getElementById('philosophyEditorModal')).show();
    }
}

async function savePhilosophy() {
    const philosophyText = document.getElementById('corePhilosophyText').value.trim();
    if (!philosophyText) {
        alert('Please enter your core training philosophy.');
        return;
    }

    try {
        const response = await fetch('/update_philosophy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ philosophy: philosophyText })
        });

        const result = await response.json();

        if (result.success) {
            alert(' Core training philosophy updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('philosophyEditorModal')).hide();
            loadPhilosophyAndPriorities(); // Refresh the displayed philosophy
        } else {
            alert(' Error updating philosophy: ' + result.error);
        }
    } catch (error) {
        console.error('Error saving philosophy:', error);
        alert(' An unexpected error occurred.');
    }
}


function showQuickPriorityOptions() {
    new bootstrap.Modal(document.getElementById('quickPriorityModal')).show();
}

function quickPriorityChange(priorityText) {
    document.getElementById('priorityInput').value = priorityText;
    bootstrap.Modal.getInstance(document.getElementById('quickPriorityModal')).hide();
    processPriorityChange();
}

async function savePriorities() {
    const priorities = [
        document.getElementById('priority1').value,
        document.getElementById('priority2').value,
        document.getElementById('priority3').value,
        document.getElementById('priority4').value
    ].filter(p => p.trim());

    if (priorities.length === 0) {
        alert('Please enter at least one priority');
        return;
    }

    // Send to chat for processing
    const priorityText = priorities.map((p, i) => `Priority #${i+1}: ${p}`).join(', ');

    try {
        const response = await fetch('/chat_stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=Update my training priorities: ${priorityText}. Please analyze how this affects my current plan and suggest modifications.`
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('priorityEditorModal')).hide();
            alert(' Priorities updated! Check the chat for analysis and suggestions.');
            loadPhilosophyAndPriorities(); // Refresh
        }
    } catch (error) {
        console.error('Error saving priorities:', error);
        alert(' Error saving priorities');
    }
}

function refreshPhilosophy() {
    loadPhilosophyAndPriorities();
}

function showErrorState() {
    document.getElementById('corePhilosophy').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Error loading philosophy. Please try again.
        </div>
    `;
}
</script>
{% endblock %}