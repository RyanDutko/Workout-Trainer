
{% extends "base.html" %}

{% block title %}Plan Philosophy - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-brain me-2"></i>Plan Philosophy</h1>
    <div>
        <button id="refreshPhilosophyBtn" class="btn btn-outline-primary me-2">
            <i class="fas fa-sync me-2"></i>Refresh
        </button>
        <button id="debugBtn" class="btn btn-outline-secondary">
            <i class="fas fa-bug me-2"></i>Debug
        </button>
    </div>
</div>

<!-- AI Integration Alert -->
<div class="alert alert-info mb-4">
    <i class="fas fa-robot me-2"></i>
    <strong>AI Integration:</strong> Your training philosophy is automatically updated when you discuss changes with Grok in chat. Just tell Grok about modifications to your approach and this page will reflect those updates!
</div>

<!-- Overall Philosophy Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Overall Training Philosophy</h5>
            </div>
            <div class="card-body" id="overallPhilosophy">
                <!-- Will be populated via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Plan Priorities Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Plan Priorities</h5>
            </div>
            <div class="card-body" id="planPriorities">
                <!-- Will be populated via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Daily Breakdown Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Daily Training Breakdown</h5>
                <button class="btn btn-outline-light btn-sm" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#exerciseLegend" aria-expanded="false">
                    <i class="fas fa-info-circle me-1"></i>Color Guide
                </button>
            </div>
            <div class="card-body">
                <!-- Exercise Category Legend -->
                <div class="collapse mb-3" id="exerciseLegend">
                    <div class="alert alert-light border">
                        <h6><i class="fas fa-palette me-2"></i>Exercise Category Colors</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="border-start border-danger border-3 pe-2 me-2" style="height: 20px;"></div>
                                    <strong class="text-danger">Core/Abs</strong> - Midsection focus for loose skin
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="border-start border-primary border-3 pe-2 me-2" style="height: 20px;"></div>
                                    <strong class="text-primary">Compound</strong> - Main strength movements
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="border-start border-success border-3 pe-2 me-2" style="height: 20px;"></div>
                                    <strong class="text-success">Machine Isolation</strong> - Joint-safe lower body
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="border-start border-info border-3 pe-2 me-2" style="height: 20px;"></div>
                                    <strong class="text-info">Upper Isolation</strong> - Arms, shoulders, chest detail
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="border-start border-secondary border-3 pe-2 me-2" style="height: 20px;"></div>
                                    <strong class="text-secondary">General</strong> - Other hypertrophy work
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion" id="dailyPhilosophyAccordion">
                    <!-- Will be populated via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Modal -->
<div class="modal fade" id="debugModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Philosophy Debug Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="debugOutput" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="restorePhilosophy()">Restore Backup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPhilosophy = null;
let currentPlan = null;

// Load philosophy on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPhilosophy();
    startPhilosophyWatcher();
});

// Button handlers
document.getElementById('refreshPhilosophyBtn').addEventListener('click', loadPhilosophy);
document.getElementById('debugBtn').addEventListener('click', showDebugInfo);

async function loadPhilosophy() {
    try {
        showLoadingState();

        // Load both context and weekly plan
        const [contextResponse, planResponse] = await Promise.all([
            fetch('/get_stored_context'),
            fetch('/api/weekly_plan')
        ]);

        const contextData = await contextResponse.json();
        const planData = await planResponse.json();

        // Set global variables for the watcher
        currentPhilosophy = contextData;
        currentPlan = planData;

        displayOverallPhilosophy(contextData);
        displayPlanPriorities(contextData);
        displayDailyBreakdown(contextData, planData);

        // Show success message if this was triggered by an update
        if (window.philosophyJustUpdated) {
            showUpdateNotification();
            window.philosophyJustUpdated = false;
        }

    } catch (error) {
        console.error('Error loading philosophy:', error);
        showErrorState();
    }
}

function showLoadingState() {
    const loadingHtml = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your training philosophy...</p>
        </div>
    `;
    
    document.getElementById('overallPhilosophy').innerHTML = loadingHtml;
    document.getElementById('planPriorities').innerHTML = loadingHtml;
    document.getElementById('dailyPhilosophyAccordion').innerHTML = loadingHtml;
}

function showErrorState() {
    const errorHtml = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Error loading philosophy. Please try again.
        </div>
    `;
    
    document.getElementById('overallPhilosophy').innerHTML = errorHtml;
    document.getElementById('planPriorities').innerHTML = errorHtml;
}

function displayOverallPhilosophy(data) {
    const container = document.getElementById('overallPhilosophy');

    if (!data.plan_context) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No philosophy found.</strong> Start chatting with Grok about your training approach to automatically populate your philosophy!
            </div>
        `;
        return;
    }

    const ctx = data.plan_context;
    let html = '<div class="row">';

    if (ctx.plan_philosophy) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-brain me-2 text-primary"></i>Core Philosophy</h6>
                <p class="border-start border-primary ps-3">${ctx.plan_philosophy}</p>
            </div>
        `;
    }

    if (ctx.weekly_structure) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-calendar me-2 text-success"></i>Weekly Structure</h6>
                <p class="border-start border-success ps-3">${ctx.weekly_structure}</p>
            </div>
        `;
    }

    if (ctx.progression_strategy) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-chart-line me-2 text-info"></i>Progression Strategy</h6>
                <p class="border-start border-info ps-3">${ctx.progression_strategy}</p>
            </div>
        `;
    }

    if (ctx.special_considerations) {
        html += `
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-shield-alt me-2 text-warning"></i>Special Considerations</h6>
                <p class="border-start border-warning ps-3">${ctx.special_considerations}</p>
            </div>
        `;
    }

    html += '</div>';

    if (ctx.creation_reasoning) {
        html += `
            <div class="mt-3">
                <h6><i class="fas fa-lightbulb me-2 text-secondary"></i>Reasoning</h6>
                <p class="text-muted border-start border-secondary ps-3">${ctx.creation_reasoning}</p>
            </div>
        `;
    }

    container.innerHTML = html;
}

function displayPlanPriorities(data) {
    const container = document.getElementById('planPriorities');
    
    if (!data.plan_context || !data.plan_context.plan_philosophy) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Plan priorities will be extracted from your philosophy automatically. Chat with Grok about your training priorities!
            </div>
        `;
        return;
    }

    // Extract priorities from philosophy text
    const philosophy = data.plan_context.plan_philosophy.toLowerCase();
    const priorities = [];

    // Look for priority keywords
    if (philosophy.includes('midsection') || philosophy.includes('core') || philosophy.includes('loose skin')) {
        priorities.push({
            icon: 'fas fa-bullseye',
            title: 'Midsection Focus',
            description: 'Aggressive core work for loose skin tightening'
        });
    }

    if (philosophy.includes('compound') || philosophy.includes('strength')) {
        priorities.push({
            icon: 'fas fa-dumbbell',
            title: 'Compound Strength',
            description: 'Heavy compound movements for overall mass'
        });
    }

    if (philosophy.includes('machine') || philosophy.includes('safety') || philosophy.includes('isolation')) {
        priorities.push({
            icon: 'fas fa-shield-alt',
            title: 'Joint Safety',
            description: 'Machine-based isolation for injury prevention'
        });
    }

    if (philosophy.includes('aggressive') || philosophy.includes('progression')) {
        priorities.push({
            icon: 'fas fa-chart-line',
            title: 'Aggressive Progression',
            description: 'Fast progression on key exercises'
        });
    }

    if (priorities.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No specific priorities detected yet. Chat with Grok about your training priorities to see them here!
            </div>
        `;
        return;
    }

    let html = '<div class="row">';
    priorities.forEach(priority => {
        html += `
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-body text-center">
                        <i class="${priority.icon} fa-2x text-success mb-2"></i>
                        <h6 class="card-title">${priority.title}</h6>
                        <p class="card-text text-muted small">${priority.description}</p>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function displayDailyBreakdown(contextData, planData) {
    const container = document.getElementById('dailyPhilosophyAccordion');
    
    if (!planData || Object.keys(planData).length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                No weekly plan found. Set up your weekly plan first!
            </div>
        `;
        return;
    }

    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    let html = '';

    days.forEach((day, index) => {
        if (planData[day] && planData[day].length > 0) {
            const exercises = planData[day];
            const dayTitle = day.charAt(0).toUpperCase() + day.slice(1);
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${day}">
                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapse${day}">
                            <strong>${dayTitle}</strong>
                            <span class="badge bg-primary ms-2">${exercises.length} exercises</span>
                        </button>
                    </h2>
                    <div id="collapse${day}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                         data-bs-parent="#dailyPhilosophyAccordion">
                        <div class="accordion-body">
                            <div class="row">
            `;

            exercises.forEach(exercise => {
                const exerciseType = getExerciseType(exercise.exercise);
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-start border-${exerciseType.color} border-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="${exerciseType.icon} me-2"></i>
                                    ${exercise.exercise}
                                </h6>
                                <p class="mb-1"><strong>Volume:</strong> ${exercise.sets}x${exercise.reps} @ ${exercise.weight}</p>
                                <p class="mb-1"><strong>Purpose:</strong> ${exerciseType.purpose}</p>
                                <p class="mb-0"><strong>Progression:</strong> ${exerciseType.progression}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });

    container.innerHTML = html;
}

function getExerciseType(exerciseName) {
    const exercise = exerciseName.toLowerCase();
    
    if (exercise.includes('ab') || exercise.includes('crunch') || exercise.includes('core') || exercise.includes('woodchop')) {
        return {
            icon: 'fas fa-bullseye',
            color: 'danger',
            purpose: 'Midsection hypertrophy for loose skin tightening',
            progression: 'Aggressive - treat as main lift'
        };
    } else if (exercise.includes('press') || exercise.includes('squat') || exercise.includes('deadlift') || exercise.includes('row')) {
        return {
            icon: 'fas fa-dumbbell',
            color: 'primary',
            purpose: 'Compound strength and mass building',
            progression: 'Aggressive - main movement focus'
        };
    } else if (exercise.includes('curl') || exercise.includes('extension') || exercise.includes('raise') || exercise.includes('fly')) {
        return {
            icon: 'fas fa-target',
            color: 'info',
            purpose: 'Isolation hypertrophy work',
            progression: 'Moderate - steady increases'
        };
    } else if (exercise.includes('leg') && (exercise.includes('curl') || exercise.includes('extension'))) {
        return {
            icon: 'fas fa-shield-alt',
            color: 'success',
            purpose: 'Machine-based isolation for joint safety',
            progression: 'Aggressive - safe progression'
        };
    } else {
        return {
            icon: 'fas fa-weight-hanging',
            color: 'secondary',
            purpose: 'General hypertrophy and strength',
            progression: 'Normal progression rate'
        };
    }
}

// Auto-refresh philosophy when updates are detected
function startPhilosophyWatcher() {
    setInterval(async () => {
        try {
            const response = await fetch('/get_stored_context');
            if (!response.ok) return;
            
            const newData = await response.json();
            
            if (currentPhilosophy && currentPhilosophy.plan_context && 
                newData && newData.plan_context) {
                
                if (currentPhilosophy.plan_context.updated_date !== newData.plan_context.updated_date) {
                    console.log('🧠 Philosophy update detected, refreshing...');
                    window.philosophyJustUpdated = true;
                    loadPhilosophy();
                }
            }
        } catch (error) {
            // Silently handle errors
        }
    }, 30000);
}

function showUpdateNotification() {
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
    notification.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        <strong>Philosophy Updated!</strong> Your training philosophy has been updated successfully.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

async function showDebugInfo() {
    try {
        const response = await fetch('/debug_plan_context');
        const debugData = await response.json();
        
        document.getElementById('debugOutput').textContent = JSON.stringify(debugData, null, 2);
        new bootstrap.Modal(document.getElementById('debugModal')).show();
    } catch (error) {
        document.getElementById('debugOutput').textContent = 'Error loading debug info: ' + error.message;
        new bootstrap.Modal(document.getElementById('debugModal')).show();
    }
}

async function restorePhilosophy() {
    try {
        const response = await fetch('/restore_philosophy', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert('Philosophy restored successfully!');
            loadPhilosophy();
            bootstrap.Modal.getInstance(document.getElementById('debugModal')).hide();
        } else {
            alert('Error restoring philosophy: ' + result.error);
        }
    } catch (error) {
        alert('Error restoring philosophy: ' + error.message);
    }
}
</script>
{% endblock %}
