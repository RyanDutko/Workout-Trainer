{% extends "base.html" %}

{% block title %}Weekly Plan - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2"><i class="fas fa-calendar me-2"></i>Weekly Plan</h1>
    <button class="btn btn-primary btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#addExerciseModal">
        <i class="fas fa-plus me-2"></i>Add Exercise
    </button>
</div>

<div class="row g-4">
    {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
    {% for day in days %}
        <div class="col-md-6 col-xl-4">
            <div class="card h-100 shadow-sm border-0" style="border-radius: 16px; overflow: hidden;">
                <div class="card-header text-white position-relative" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1.25rem;">
                    <h5 class="mb-0 fw-bold">{{ day.title() }}</h5>
                    {% if day in plan_by_day %}
                        <span class="badge bg-light text-dark position-absolute top-0 end-0 m-3">
                            {{ plan_by_day[day]|length }} exercises
                        </span>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if day in plan_by_day %}
                        {% for exercise in plan_by_day[day] %}
                            <div class="exercise-item border-bottom p-4 position-relative" style="transition: all 0.2s ease;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="flex-grow-1 me-3">
                                        <h6 class="fw-bold mb-2 text-dark">
                                            {{ (exercise.exercise or exercise.exercise_name or exercise.label or 'Block')|title }}
                                            {% if exercise.newly_added %}
                                                <span class="badge bg-success ms-2" style="font-size: 0.65rem;">New!</span>
                                            {% endif %}
                                        </h6>
                                        <div class="exercise-info">
                            {% if exercise.block_type in ['circuit', 'rounds'] %}
                              {# figure out rounds #}
                              {% set rounds = 1 %}
                              {% if exercise.meta is mapping and 'rounds' in exercise.meta %}
                                {% set rounds = exercise.meta.rounds %}
                              {% elif exercise.sets %}
                                {% set rounds = exercise.sets %}
                              {% endif %}
                              <div class="plan-meta">
                                {{ rounds }} rounds
                                {% if exercise.members %}
                                  â€¢
                                  {# list members like: Slow curls (10 @ 20 lbs), Fast curls (15 @ 15 lbs) #}
                                  {% for m in exercise.members %}
                                    {% set exname = m.exercise or m.name or 'Movement' %}
                                    {% if m.reps and m.weight %}
                                      {{ exname }} ({{ m.reps }} @ {{ m.weight }})
                                    {% elif m.reps %}
                                      {{ exname }} ({{ m.reps }} reps)
                                    {% elif m.weight %}
                                      {{ exname }} ({{ m.weight }})
                                    {% else %}
                                      {{ exname }}
                                    {% endif %}
                                    {% if not loop.last %}, {% endif %}
                                  {% endfor %}
                                {% endif %}
                              </div>
                              <div class="plan-type">Complex block</div>
                            {% else %}
                              <div class="plan-meta">
                                {{ exercise.sets }} Ã— {{ exercise.reps }}{% if exercise.weight %} @ {{ exercise.weight }}{% endif %}
                              </div>
                              <div class="plan-type">Single</div>
                            {% endif %}
                            {% if exercise.notes %}
                                <small class="text-muted d-block">{{ exercise.notes }}</small>
                            {% endif %}
                            {% if exercise.progression_notes %}
                                <small class="text-info d-block">ðŸ“ˆ {{ exercise.progression_notes }}</small>
                            {% endif %}
                        </div>
                                    </div>
                                    <span class="badge bg-secondary bg-opacity-20 text-secondary fw-bold" style="font-size: 0.9rem; min-width: 30px;">
                                        {{ exercise.order }}
                                    </span>
                                </div>

                                <!-- Action Buttons - Now sleek and organized -->
                                <div class="exercise-actions">
                                    <div class="btn-toolbar justify-content-between" role="toolbar">
                                        <!-- Move buttons -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="moveExercise('{{ day }}', '{{ exercise.exercise }}', 'up')"
                                                    style="border-radius: 8px 0 0 8px;">
                                                <i class="fas fa-chevron-up"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="moveExercise('{{ day }}', '{{ exercise.exercise }}', 'down')"
                                                    style="border-radius: 0 8px 8px 0;">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>

                                        <!-- Edit/Delete buttons -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary btn-sm edit-btn"
                                                    data-id="{{ exercise.id }}"
                                                    data-day="{{ day }}"
                                                    data-exercise="{{ exercise.exercise }}"
                                                    data-sets="{{ exercise.sets }}"
                                                    data-reps="{{ exercise.reps }}"
                                                    data-weight="{{ exercise.weight }}"
                                                    data-notes="{{ exercise.notes }}"
                                                    data-progression-notes="{{ exercise.progression_notes or '' }}"
                                                    style="border-radius: 8px 0 0 8px;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="deleteExercise('{{ day }}', '{{ exercise.exercise }}')"
                                                    style="border-radius: 0 8px 8px 0;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No exercises planned</p>
                            <small class="text-muted">Add your first exercise above</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Add Exercise Modal -->
<div class="modal fade" id="addExerciseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="modal-title fw-bold">Add Exercise to Weekly Plan</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_to_plan') }}">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="day" class="form-label fw-semibold">Day</label>
                            <select class="form-select form-select-lg" id="day" name="day" required style="border-radius: 12px;">
                                <option value="">Select day...</option>
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="exercise" class="form-label fw-semibold">Exercise Name</label>
                            <input type="text" class="form-control form-control-lg" id="exercise" name="exercise" 
                                   placeholder="e.g., bench press, squats" required style="border-radius: 12px;">
                        </div>

                        <div class="col-md-4">
                            <label for="sets" class="form-label fw-semibold">Sets</label>
                            <input type="number" class="form-control form-control-lg" id="sets" name="sets" 
                                   min="1" max="10" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label for="reps" class="form-label fw-semibold">Reps</label>
                            <input type="text" class="form-control form-control-lg" id="reps" name="reps" 
                                   placeholder="8-12 or 10" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label for="weight" class="form-label fw-semibold">Weight</label>
                            <input type="text" class="form-control form-control-lg" id="weight" name="weight" 
                                   placeholder="200lbs" required style="border-radius: 12px;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-secondary btn-lg px-4" data-bs-dismiss="modal" style="border-radius: 12px;">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-lg px-4" style="border-radius: 12px;">Add Exercise</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Exercise Modal -->
<div class="modal fade" id="editExerciseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0;">
                <h5 class="modal-title fw-bold">Edit Exercise</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editExerciseForm">
                <div class="modal-body p-4">
                    <input type="hidden" id="editId" name="id">
                    <input type="hidden" id="editDay" name="day">

                    <div class="row g-3">
                        <div class="col-12">
                            <label for="editExerciseName" class="form-label fw-semibold">Exercise Name</label>
                            <input type="text" class="form-control form-control-lg" id="editExerciseName" name="exercise_name" required style="border-radius: 12px;">
                        </div>

                        <div class="col-md-4">
                            <label for="editSets" class="form-label fw-semibold">Sets</label>
                            <input type="number" class="form-control form-control-lg" id="editSets" name="sets" 
                                   min="1" max="10" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label for="editReps" class="form-label fw-semibold">Reps</label>
                            <input type="text" class="form-control form-control-lg" id="editReps" name="reps" 
                                   placeholder="8-12 or 10" required style="border-radius: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label for="editWeight" class="form-label fw-semibold">Weight</label>
                            <input type="text" class="form-control form-control-lg" id="editWeight" name="weight" 
                                   placeholder="200lbs" required style="border-radius: 12px;">
                        </div>

                        <div class="col-12">
                            <label for="editNotes" class="form-label fw-semibold">Notes (optional)</label>
                            <textarea class="form-control" id="editNotes" name="notes" rows="2" 
                                      placeholder="Any additional notes..." style="border-radius: 12px;"></textarea>
                        </div>

                        <div class="col-12">
                            <label for="editProgressionNotes" class="form-label fw-semibold">Progression Notes (optional)</label>
                            <textarea class="form-control" id="editProgressionNotes" name="progression_notes" rows="2" 
                                      placeholder="e.g., Increase weight by 5lbs next week" style="border-radius: 12px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-secondary btn-lg px-4" data-bs-dismiss="modal" style="border-radius: 12px;">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-lg px-4" style="border-radius: 12px;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.exercise-item:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.exercise-actions {
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

.exercise-item:hover .exercise-actions {
    opacity: 1;
}

.btn-group .btn {
    border-width: 1px;
    transition: all 0.2s ease;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.badge {
    border-radius: 8px;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}
</style>

<script>
function moveExercise(day, exercise, direction) {
    fetch('/reorder_exercise', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            day: day,
            exercise: exercise,
            direction: direction
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error reordering exercise: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error reordering exercise');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.edit-btn');
    if (editButtons && editButtons.length > 0) {
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const day = this.getAttribute('data-day');
                const exercise = this.getAttribute('data-exercise');
                const sets = this.getAttribute('data-sets');
                const reps = this.getAttribute('data-reps');
                const weight = this.getAttribute('data-weight');
                const notes = this.getAttribute('data-notes') || '';
                const progressionNotes = this.getAttribute('data-progression-notes') || '';

                const editId = document.getElementById('editId');
                const editDay = document.getElementById('editDay');
                const editExerciseName = document.getElementById('editExerciseName');
                const editSets = document.getElementById('editSets');
                const editReps = document.getElementById('editReps');
                const editWeight = document.getElementById('editWeight');
                const editNotes = document.getElementById('editNotes');
                const editProgressionNotes = document.getElementById('editProgressionNotes');

                if (editId && editDay && editExerciseName && editSets && editReps && editWeight && editNotes) {
                    editId.value = id;
                    editDay.value = day;
                    editExerciseName.value = exercise;
                    editSets.value = sets;
                    editReps.value = reps;
                    editWeight.value = weight;
                    editNotes.value = notes;
                    if (editProgressionNotes) editProgressionNotes.value = progressionNotes;

                    new bootstrap.Modal(document.getElementById('editExerciseModal')).show();
                } else {
                    console.error('Edit form elements not found');
                }
            });
        });
    }
});

function deleteExercise(day, exercise) {
    if (confirm(`Are you sure you want to delete "${exercise}" from ${day}?`)) {
        fetch('/delete_exercise', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                day: day,
                exercise: exercise
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting exercise: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting exercise');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('editExerciseForm');
    if (editForm && editForm.addEventListener) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const weightValue = formData.get('weight');

            if (!weightValue || weightValue.trim() === '') {
                alert('Weight field cannot be empty');
                return;
            }

            const data = {
                id: parseInt(formData.get('id')),
                day: formData.get('day'),
                exercise: formData.get('exercise_name'),
                sets: parseInt(formData.get('sets')),
                reps: formData.get('reps'),
                weight: weightValue.trim(),
                notes: formData.get('notes') || '',
                progression_notes: formData.get('progression_notes') || ''
            };

            fetch('/edit_exercise', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = document.getElementById('editExerciseModal');
                    if (modal && bootstrap.Modal.getInstance(modal)) {
                        bootstrap.Modal.getInstance(modal).hide();
                    }
                    location.reload();
                } else {
                    alert('Error editing exercise: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error editing exercise');
            });
        });
    } else {
        console.warn('Edit exercise form not found');
    }
});
</script>
{% endblock %}