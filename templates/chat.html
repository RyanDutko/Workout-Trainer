{% extends "base.html" %}

{% block title %}AI Chat - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-comments me-2"></i>Chat with AI Trainer</h1>
</div>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card" style="height: 600px;">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-robot me-2"></i>Personal Trainer AI</h6>
            </div>
            <div class="card-body d-flex flex-column">
                <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3" style="max-height: 450px;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ask me anything about your workouts, nutrition, progression, or fitness goals!
                        <br><small class="text-muted mt-1">✨ I can now auto-detect and execute workout logging from your conversations!</small>
                    </div>
                </div>

                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" id="messageInput" class="form-control" 
                           placeholder="Ask about workouts, progression, nutrition..." required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Questions -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-question-circle me-2"></i>Quick Questions</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-primary btn-sm" onclick="requestFullPlanReview()">
                        <i class="fas fa-clipboard-list me-1"></i>Full Plan Review
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearConversation()">
                        <i class="fas fa-trash me-1"></i>Clear Chat
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="askDaySpecificQuestion('show me my Tuesday workout')">
                        <i class="fas fa-calendar-day me-1"></i>My Tuesday
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="askDaySpecificQuestion('show me what I did on Monday')">
                        <i class="fas fa-calendar-day me-1"></i>My Monday
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('How should I progress my bench press?')">
                        Bench Press Progression
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('What should I eat after my workout?')">
                        Post-Workout Nutrition
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('I\'m feeling sore, should I still workout?')">
                        Training with Soreness
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('How do I break through a plateau?')">
                        Breaking Plateaus
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const chatMessages = document.getElementById('chatMessages');
let chatHistory = [];
let conversationHistory = '';

// Load conversation from localStorage on page load
window.addEventListener('load', function() {
    loadConversationFromStorage();
});

// Auto-save input as user types
messageInput.addEventListener('input', function() {
    const existing = localStorage.getItem('aiChatConversation');
    
    if (existing) {
        // Update existing conversation data
        try {
            const data = JSON.parse(existing);
            data.currentInput = messageInput.value;
            data.timestamp = Date.now();
            localStorage.setItem('aiChatConversation', JSON.stringify(data));
        } catch (e) {
            // If parsing fails, create new data
            const conversationData = {
                messages: chatMessages.innerHTML,
                history: conversationHistory,
                currentInput: messageInput.value,
                timestamp: Date.now()
            };
            localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
        }
    } else {
        // Create new conversation data just for the input
        const conversationData = {
            messages: chatMessages.innerHTML,
            history: conversationHistory,
            currentInput: messageInput.value,
            timestamp: Date.now()
        };
        localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
    }
});

// Save conversation to localStorage
function saveConversationToStorage() {
    const conversationData = {
        messages: chatMessages.innerHTML,
        history: conversationHistory,
        currentInput: messageInput.value,
        timestamp: Date.now()
    };
    localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
}

// Load conversation from localStorage
function loadConversationFromStorage() {
    const saved = localStorage.getItem('aiChatConversation');
    if (saved) {
        try {
            const conversationData = JSON.parse(saved);
            
            // Check if conversation is less than 2 hours old
            const twoHoursAgo = Date.now() - (2 * 60 * 60 * 1000);
            if (conversationData.timestamp > twoHoursAgo) {
                chatMessages.innerHTML = conversationData.messages;
                conversationHistory = conversationData.history || '';
                messageInput.value = conversationData.currentInput || '';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show restore notice
                const restoreNotice = document.createElement('div');
                restoreNotice.className = 'alert alert-info alert-dismissible fade show';
                restoreNotice.innerHTML = `
                    <i class="fas fa-history me-2"></i>
                    <strong>Conversation restored!</strong> Your chat history has been recovered.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="clearConversation()">
                        Start Fresh
                    </button>
                `;
                chatMessages.insertBefore(restoreNotice, chatMessages.firstChild);
            }
        } catch (e) {
            console.log('Error loading conversation:', e);
        }
    }
}

// Clear conversation storage
function clearConversation() {
    localStorage.removeItem('aiChatConversation');
    chatMessages.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Ask me anything about your workouts, nutrition, progression, or fitness goals!
            <br><small class="text-muted mt-1">✨ I can now auto-detect and execute workout logging from your conversations!</small>
        </div>
    `;
    conversationHistory = '';
    messageInput.value = '';
}

// Smart context management - limit context for day-specific queries
function getSmartContext(currentMessage) {
    const daySpecificTerms = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 'show me what i did', 'my workout'];
    const isDaySpecific = daySpecificTerms.some(term => currentMessage.toLowerCase().includes(term));
    
    if (isDaySpecific) {
        // For day-specific queries, only use last 2 exchanges to avoid confusion
        const messages = conversationHistory.split('\n\n');
        const recentMessages = messages.slice(-4).join('\n\n'); // Last 2 user-AI exchanges
        return recentMessages;
    }
    
    // For other queries, limit to last 1000 chars to prevent overwhelming context
    return conversationHistory.slice(-1000);
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, 'user');
    messageInput.value = '';

    // Update conversation history
    conversationHistory += `User: ${message}\n\n`;
    
    // Save to localStorage
    saveConversationToStorage();

    // Create streaming AI message container
    const aiMessageId = addStreamingMessage();

    // Use smart context management for better day-specific queries
    const smartContext = getSmartContext(message);
    
    // Send to AI with streaming
    fetch('/chat_stream', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'message=' + encodeURIComponent(message) + '&conversation_history=' + encodeURIComponent(smartContext)
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let aiResponse = '';

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Add AI response to conversation history
                    conversationHistory += `Grok: ${aiResponse}\n\n`;
                    finalizeStreamingMessage(aiMessageId);
                    
                    // Save conversation to localStorage
                    saveConversationToStorage();
                    return;
                }

                // Accumulate chunks in buffer
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');

                // Keep the last incomplete line in buffer
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.trim() && line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr && jsonStr !== '') {
                                const data = JSON.parse(jsonStr);
                                if (data.content) {
                                    aiResponse += data.content;
                                    appendToStreamingMessage(aiMessageId, data.content);
                                } else if (data.error) {
                                    updateStreamingMessage(aiMessageId, 'Sorry, I encountered an error. Please try again.');
                                    finalizeStreamingMessage(aiMessageId);
                                    return;
                                } else if (data.done) {
                                    finalizeStreamingMessage(aiMessageId);
                                    return;
                                }
                            }
                        } catch (e) {
                            console.log('Skipping malformed chunk:', line, 'Error:', e.message);
                        }
                    }
                }

                readStream();
            }).catch(error => {
                console.error('Stream reading error:', error);
                updateStreamingMessage(aiMessageId, 'Connection error occurred.');
                finalizeStreamingMessage(aiMessageId);
            });
        }

        readStream();
    })
    .catch(error => {
        updateStreamingMessage(aiMessageId, 'Sorry, I encountered an error. Please try again.');
        finalizeStreamingMessage(aiMessageId);
        console.error('Error:', error);
    });
});

function addMessage(message, type) {
    const messageDiv = document.createElement('div');
    let alertClass, icon;
    
    if (type === 'user') {
        alertClass = 'alert-primary';
        icon = 'fas fa-user';
    } else if (type === 'system') {
        alertClass = 'alert-info';
        icon = 'fas fa-cog';
    } else {
        alertClass = 'alert-success';
        icon = 'fas fa-robot';
    }
    
    messageDiv.className = `alert ${alertClass} d-flex align-items-start`;
    messageDiv.innerHTML = `
        <i class="${icon} me-2 mt-1"></i>
        <div>${message.replace(/\n/g, '<br>')}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addStreamingMessage() {
    const messageDiv = document.createElement('div');
    const messageId = 'streaming-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = 'alert alert-success d-flex align-items-start streaming-message';

    messageDiv.innerHTML = `
        <i class="fas fa-robot me-2 mt-1"></i>
        <div class="streaming-content">
            <span class="typing-cursor">▊</span>
        </div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return messageId;
}

function appendToStreamingMessage(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content');
        const cursor = contentDiv.querySelector('.typing-cursor');

        // Insert content before cursor
        const textNode = document.createTextNode(content);
        contentDiv.insertBefore(textNode, cursor);

        // Auto-scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function updateStreamingMessage(messageId, fullContent) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content');
        contentDiv.innerHTML = fullContent.replace(/\n/g, '<br>');
    }
}

function finalizeStreamingMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const cursor = messageDiv.querySelector('.typing-cursor');
        if (cursor) {
            cursor.remove();
        }
        messageDiv.classList.remove('streaming-message');
        
        // Check if this message contains plan modification keywords
        const messageText = messageDiv.textContent.toLowerCase();
        if ((messageText.includes('add') || messageText.includes('great choice')) && 
            (messageText.includes('plan') || messageText.includes('monday')) && 
            !messageText.includes('done!')) {
            // This looks like a plan modification response - add confirmation UI
            setTimeout(() => addPlanModificationConfirmation(messageDiv), 500);
        }
    }
}

function addPlanModificationConfirmation(messageDiv) {
    const messageText = messageDiv.textContent;
    
    // Detect glute drive addition to Monday specifically
    if (messageText.toLowerCase().includes('glute drive') && messageText.toLowerCase().includes('monday')) {
        const confirmationDiv = document.createElement('div');
        confirmationDiv.className = 'alert alert-warning mt-2 p-3';
        confirmationDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong><i class="fas fa-plus-circle me-2"></i>Plan Modification Proposal</strong>
                    <br><small class="text-muted">Add "glute drive" to Monday - 3x12@90lbs</small>
                </div>
                <div>
                    <button class="btn btn-success btn-sm me-2" onclick="confirmPlanChangeWithFeedback('glute drive', 'monday', 3, '12', '90lbs', this)">
                        <i class="fas fa-check me-1"></i>Add to Plan
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="this.parentElement.parentElement.parentElement.remove()">
                        <i class="fas fa-times me-1"></i>Dismiss
                    </button>
                </div>
            </div>
        `;
        
        messageDiv.appendChild(confirmationDiv);
    } else {
        // Try to extract exercise details from other AI responses (fallback)
        const exerciseMatch = messageText.match(/(\w+[\s\w]*(?:extension|curl|press|raise|row|drive))/i);
        const setsMatch = messageText.match(/(\d+)\s*(?:sets?|x)/i);
        const repsMatch = messageText.match(/(\d+(?:-\d+)?)\s*reps?/i);
        const weightMatch = messageText.match(/(\d+)\s*(?:lb|pound)/i);
        const dayMatch = messageText.match(/(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i);
        
        if (exerciseMatch && dayMatch) {
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'alert alert-warning mt-2 p-3';
            confirmationDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-plus-circle me-2"></i>Plan Modification Proposal</strong>
                        <br><small class="text-muted">Add "${exerciseMatch[1]}" to ${dayMatch[1]}${setsMatch ? ` - ${setsMatch[1]}x${repsMatch ? repsMatch[1] : '8-12'}` : ''}${weightMatch ? `@${weightMatch[1]}lbs` : ''}</small>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="confirmPlanChangeWithFeedback('${exerciseMatch[1]}', '${dayMatch[1].toLowerCase()}', ${setsMatch ? setsMatch[1] : 3}, '${repsMatch ? repsMatch[1] : '8-12'}', '${weightMatch ? weightMatch[1] + 'lbs' : 'bodyweight'}', this)">
                            <i class="fas fa-check me-1"></i>Add to Plan
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times me-1"></i>Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            messageDiv.appendChild(confirmationDiv);
        }
    }
}

function confirmPlanChange(exercise, day, sets, reps, weight) {
    // Create the plan change
    fetch('/modify_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'add',
            day: day,
            exercise_name: exercise,
            sets: sets,
            reps: reps,
            weight: weight,
            reasoning: 'Added via AI chat confirmation'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            addMessage(`✅ ${data.message}! Check your weekly plan to see the update.`, 'system');
            // Remove the confirmation UI
            document.querySelector('.alert-warning').remove();
        } else {
            addMessage(`❌ Error adding exercise: ${data.error}`, 'system');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessage('❌ Error confirming plan change', 'system');
    });
}

function confirmPlanChangeWithFeedback(exercise, day, sets, reps, weight, buttonElement) {
    // Show loading state
    const originalButton = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
    buttonElement.disabled = true;
    
    // Create the plan change
    fetch('/modify_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'add',
            day: day,
            exercise_name: exercise,
            sets: sets,
            reps: reps,
            weight: weight,
            reasoning: 'Added via AI chat confirmation'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace the confirmation UI with success message
            const confirmationDiv = buttonElement.closest('.alert-warning');
            confirmationDiv.className = 'alert alert-success mt-2 p-3';
            confirmationDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    <div>
                        <strong>Success!</strong> Added ${exercise} to your ${day.charAt(0).toUpperCase() + day.slice(1)} workout.
                        <br><small class="text-muted">Check your Weekly Plan tab to see the update.</small>
                    </div>
                </div>
            `;
            
            // Auto-remove success message after 5 seconds
            setTimeout(() => {
                if (confirmationDiv && confirmationDiv.parentNode) {
                    confirmationDiv.remove();
                }
            }, 5000);
        } else {
            // Show error and restore button
            buttonElement.innerHTML = originalButton;
            buttonElement.disabled = false;
            addMessage(`❌ Error adding exercise: ${data.error}`, 'system');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        buttonElement.innerHTML = originalButton;
        buttonElement.disabled = false;
        addMessage('❌ Error confirming plan change', 'system');
    });
}

function askQuestion(question) {
    messageInput.value = question;
    chatForm.dispatchEvent(new Event('submit'));
}

function askDaySpecificQuestion(question) {
    // Clear old conversation context for day-specific queries to avoid confusion
    conversationHistory = '';
    addMessage('🔄 Cleared conversation context for accurate day-specific query', 'system');
    
    messageInput.value = question;
    chatForm.dispatchEvent(new Event('submit'));
}

function requestFullPlanReview() {
    const reviewPrompt = "FULL_PLAN_REVIEW_REQUEST: I want you to analyze my complete workout plan and give me your honest assessment. Look at my training philosophy, weekly structure, recent performance history, and overall approach. What do you think of my current plan? What would you change or improve? Give me a comprehensive Grok-style analysis - be direct, insightful, and don't hold back on recommendations for improvement.";

    messageInput.value = reviewPrompt;
    chatForm.dispatchEvent(new Event('submit'));
}
</script>
{% endblock %}
<style>
        .thinking {
            opacity: 0.7;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #007bff;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .streaming-message .typing-cursor {
            animation: blink 1s infinite;
            color: #007bff;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .streaming-content {
            line-height: 1.5;
        }
</style>