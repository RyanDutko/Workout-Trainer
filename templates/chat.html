{% extends "base.html" %}

{% block title %}AI Chat - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-comments me-2"></i>Chat with AI Trainer</h1>
</div>

<div class="row">
    <div class="col-12">
        <div class="card" style="height: 80vh;">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>AI Training Assistant
                    </h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="advancedModeToggle">
                        <label class="form-check-label text-white small" for="advancedModeToggle">
                            <i class="fas fa-brain me-1"></i>Advanced Mode
                        </label>
                    </div>
                </div>
                <div class="small mt-1" id="modeIndicator">
                    <i class="fas fa-circle text-success me-1"></i>
                    <span id="modeText">Standard Mode (Fast & Efficient)</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3" style="max-height: calc(80vh - 200px);">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ask me anything about your workouts, nutrition, progression, or fitness goals!
                        <br><small class="text-muted mt-1">‚ú® I can now auto-detect and execute workout logging from your conversations!</small>
                    </div>
                </div>

                <form id="chatForm" class="d-flex gap-2 align-items-end">
                    <textarea id="messageInput" class="form-control auto-expand"
                              placeholder="Ask about workouts, progression, nutrition..."
                              rows="1"
                              style="resize: none; min-height: 38px; max-height: 120px;"
                              required></textarea>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Questions -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-question-circle me-2"></i>Quick Questions</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-primary btn-sm" onclick="requestFullPlanReview()">
                        <i class="fas fa-clipboard-list me-1"></i>Full Plan Review
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearConversation()">
                        <i class="fas fa-trash me-1"></i>Clear Chat
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="askDaySpecificQuestion('show me my Tuesday workout')">
                        <i class="fas fa-calendar-day me-1"></i>My Tuesday
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="askDaySpecificQuestion('show me what I did on Monday')">
                        <i class="fas fa-calendar-day me-1"></i>My Monday
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('How should I progress my bench press?')">
                        Bench Press Progression
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('What should I eat after my workout?')">
                        Post-Workout Nutrition
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('I\'m feeling sore, should I still workout?')">
                        Training with Soreness
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuestion('How do I break through a plateau?')">
                        Breaking Plateaus
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const chatMessages = document.getElementById('chatMessages');
let chatHistory = [];
let conversationHistory = '';

// Auto-expand textarea functionality
function autoExpandTextarea(textarea) {
    textarea.style.height = 'auto';
    const scrollHeight = textarea.scrollHeight;
    const maxHeight = 120; // max-height from CSS
    const minHeight = 38;  // min-height from CSS

    if (scrollHeight > maxHeight) {
        textarea.style.height = maxHeight + 'px';
        textarea.style.overflowY = 'auto';
    } else {
        textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
        textarea.style.overflowY = 'hidden';
    }
}

// Add event listeners for textarea auto-expansion
messageInput.addEventListener('input', function() {
    autoExpandTextarea(this);

    // Existing auto-save functionality
    const existing = localStorage.getItem('aiChatConversation');

    if (existing) {
        try {
            const data = JSON.parse(existing);
            data.currentInput = messageInput.value;
            data.timestamp = Date.now();
            localStorage.setItem('aiChatConversation', JSON.stringify(data));
        } catch (e) {
            const conversationData = {
                messages: chatMessages.innerHTML,
                history: conversationHistory,
                currentInput: messageInput.value,
                timestamp: Date.now()
            };
            localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
        }
    } else {
        const conversationData = {
            messages: chatMessages.innerHTML,
            history: conversationHistory,
            currentInput: messageInput.value,
            timestamp: Date.now()
        };
        localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
    }
});

// Handle Enter key (submit on Enter, new line on Shift+Enter)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// Load conversation from localStorage on page load
window.addEventListener('load', function() {
    loadConversationFromStorage();
});



// Save conversation to localStorage
function saveConversationToStorage() {
    const conversationData = {
        messages: chatMessages.innerHTML,
        history: conversationHistory,
        currentInput: messageInput.value,
        timestamp: Date.now()
    };
    localStorage.setItem('aiChatConversation', JSON.stringify(conversationData));
}

// Load conversation from localStorage
function loadConversationFromStorage() {
    const saved = localStorage.getItem('aiChatConversation');
    if (saved) {
        try {
            const conversationData = JSON.parse(saved);

            // Check if conversation is less than 2 hours old
            const twoHoursAgo = Date.now() - (2 * 60 * 60 * 1000);
            if (conversationData.timestamp > twoHoursAgo) {
                chatMessages.innerHTML = conversationData.messages;
                conversationHistory = conversationData.history || '';
                messageInput.value = conversationData.currentInput || '';

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Show restore notice
                const restoreNotice = document.createElement('div');
                restoreNotice.className = 'alert alert-info alert-dismissible fade show';
                restoreNotice.innerHTML = `
                    <i class="fas fa-history me-2"></i>
                    <strong>Conversation restored!</strong> Your chat history has been recovered.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="clearConversation()">
                        Start Fresh
                    </button>
                `;
                chatMessages.insertBefore(restoreNotice, chatMessages.firstChild);
            }
        } catch (e) {
            console.log('Error loading conversation:', e);
        }
    }
}

// Clear conversation storage
function clearConversation() {
    localStorage.removeItem('aiChatConversation');
    chatMessages.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Ask me anything about your workouts, nutrition, progression, or fitness goals!
            <br><small class="text-muted mt-1">‚ú® I can now auto-detect and execute workout logging from your conversations!</small>
        </div>
    `;
    conversationHistory = '';
    messageInput.value = '';
}

// Smart context management - limit context for day-specific queries
function getSmartContext(currentMessage) {
    const daySpecificTerms = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday', 'show me what i did', 'my workout'];
    const isDaySpecific = daySpecificTerms.some(term => currentMessage.toLowerCase().includes(term));

    if (isDaySpecific) {
        // For day-specific queries, only use last 2 exchanges to avoid confusion
        const messages = conversationHistory.split('\n\n');
        const recentMessages = messages.slice(-4).join('\n\n'); // Last 2 user-AI exchanges
        return recentMessages;
    }

    // For other queries, limit to last 1000 chars to prevent overwhelming context
    return conversationHistory.slice(-1000);
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, 'user');
    messageInput.value = '';
    // Reset textarea height
    autoExpandTextarea(messageInput);

    // Update conversation history
    conversationHistory += `User: ${message}\n\n`;

    // Save to localStorage
    saveConversationToStorage();

    // Create streaming AI message container
    const aiMessageId = addStreamingMessage();

    // Use smart context management for better day-specific queries
    const smartContext = getSmartContext(message);

    // Send to AI with streaming
    const formData = new FormData();
    formData.append('message', message);
    formData.append('conversation_history', smartContext);
    formData.append('force_advanced_mode', document.getElementById('advancedModeToggle').checked);

    fetch('/chat_stream', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let aiResponse = '';

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Add AI response to conversation history
                    conversationHistory += `Grok: ${aiResponse}\n\n`;
                    finalizeStreamingMessage(aiMessageId);

                    // Save conversation to localStorage
                    saveConversationToStorage();
                    return;
                }

                // Accumulate chunks in buffer
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');

                // Keep the last incomplete line in buffer
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.trim() && line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr && jsonStr !== '') {
                                const data = JSON.parse(jsonStr);
                                if (data.content) {
                                    aiResponse += data.content;
                                    appendToStreamingMessage(aiMessageId, data.content);
                                } else if (data.error) {
                                    updateStreamingMessage(aiMessageId, 'Sorry, I encountered an error. Please try again.');
                                    finalizeStreamingMessage(aiMessageId);
                                    return;
                                } else if (data.done) {
                                    finalizeStreamingMessage(aiMessageId);
                                    return;
                                }
                            }
                        } catch (e) {
                            console.log('Skipping malformed chunk:', line, 'Error:', e.message);
                        }
                    }
                }

                readStream();
            }).catch(error => {
                console.error('Stream reading error:', error);
                updateStreamingMessage(aiMessageId, 'Connection error occurred.');
                finalizeStreamingMessage(aiMessageId);
            });
        }

        readStream();
    })
    .catch(error => {
        updateStreamingMessage(aiMessageId, 'Sorry, I encountered an error. Please try again.');
        finalizeStreamingMessage(aiMessageId);
        console.error('Error:', error);
    });
});

function addMessage(message, type) {
    const messageDiv = document.createElement('div');
    let alertClass, icon;

    if (type === 'user') {
        alertClass = 'alert-primary';
        icon = 'fas fa-user';
    } else if (type === 'system') {
        alertClass = 'alert-info';
        icon = 'fas fa-cog';
    } else {
        alertClass = 'alert-success';
        icon = 'fas fa-robot';
    }

    messageDiv.className = `alert ${alertClass} d-flex align-items-start`;
    messageDiv.innerHTML = `
        <i class="${icon} me-2 mt-1"></i>
        <div>${message.replace(/\n/g, '<br>')}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addStreamingMessage() {
    const messageDiv = document.createElement('div');
    const messageId = 'streaming-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = 'alert alert-success d-flex align-items-start streaming-message';

    messageDiv.innerHTML = `
        <i class="fas fa-robot me-2 mt-1"></i>
        <div class="streaming-content">
            <span class="typing-cursor">‚ñä</span>
        </div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return messageId;
}

function appendToStreamingMessage(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content') || messageDiv.querySelector('.typing-content');
        if (contentDiv) {
            const cursor = contentDiv.querySelector('.typing-cursor') || contentDiv.querySelector('.typing-dots');

            // Insert content before cursor
            const textNode = document.createTextNode(content);
            if (cursor) {
                contentDiv.insertBefore(textNode, cursor);
            } else {
                contentDiv.appendChild(textNode);
            }

            // Auto-scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
}

function updateStreamingMessage(messageId, fullContent) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content') || messageDiv.querySelector('.typing-content');
        contentDiv.innerHTML = fullContent.replace(/\n/g, '<br>');
    }
}

function finalizeStreamingMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const cursor = messageDiv.querySelector('.typing-cursor') || messageDiv.querySelector('.typing-dots');
        if (cursor) {
            cursor.remove();
        }
        messageDiv.classList.remove('streaming-message');
        messageDiv.classList.remove('typing-message');

        // Check if this message contains plan modification keywords
        const messageText = messageDiv.textContent.toLowerCase();
        if ((messageText.includes('add') || messageText.includes('great choice') || messageText.includes('update') || messageText.includes('bump up')) &&
            (messageText.includes('plan') || messageText.includes('monday') || messageText.includes('friday') || messageText.includes('weight')) &&
            !messageText.includes('done!')) {
            // This looks like a plan modification response - add confirmation UI
            setTimeout(() => addPlanModificationConfirmation(messageDiv), 500);
        }
    }
}

function addPlanModificationConfirmation(messageDiv) {
    const messageText = messageDiv.textContent;

    // Parse what the AI actually suggested instead of using keyword detection
    const proposalData = parseAIProposal(messageText);

    if (proposalData) {
        const confirmationDiv = document.createElement('div');
        confirmationDiv.className = 'alert alert-warning mt-2 p-3';

        let actionButton = '';
        let description = '';

        if (proposalData.type === 'rename') {
            description = `Rename "${proposalData.currentName}" to "${proposalData.newName}"`;
            actionButton = `
                <button class="btn btn-success btn-sm me-2" onclick="confirmExerciseRename('${proposalData.currentName}', '${proposalData.newName}', '${proposalData.day}', this)">
                    <i class="fas fa-edit me-1"></i>Rename Exercise
                </button>
            `;
        } else if (proposalData.type === 'weight_update') {
            description = `Update ${proposalData.exercise} weight to ${proposalData.newWeight} on ${proposalData.day}`;
            actionButton = `
                <button class="btn btn-success btn-sm me-2" onclick="confirmWeightUpdate('${proposalData.exercise}', '${proposalData.day}', '${proposalData.newWeight}', this)">
                    <i class="fas fa-arrow-up me-1"></i>Update Weight
                </button>
            `;
        } else if (proposalData.type === 'add_exercise') {
            description = `Add "${proposalData.exercise}" to ${proposalData.day} - ${proposalData.sets}x${proposalData.reps}@${proposalData.weight}`;
            actionButton = `
                <button class="btn btn-success btn-sm me-2" onclick="confirmPlanChangeWithFeedback('${proposalData.exercise}', '${proposalData.day}', ${proposalData.sets}, '${proposalData.reps}', '${proposalData.weight}', this)">
                    <i class="fas fa-plus me-1"></i>Add to Plan
                </button>
            `;
        }

        if (description && actionButton) {
            confirmationDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="fas fa-cog me-2"></i>Plan Modification Proposal</strong>
                        <br><small class="text-muted">${description}</small>
                    </div>
                    <div>
                        ${actionButton}
                        <button class="btn btn-outline-secondary btn-sm" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times me-1"></i>Dismiss
                        </button>
                    </div>
                </div>
            `;

            messageDiv.appendChild(confirmationDiv);
        }
    }
}

function parseAIProposal(messageText) {
    const text = messageText.toLowerCase();

    // Check for rename proposals
    if (text.includes('rename') || text.includes('call it') || text.includes('change the name')) {
        const renameMatch = text.match(/rename.*?([a-zA-Z\s]+(?:drive|press|curl|extension|row)).*?to.*?"([^"]+)"/i) ||
                           text.match(/call.*?([a-zA-Z\s]+(?:drive|press|curl|extension|row)).*?"([^"]+)"/i);

        if (renameMatch) {
            const dayMatch = text.match(/(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/);
            return {
                type: 'rename',
                currentName: renameMatch[1].trim(),
                newName: renameMatch[2].trim(),
                day: dayMatch ? dayMatch[1] : 'monday'
            };
        }
    }

    // Check for weight updates
    if (text.includes('update') && text.includes('weight') || text.includes('bump up') || text.includes('increase')) {
        const exerciseMatch = text.match(/([a-zA-Z\s]+(?:drive|press|curl|extension|row))/);
        const weightMatch = text.match(/(\d+)\s*(?:lbs?|pounds?)/);
        const dayMatch = text.match(/(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/);

        if (exerciseMatch && weightMatch && dayMatch) {
            return {
                type: 'weight_update',
                exercise: exerciseMatch[1].trim(),
                newWeight: weightMatch[1] + 'lbs',
                day: dayMatch[1]
            };
        }
    }

    // Check for exercise additions
    if (text.includes('add') || text.includes('include')) {
        const exerciseMatch = text.match(/add.*?([a-zA-Z\s]+(?:drive|press|curl|extension|row))/);
        const dayMatch = text.match(/(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/);
        const setsMatch = text.match(/(\d+)\s*(?:sets?|x)/);
        const repsMatch = text.match(/(\d+(?:-\d+)?)\s*reps?/);
        const weightMatch = text.match(/(\d+)\s*(?:lbs?|pounds?)/);

        if (exerciseMatch && dayMatch) {
            return {
                type: 'add_exercise',
                exercise: exerciseMatch[1].trim(),
                day: dayMatch[1],
                sets: setsMatch ? parseInt(setsMatch[1]) : 3,
                reps: repsMatch ? repsMatch[1] : '8-12',
                weight: weightMatch ? weightMatch[1] + 'lbs' : 'bodyweight'
            };
        }
    }

    return null;
}

function confirmPlanChange(exercise, day, sets, reps, weight) {
    // Create the plan change
    fetch('/modify_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'add',
            day: day,
            exercise_name: exercise,
            sets: sets,
            reps: reps,
            weight: weight,
            reasoning: 'Added via AI chat confirmation'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            addMessage(`‚úÖ ${data.message}! Check your weekly plan to see the update.`, 'system');
            // Remove the confirmation UI
            document.querySelector('.alert-warning').remove();
        } else {
            addMessage(`‚ùå Error adding exercise: ${data.error}`, 'system');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessage('‚ùå Error confirming plan change', 'system');
    });
}

function confirmExerciseRename(currentName, newName, day, buttonElement) {
    // Show loading state
    const originalButton = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Renaming...';
    buttonElement.disabled = true;

    // Make the rename via direct API call
    fetch('/rename_exercise', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            current_name: currentName,
            new_name: newName,
            day: day
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace the confirmation UI with success message
            const confirmationDiv = buttonElement.closest('.alert-warning');
            confirmationDiv.className = 'alert alert-success mt-2 p-3';
            confirmationDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    <div>
                        <strong>Success!</strong> Renamed "${currentName}" to "${newName}" on ${day.charAt(0).toUpperCase() + day.slice(1)}.
                        <br><small class="text-muted">Check your Weekly Plan tab to see the update.</small>
                    </div>
                </div>
            `;

            // Auto-remove success message after 5 seconds
            setTimeout(() => {
                if (confirmationDiv && confirmationDiv.parentNode) {
                    confirmationDiv.remove();
                }
            }, 5000);
        } else {
            buttonElement.innerHTML = originalButton;
            buttonElement.disabled = false;
            addMessage(`‚ùå Error renaming exercise: ${data.error}`, 'system');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        buttonElement.innerHTML = originalButton;
        buttonElement.disabled = false;
        addMessage('‚ùå Error confirming exercise rename', 'system');
    });
}

function confirmWeightUpdate(exercise, day, weight, buttonElement) {
    // Show loading state
    const originalButton = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    buttonElement.disabled = true;

    // Send confirmation message to trigger the weight update logic
    const confirmationMessage = "yes";

    // Add the confirmation to chat history and trigger the backend logic
    addMessage(confirmationMessage, 'user');

    // Send to AI to trigger the weight update logic
    fetch('/chat_stream', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'message=' + encodeURIComponent(confirmationMessage) + '&conversation_history=' + encodeURIComponent(conversationHistory)
    })
    .then(response => {
        // Replace the confirmation UI with success message
        const confirmationDiv = buttonElement.closest('.alert-warning');
        confirmationDiv.className = 'alert alert-success mt-2 p-3';
        confirmationDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2 text-success"></i>
                <div>
                    <strong>Success!</strong> Updated ${exercise} weight to ${weight} for ${day.charAt(0).toUpperCase() + day.slice(1)}.
                    <br><small class="text-muted">Check your Weekly Plan tab to see the update.</small>
                </div>
            </div>
        `;

        // Auto-remove success message after 5 seconds
        setTimeout(() => {
            if (confirmationDiv && confirmationDiv.parentNode) {
                confirmationDiv.remove();
            }
        }, 5000);
    })
    .catch(error => {
        console.error('Error:', error);
        buttonElement.innerHTML = originalButton;
        buttonElement.disabled = false;
        addMessage('‚ùå Error confirming weight update', 'system');
    });
}

function confirmPlanChangeWithFeedback(exercise, day, sets, reps, weight, buttonElement) {
    // Show loading state
    const originalButton = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
    buttonElement.disabled = true;

    // Create the plan change
    fetch('/modify_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'add',
            day: day,
            exercise_name: exercise,
            sets: sets,
            reps: reps,
            weight: weight,
            reasoning: 'Added via AI chat confirmation'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Replace the confirmation UI with success message
            const confirmationDiv = buttonElement.closest('.alert-warning');
            confirmationDiv.className = 'alert alert-success mt-2 p-3';
            confirmationDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    <div>
                        <strong>Success!</strong> Added ${exercise} to your ${day.charAt(0).toUpperCase() + day.slice(1)} workout.
                        <br><small class="text-muted">Check your Weekly Plan tab to see the update.</small>
                    </div>
                </div>
            `;

            // Auto-remove success message after 5 seconds
            setTimeout(() => {
                if (confirmationDiv && confirmationDiv.parentNode) {
                    confirmationDiv.remove();
                }
            }, 5000);
        } else {
            // Show error and restore button
            buttonElement.innerHTML = originalButton;
            buttonElement.disabled = false;
            addMessage(`‚ùå Error adding exercise: ${data.error}`, 'system');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        buttonElement.innerHTML = originalButton;
        buttonElement.disabled = false;
        addMessage('‚ùå Error confirming plan change', 'system');
    });
}

function askQuestion(question) {
    messageInput.value = question;
    chatForm.dispatchEvent(new Event('submit'));
}

function askDaySpecificQuestion(question) {
    // Clear old conversation context for day-specific queries to avoid confusion
    conversationHistory = '';
    addMessage('üîÑ Cleared conversation context for accurate day-specific query', 'system');

    messageInput.value = question;
    chatForm.dispatchEvent(new Event('submit'));
}

function requestFullPlanReview() {
    const reviewPrompt = "FULL_PLAN_REVIEW_REQUEST: I want you to analyze my complete workout plan and give me your honest assessment. Look at my training philosophy, weekly structure, recent performance history, and overall approach. What do you think of my current plan? What would you change or improve? Give me a comprehensive Grok-style analysis - be direct, insightful, and don't hold back on recommendations for improvement.";

    messageInput.value = reviewPrompt;
    chatForm.dispatchEvent(new Event('submit'));
}

// Handle advanced mode toggle
document.addEventListener('DOMContentLoaded', function() {
    // ... existing loadConversationHistory() call ...
    loadConversationFromStorage();

    const advancedToggle = document.getElementById('advancedModeToggle');
    const modeIndicator = document.getElementById('modeIndicator');
    const modeText = document.getElementById('modeText');

    advancedToggle.addEventListener('change', function() {
        updateModeIndicator();
    });

    function updateModeIndicator() {
        if (advancedToggle.checked) {
            modeIndicator.innerHTML = '<i class="fas fa-circle text-warning me-1"></i><span id="modeText">Advanced Mode (Complex Analysis)</span>';
        } else {
            modeIndicator.innerHTML = '<i class="fas fa-circle text-success me-1"></i><span id="modeText">Standard Mode (Fast & Efficient)</span>';
        }
    }
});


// Modified sendMessage function to include the advanced mode toggle
function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessage(message, 'user');
    messageInput.value = '';

    // Show typing indicator
    const typingId = 'typing-' + Date.now();
    addTypingIndicator(typingId);

    // Send to server
    const formData = new FormData();
    formData.append('message', message);
    formData.append('conversation_history', getConversationHistory());
    formData.append('force_advanced_mode', document.getElementById('advancedModeToggle').checked);

    fetch('/chat_stream', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let aiResponse = '';

        function readStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    conversationHistory += `Grok: ${aiResponse}\n\n`;
                    finalizeStreamingMessage(typingId); // Use typingId instead of aiMessageId
                    saveConversationToStorage();
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.trim() && line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.slice(6).trim();
                            if (jsonStr && jsonStr !== '') {
                                const data = JSON.parse(jsonStr);
                                if (data.content) {
                                    aiResponse += data.content;
                                    appendToStreamingMessage(typingId, data.content); // Use typingId
                                } else if (data.error) {
                                    updateStreamingMessage(typingId, 'Sorry, I encountered an error. Please try again.'); // Use typingId
                                    finalizeStreamingMessage(typingId); // Use typingId
                                    return;
                                } else if (data.done) {
                                    finalizeStreamingMessage(typingId); // Use typingId
                                    return;
                                }
                            }
                        } catch (e) {
                            console.log('Skipping malformed chunk:', line, 'Error:', e.message);
                        }
                    }
                }
                readStream();
            }).catch(error => {
                console.error('Stream reading error:', error);
                updateStreamingMessage(typingId, 'Connection error occurred.'); // Use typingId
                finalizeStreamingMessage(typingId); // Use typingId
            });
        }
        readStream();
    })
    .catch(error => {
        updateStreamingMessage(typingId, 'Sorry, I encountered an error. Please try again.'); // Use typingId
        finalizeStreamingMessage(typingId); // Use typingId
        console.error('Error:', error);
    });
}

// Helper to get conversation history for the API call
function getConversationHistory() {
    return conversationHistory;
}

// Helper to add typing indicator
function addTypingIndicator(id) {
    const messageDiv = document.createElement('div');
    messageDiv.id = id;
    messageDiv.className = 'alert alert-success d-flex align-items-start typing-message'; // Changed class name
    messageDiv.innerHTML = `
        <i class="fas fa-robot me-2 mt-1"></i>
        <div class="typing-content">
            <span class="typing-dots">
                <span></span><span></span><span></span>
            </span>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Helper to append content to typing indicator
function appendToStreamingMessage(messageId, content) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content') || messageDiv.querySelector('.typing-content');
        if (contentDiv) {
            const cursor = contentDiv.querySelector('.typing-cursor') || contentDiv.querySelector('.typing-dots');

            // Insert content before cursor
            const textNode = document.createTextNode(content);
            if (cursor) {
                contentDiv.insertBefore(textNode, cursor);
            } else {
                contentDiv.appendChild(textNode);
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
}

// Helper to update the entire message content
function updateStreamingMessage(messageId, fullContent) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const contentDiv = messageDiv.querySelector('.streaming-content') || messageDiv.querySelector('.typing-content');
        contentDiv.innerHTML = fullContent.replace(/\n/g, '<br>');
    }
}

// Helper to finalize the streaming message (remove typing indicator)
function finalizeStreamingMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
        const typingIndicator = messageDiv.querySelector('.typing-dots') || messageDiv.querySelector('.typing-cursor');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        messageDiv.classList.remove('streaming-message');
        messageDiv.classList.remove('typing-message');
        messageDiv.classList.add('final-message');

        // Check if this message contains plan modification keywords
        const messageText = messageDiv.textContent.toLowerCase();
        if ((messageText.includes('add') || messageText.includes('great choice') || messageText.includes('update') || messageText.includes('bump up')) &&
            (messageText.includes('plan') || messageText.includes('monday') || messageText.includes('friday') || messageText.includes('weight')) &&
            !messageText.includes('done!')) {
            setTimeout(() => addPlanModificationConfirmation(messageDiv), 500);
        }
    }
}
</script>
{% endblock %}
<style>
        .thinking {
            opacity: 0.7;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #007bff;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .streaming-message .typing-cursor {
            animation: blink 1s infinite;
            color: #007bff;
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .streaming-content {
            line-height: 1.5;
        }
</style>