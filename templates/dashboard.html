
{% extends "base.html" %}

{% block title %}Dashboard - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-home me-2"></i>Dashboard</h1>
    <div class="text-muted">{{ today }}</div>
</div>

{% if needs_onboarding %}
    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">Welcome! ðŸŽ¯</h4>
        <p>Complete your profile to get personalized workout recommendations and AI-powered progression tips.</p>
        <hr>
        <a href="{{ url_for('profile') }}" class="btn btn-primary">Complete Profile Setup</a>
    </div>
{% endif %}

<!-- Today's Plan - Main Focus -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-calendar-day me-2"></i>{{ today }}'s Workout Plan</h4>
            </div>
            <div class="card-body">
                {% if today_plan %}
                    <div class="row">
                        {% for row in today_plan %}
                            {% set id, day, exercise, sets, reps, weight, order, notes, completion, newly_added = row %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-left-primary h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h5 class="card-title text-primary">
                                                    {{ exercise.title() }}
                                                    {% if newly_added %}
                                                        <span class="badge bg-success ms-2">New!</span>
                                                    {% endif %}
                                                </h5>
                                                <p class="card-text">
                                                    <span class="badge bg-light text-dark me-2">{{ sets }} sets</span>
                                                    <span class="badge bg-light text-dark me-2">{{ reps }} reps</span>
                                                    <span class="badge bg-light text-dark">{{ weight }}</span>
                                                </p>
                                                
                                                <!-- Completion Status -->
                                                <div class="mb-2">
                                                    <small class="{{ completion.status_class }}">
                                                        {% if completion.completed %}
                                                            <i class="fas fa-check-circle me-1"></i>
                                                        {% else %}
                                                            <i class="fas fa-circle me-1"></i>
                                                        {% endif %}
                                                        {{ completion.status_text }}
                                                    </small>
                                                </div>
                                                
                                                <!-- Show logged details if completed -->
                                                {% if completion.completed %}
                                                    <div class="mb-2">
                                                        <small class="text-success">
                                                            Logged: {{ completion.logged_sets }}x{{ completion.logged_reps }} @ {{ completion.logged_weight }}
                                                        </small>
                                                    </div>
                                                    {% if completion.notes %}
                                                        <div class="mb-2">
                                                            <small class="text-muted fst-italic">{{ completion.notes }}</small>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                                
                                                {% if notes %}
                                                    <small class="text-muted">{{ notes }}</small>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Action Button -->
                                            {% if completion.completed %}
                                                <button class="btn btn-outline-success btn-sm" disabled>
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-success btn-sm" onclick="quickLog('{{ exercise }}', {{ sets }}, '{{ reps }}', '{{ weight }}')">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No plan set for today</h5>
                        <p class="text-muted mb-3">Create your weekly workout schedule to get started</p>
                        <a href="{{ url_for('weekly_plan') }}" class="btn btn-primary">Set Up Weekly Plan</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-dumbbell fa-2x mb-2"></i>
                <h4>{{ "{:,}".format(stats.week_volume) }}</h4>
                <small>lbs lifted this week</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h4>{{ "{:,}".format(stats.month_volume) }}</h4>
                <small>lbs lifted this month</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-fire fa-2x mb-2"></i>
                <h4>{{ stats.week_workouts }}</h4>
                <small>workouts this week</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-weight fa-2x mb-2"></i>
                <h4>{{ stats.latest_weight or 'N/A' }}</h4>
                <small>current weight {% if stats.weight_date %}({{ stats.weight_date }}){% endif %}</small>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Charts Row -->
<div class="row mb-4">
    <!-- Weight Progress Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="fas fa-weight me-2"></i>Body Weight Progress</h6>
            </div>
            <div class="card-body">
                <canvas id="weightChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <form id="weightLogForm" class="row g-2">
                        <div class="col-md-5">
                            <input type="number" id="weightInput" class="form-control form-control-sm" placeholder="Weight (lbs)" step="0.1">
                        </div>
                        <div class="col-md-4">
                            <input type="date" id="weightDate" class="form-control form-control-sm" value="{{ today_date }}">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary btn-sm w-100">Log</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Volume Progress Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="fas fa-chart-line me-2"></i>Weekly Volume Progress</h6>
            </div>
            <div class="card-body">
                <canvas id="volumeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Performance Comparison -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="fas fa-dumbbell me-2"></i>Exercise Performance Analysis</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="exerciseSelect" class="form-select form-select-sm">
                            <option value="">Select exercise to analyze...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="analyzeBtn" class="btn btn-primary btn-sm">Analyze</button>
                    </div>
                </div>
                <canvas id="exerciseChart" width="400" height="200"></canvas>
                <div id="exerciseStats" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('log_workout') }}" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>Log Workout
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('progression') }}" class="btn btn-info w-100">
                            <i class="fas fa-chart-line me-2"></i>Get Progression Tips
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('weekly_plan') }}" class="btn btn-warning w-100">
                            <i class="fas fa-calendar me-2"></i>View Weekly Plan
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('chat') }}" class="btn btn-success w-100">
                            <i class="fas fa-comments me-2"></i>Chat with AI
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Log Modal -->
<div class="modal fade" id="quickLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Log Workout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickLogForm">
                    <div class="mb-3">
                        <label for="quickExerciseName" class="form-label">Exercise</label>
                        <input type="text" class="form-control" id="quickExerciseName" readonly>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="quickSets" class="form-label">Sets</label>
                            <input type="number" class="form-control" id="quickSets" min="1" max="10">
                        </div>
                        <div class="col-md-4">
                            <label for="quickReps" class="form-label">Reps</label>
                            <input type="text" class="form-control" id="quickReps" placeholder="e.g., 12 or 10/10/8">
                        </div>
                        <div class="col-md-4">
                            <label for="quickWeight" class="form-label">Weight</label>
                            <input type="text" class="form-control" id="quickWeight" placeholder="e.g., 180lbs">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="quickNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="quickNotes" rows="2" placeholder="How did it feel?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickLog()">Log Workout</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let weightChart, volumeChart, exerciseChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadExerciseOptions();
    
    // Weight logging form
    document.getElementById('weightLogForm').addEventListener('submit', function(e) {
        e.preventDefault();
        logWeight();
    });
    
    // Exercise analysis
    document.getElementById('analyzeBtn').addEventListener('click', analyzeExercise);
});

function initializeCharts() {
    // Weight Chart
    const weightCtx = document.getElementById('weightChart').getContext('2d');
    weightChart = new Chart(weightCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Weight (lbs)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
    
    // Volume Chart
    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
    volumeChart = new Chart(volumeCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Weekly Volume (lbs)',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Exercise Chart
    const exerciseCtx = document.getElementById('exerciseChart').getContext('2d');
    exerciseChart = new Chart(exerciseCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    loadWeightData();
    loadVolumeData();
}

function loadWeightData() {
    fetch('/get_weight_history')
        .then(response => response.json())
        .then(data => {
            weightChart.data.labels = data.dates;
            weightChart.data.datasets[0].data = data.weights;
            weightChart.update();
        })
        .catch(error => console.error('Error loading weight data:', error));
}

function loadVolumeData() {
    fetch('/get_volume_history')
        .then(response => response.json())
        .then(data => {
            volumeChart.data.labels = data.weeks;
            volumeChart.data.datasets[0].data = data.volumes;
            volumeChart.update();
        })
        .catch(error => console.error('Error loading volume data:', error));
}

function loadExerciseOptions() {
    fetch('/get_exercise_list')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('exerciseSelect');
            data.exercises.forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise.charAt(0).toUpperCase() + exercise.slice(1);
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading exercises:', error));
}

function logWeight() {
    const weight = document.getElementById('weightInput').value;
    const date = document.getElementById('weightDate').value;
    
    if (!weight) {
        alert('Please enter a weight');
        return;
    }
    
    fetch('/log_weight', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            weight: weight,
            date: date
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('weightInput').value = '';
            loadWeightData();
            alert('Weight logged successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

function analyzeExercise() {
    const exercise = document.getElementById('exerciseSelect').value;
    if (!exercise) {
        alert('Please select an exercise');
        return;
    }
    
    fetch(`/get_exercise_performance/${exercise}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.dates.length > 0) {
                // Create extended timeline for progression visualization
                const extendedDates = [...data.dates];
                const lastDate = new Date(data.dates[data.dates.length - 1]);
                const lastWeight = data.max_weights[data.max_weights.length - 1];
                
                // Add 4 future sessions for progression visualization (every 2 sessions = 5lb increase)
                for (let i = 1; i <= 4; i++) {
                    const futureDate = new Date(lastDate);
                    futureDate.setDate(futureDate.getDate() + (i * 7)); // Weekly intervals for display
                    extendedDates.push(futureDate.toISOString().split('T')[0]);
                }
                
                // Create progression data that connects smoothly
                const projectionData = [...data.max_weights];
                for (let i = 1; i <= 4; i++) {
                    // Project 5lb increase every 2 sessions (more realistic progression)
                    const sessionsProgressed = Math.ceil(i / 2);
                    const projectedWeight = lastWeight + (sessionsProgressed * 5);
                    projectionData.push(projectedWeight);
                }
                
                // Update chart with only weight data (remove confusing volume)
                exerciseChart.data.labels = extendedDates;
                exerciseChart.data.datasets = [{
                    label: 'Actual Weight (lbs)',
                    data: data.max_weights.concat(Array(4).fill(null)), // Actual data only
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1,
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: 'rgb(255, 99, 132)',
                    pointRadius: 6
                }, {
                    label: 'Progression Goal (lbs)',
                    data: Array(data.max_weights.length - 1).fill(null).concat(projectionData.slice(data.max_weights.length - 1)),
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    backgroundColor: 'rgba(255, 99, 132, 0.05)',
                    tension: 0.1,
                    borderDash: [5, 5],
                    pointBackgroundColor: 'rgba(255, 99, 132, 0.5)',
                    pointBorderColor: 'rgba(255, 99, 132, 0.5)',
                    pointRadius: 4
                }];
                
                // Remove second y-axis since we're only showing weight
                exerciseChart.options.scales = {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Weight (lbs)'
                        },
                        beginAtZero: false
                    }
                };
                
                exerciseChart.update();
                
                // Update stats
                const statsDiv = document.getElementById('exerciseStats');
                const dataTypeNote = data.has_real_data ? '' : '<small class="text-muted">(Sample progression data - log workouts to see real data)</small>';
                
                // Calculate suggested next weight (5lb increment)
                const nextWeight = data.best_weight + 5;
                
                statsDiv.innerHTML = `
                    ${dataTypeNote}
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <strong>Current Best:</strong><br>
                            ${data.best_weight} lbs<br>
                            <small class="text-muted">${data.best_date}</small>
                        </div>
                        <div class="col-md-3">
                            <strong>Total Sessions:</strong><br>
                            ${data.total_sessions}
                        </div>
                        <div class="col-md-3">
                            <strong>Progress:</strong><br>
                            <span class="badge bg-${data.progress >= 0 ? 'success' : 'danger'}">
                                ${data.progress > 0 ? '+' : ''}${data.progress}%
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Next Goal:</strong><br>
                            <span class="badge bg-primary">${nextWeight} lbs</span><br>
                            <small class="text-muted">+5lb progression</small>
                        </div>
                    </div>
                `;
            } else {
                // No data available
                exerciseChart.data.labels = [];
                exerciseChart.data.datasets = [];
                exerciseChart.update();
                
                document.getElementById('exerciseStats').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No performance data found for "${exercise}". Start logging workouts to see your progress!
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('exerciseStats').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading exercise data. Please try again.
                </div>
            `;
        });
}

function quickLog(exercise, sets, reps, weight) {
    // Populate the modal with the planned workout data
    document.getElementById('quickExerciseName').value = exercise.charAt(0).toUpperCase() + exercise.slice(1);
    document.getElementById('quickSets').value = sets;
    document.getElementById('quickReps').value = reps;
    document.getElementById('quickWeight').value = weight;
    document.getElementById('quickNotes').value = '';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('quickLogModal'));
    modal.show();
}

function submitQuickLog() {
    const exerciseName = document.getElementById('quickExerciseName').value;
    const sets = document.getElementById('quickSets').value;
    const reps = document.getElementById('quickReps').value;
    const weight = document.getElementById('quickWeight').value;
    const notes = document.getElementById('quickNotes').value;
    
    if (!sets || !reps || !weight) {
        alert('Please fill in sets, reps, and weight');
        return;
    }
    
    const workoutData = {
        exercise_name: exerciseName,
        sets: parseInt(sets),
        reps: reps,
        weight: weight,
        notes: notes,
        date: new Date().toISOString().split('T')[0]
    };
    
    fetch('/save_workout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(workoutData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickLogModal'));
            modal.hide();
            
            // Show success message
            alert('Workout logged successfully!');
            
            // Refresh the page to show updated completion status
            window.location.reload();
        } else {
            alert('Error logging workout: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging workout. Please try again.');
    });
}
</script>
{% endblock %}
