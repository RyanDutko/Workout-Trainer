
{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
  <div class="container mx-auto p-6">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-2">Log Workout</h1>
      <p class="text-gray-600">Track your performance and stay on plan</p>
    </div>

    <!-- Date Selection & Plan Loading -->
    <div class="bg-gradient-to-r from-white to-gray-50 rounded-xl shadow-xl p-8 mb-8 border border-gray-200">
      <div class="flex items-center justify-center gap-6">
        <label for="logDate" class="font-bold text-gray-800 text-lg">Select Date:</label>
        <input id="logDate" type="date" class="border-2 border-gray-300 px-6 py-3 rounded-xl text-lg font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all shadow-md">
        <button id="loadDayBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">Load Day</button>
      </div>
    </div>

    <!-- Planned Workouts Preview -->
    <div id="viewPreview" class="mb-8 hidden">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-1">Planned for <span id="previewDate"></span></h2>
        <p class="text-gray-600 mb-6">Ready to crush these exercises?</p>
        <div id="previewList" class="space-y-3 mb-6"></div>
        <div class="text-center">
          <button id="beginBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-8 py-3 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
            üöÄ Begin Logging
          </button>
        </div>
      </div>
    </div>

  <!-- Workout Logging Wizard -->
    <div id="viewLogger" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <!-- Progress Bar -->
        <div class="mb-6">
          <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
            <span>Exercise <span id="currentExercise" class="text-blue-600 font-bold">1</span> of <span id="totalExercises" class="text-blue-600 font-bold">1</span></span>
            <span id="progressPercent" class="text-blue-600 font-bold">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
          </div>
        </div>

        <!-- Current Exercise -->
        <div class="bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200 rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 id="exerciseTitle" class="text-2xl font-bold text-gray-800"></h2>
            <span id="exerciseType" class="text-sm font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full"></span>
          </div>
      
      <!-- Simple Exercise Interface -->
      <div id="simpleInterface" class="hidden">
        <div id="setsContainer" class="space-y-3"></div>
      </div>

      <!-- Complex Exercise Interface -->
      <div id="complexInterface" class="hidden">
        <div class="mb-3">
          <span class="text-sm font-medium text-gray-600">Structure: <span id="complexStructure"></span></span>
        </div>
        <div id="complexContainer" class="space-y-4"></div>
      </div>

      <!-- Notes Section -->
          <div class="mt-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Exercise Notes</label>
            <textarea id="exerciseNotes" rows="3" class="w-full border-2 border-gray-300 rounded-lg p-4 text-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all" placeholder="How did it feel? Any adjustments needed?"></textarea>
          </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between items-center pt-6">
          <button id="prevBtn" class="border-2 border-gray-300 px-6 py-3 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 hover:border-gray-400 transition-all flex items-center gap-2">
            ‚Üê Previous
          </button>
          <button id="nextBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-3 rounded-lg font-bold transition-all transform hover:scale-105 shadow-lg flex items-center gap-2">
            Log & Continue ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Completion Screen -->
    <div id="viewComplete" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <div class="text-green-500 mb-6">
          <i class="fas fa-check-circle text-8xl"></i>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-3">Workout Complete!</h2>
        <p class="text-gray-600 mb-8 text-lg">All exercises have been logged successfully. Great job crushing your workout! üí™</p>
        <div class="flex justify-center gap-4">
          <button onclick="window.location.href='/'" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-all transform hover:scale-105">
            Back to Dashboard
          </button>
          <button onclick="window.location.reload()" class="border-2 border-gray-300 px-6 py-3 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition-all">
            Log Another Day
          </button>
        </div>
      </div>
    </div>

    <div id="msg" class="mt-4 text-center text-gray-600"></div>
    <div id="templateError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mt-4 text-center"></div>
  </div>
</div>

<script>
let workoutPlan = [];
let currentIndex = 0;
let workoutData = {}; // Store all logged data

function $(id) { return document.getElementById(id); }
function show(id) { $(id).classList.remove('hidden'); }
function hide(id) { $(id).classList.add('hidden'); }

// Initialize
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().slice(0, 10);
  $("logDate").value = today;

  $("loadDayBtn").addEventListener("click", loadPlannedWorkouts);
  $("beginBtn").addEventListener("click", startWorkoutWizard);
  $("prevBtn").addEventListener("click", previousExercise);
  $("nextBtn").addEventListener("click", logAndContinue);
});

async function loadPlannedWorkouts() {
  const date = $("logDate").value;
  if (!date) return;

  try {
    $("msg").textContent = "Loading planned workouts...";
    
    const response = await fetch(`/logging_template?date=${encodeURIComponent(date)}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    workoutPlan = data.blocks || [];
    
    if (workoutPlan.length === 0) {
      $("msg").textContent = "No planned workouts found for this date.";
      return;
    }

    displayPlannedWorkouts(date);
    $("msg").textContent = "";
    
  } catch (error) {
    console.error("Error loading workouts:", error);
    $("templateError").textContent = "Failed to load planned workouts";
    show("templateError");
  }
}

function displayPlannedWorkouts(date) {
  $("previewDate").textContent = new Date(date).toLocaleDateString();
  const list = $("previewList");
  list.innerHTML = "";

  workoutPlan.forEach((exercise, index) => {
    const card = document.createElement("div");
    card.className = "bg-gradient-to-r from-blue-500 to-indigo-600 border border-blue-300 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all transform hover:scale-102 text-white";
    
    let description = "";
    let exerciseName = "";
    
    if (exercise.type === "simple") {
      exerciseName = exercise.title;
      // Check weekly plan data structure for sets
      const sets = exercise.sets || exercise.members?.[0]?.planned_sets || exercise.planned_sets || 1;
      const reps = exercise.members?.[0]?.planned_reps || exercise.reps || '';
      const weight = exercise.members?.[0]?.planned_weight?.value || exercise.members?.[0]?.planned_weight || exercise.weight || '';
      description = `${sets} sets √ó ${reps} @ ${weight}lbs`;
    } else if (exercise.rounds && exercise.rounds.length > 0) {
      exerciseName = exercise.title;
      description = `${exercise.rounds.length} round${exercise.rounds.length > 1 ? 's' : ''}`;
    } else {
      exerciseName = exercise.exercise_name || exercise.title || 'Exercise';
      const sets = exercise.sets || 1;
      const reps = exercise.reps || '';
      const weight = exercise.weight || '';
      description = `${sets} sets √ó ${reps} @ ${weight}`;
    }

    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white text-blue-600 rounded-full flex items-center justify-center text-sm font-bold shadow-md">
            ${index + 1}
          </div>
          <span class="font-bold text-lg">${exerciseName}</span>
        </div>
        <span class="text-sm font-semibold bg-white bg-opacity-20 text-white px-3 py-1 rounded-full">${description}</span>
      </div>
    `;
    
    list.appendChild(card);
  });

  show("viewPreview");
}

function startWorkoutWizard() {
  if (workoutPlan.length === 0) return;
  
  currentIndex = 0;
  workoutData = {};
  
  hide("viewPreview");
  show("viewLogger");
  
  displayCurrentExercise();
}

function displayCurrentExercise() {
  const exercise = workoutPlan[currentIndex];
  const totalExercises = workoutPlan.length;
  
  // Update progress
  $("currentExercise").textContent = currentIndex + 1;
  $("totalExercises").textContent = totalExercises;
  $("progressPercent").textContent = Math.round((currentIndex / totalExercises) * 100) + "%";
  $("progressBar").style.width = (currentIndex / totalExercises) * 100 + "%";
  
  // Update exercise info - handle both formats
  const exerciseName = exercise.title || exercise.exercise_name || 'Exercise';
  const exerciseType = exercise.type === "simple" || exercise.block_type === "single" ? "Simple" : "Complex";
  
  $("exerciseTitle").textContent = exerciseName;
  $("exerciseType").textContent = exerciseType;
  
  // Clear previous data
  $("exerciseNotes").value = workoutData[currentIndex]?.notes || "";
  
  // Show appropriate interface
  if (exercise.type === "simple" || exercise.block_type === "single") {
    displaySimpleInterface(exercise);
  } else {
    displayComplexInterface(exercise);
  }
  
  // Update navigation buttons
  $("prevBtn").disabled = currentIndex === 0;
  $("nextBtn").textContent = currentIndex === workoutPlan.length - 1 ? "Complete Workout" : "Log & Continue ‚Üí";
}

function displaySimpleInterface(exercise) {
  hide("complexInterface");
  show("simpleInterface");
  
  const container = $("setsContainer");
  container.innerHTML = "";
  
  // Better sets detection - check the original data structure from weekly plan
  let plannedSets = 1;
  if (exercise.sets && !isNaN(exercise.sets)) {
    plannedSets = parseInt(exercise.sets);
  } else if (exercise.members && exercise.members[0] && exercise.members[0].planned_sets) {
    plannedSets = parseInt(exercise.members[0].planned_sets);
  } else if (exercise.planned_sets && !isNaN(exercise.planned_sets)) {
    plannedSets = parseInt(exercise.planned_sets);
  }
  
  const plannedReps = exercise.members?.[0]?.planned_reps || exercise.reps || '';
  const plannedWeight = exercise.members?.[0]?.planned_weight?.value || exercise.members?.[0]?.planned_weight || exercise.weight || '';
  
  console.log(`Creating ${plannedSets} sets for ${exercise.title || exercise.exercise_name}`);
  
  for (let setNum = 1; setNum <= plannedSets; setNum++) {
    const setDiv = document.createElement("div");
    setDiv.className = "flex items-center gap-4 p-4 bg-gradient-to-r from-gray-50 to-blue-50 border-l-4 border-blue-500 rounded-lg shadow-md mb-3 hover:shadow-lg transition-all transform hover:scale-102";
    
    const existingData = workoutData[currentIndex]?.sets?.[setNum - 1] || {};
    
    setDiv.innerHTML = `
      <div class="w-20 text-center">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full w-14 h-14 flex items-center justify-center font-bold text-xl shadow-lg">
          ${setNum}
        </div>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-bold text-gray-700 mb-2">Reps</label>
        <input type="number" 
               class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-lg font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all shadow-sm" 
               placeholder="${plannedReps}"
               value="${existingData.reps || ''}"
               onchange="updateSetData(${setNum - 1}, 'reps', this.value)">
      </div>
      <div class="flex-1">
        <label class="block text-sm font-bold text-gray-700 mb-2">Weight (lbs)</label>
        <input type="text" 
               class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-lg font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all shadow-sm" 
               placeholder="${plannedWeight}"
               value="${existingData.weight || ''}"
               onchange="updateSetData(${setNum - 1}, 'weight', this.value)">
      </div>
    `;
    
    container.appendChild(setDiv);
  }
}

function displayComplexInterface(exercise) {
  hide("simpleInterface");
  show("complexInterface");
  
  const rounds = exercise.rounds || [];
  $("complexStructure").textContent = `${rounds.length} round${rounds.length > 1 ? 's' : ''}`;
  
  const container = $("complexContainer");
  container.innerHTML = "";
  
  rounds.forEach((round, roundIndex) => {
    const roundDiv = document.createElement("div");
    roundDiv.className = "bg-white border-l-4 border-indigo-500 rounded-lg p-4 shadow-sm mb-4";
    
    const roundHeader = document.createElement("h4");
    roundHeader.className = "font-bold text-lg text-indigo-700 mb-3 flex items-center gap-2";
    roundHeader.innerHTML = `
      <div class="bg-indigo-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
        ${round.round_index}
      </div>
      Round ${round.round_index}
    `;
    roundDiv.appendChild(roundHeader);
    
    const membersDiv = document.createElement("div");
    membersDiv.className = "space-y-3";
    
    (round.members || []).forEach((member, memberIndex) => {
      const memberDiv = document.createElement("div");
      memberDiv.className = "flex items-center gap-3 p-3 bg-gray-50 rounded-lg";
      
      const existingData = workoutData[currentIndex]?.rounds?.[roundIndex]?.[memberIndex] || {};
      
      memberDiv.innerHTML = `
        <div class="w-32 font-semibold text-gray-700">${member.name}</div>
        <div class="flex items-center gap-2">
          <input type="number" 
                 class="w-16 border-2 border-gray-300 rounded-lg px-2 py-1 text-center font-medium focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition-all" 
                 placeholder="${member.planned_reps || ''}"
                 value="${existingData.reps || ''}"
                 onchange="updateRoundData(${roundIndex}, ${memberIndex}, 'reps', this.value)">
          <span class="text-sm text-gray-600 font-medium">reps @</span>
          <input type="text" 
                 class="w-20 border-2 border-gray-300 rounded-lg px-2 py-1 text-center font-medium focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition-all" 
                 placeholder="${member.planned_weight?.value || member.planned_weight || ''}"
                 value="${existingData.weight || ''}"
                 onchange="updateRoundData(${roundIndex}, ${memberIndex}, 'weight', this.value)">
          <span class="text-sm text-gray-600">lbs</span>
        </div>
      `;
      
      membersDiv.appendChild(memberDiv);
    });
    
    roundDiv.appendChild(membersDiv);
    container.appendChild(roundDiv);
  });
}

function updateSetData(setIndex, field, value) {
  if (!workoutData[currentIndex]) workoutData[currentIndex] = { sets: [] };
  if (!workoutData[currentIndex].sets[setIndex]) workoutData[currentIndex].sets[setIndex] = {};
  workoutData[currentIndex].sets[setIndex][field] = value;
}

function updateRoundData(roundIndex, memberIndex, field, value) {
  if (!workoutData[currentIndex]) workoutData[currentIndex] = { rounds: [] };
  if (!workoutData[currentIndex].rounds[roundIndex]) workoutData[currentIndex].rounds[roundIndex] = [];
  if (!workoutData[currentIndex].rounds[roundIndex][memberIndex]) {
    workoutData[currentIndex].rounds[roundIndex][memberIndex] = {};
  }
  workoutData[currentIndex].rounds[roundIndex][memberIndex][field] = value;
}

function previousExercise() {
  if (currentIndex > 0) {
    // Save current notes
    if (!workoutData[currentIndex]) workoutData[currentIndex] = {};
    workoutData[currentIndex].notes = $("exerciseNotes").value;
    
    currentIndex--;
    displayCurrentExercise();
  }
}

async function logAndContinue() {
  // Save current exercise data
  if (!workoutData[currentIndex]) workoutData[currentIndex] = {};
  workoutData[currentIndex].notes = $("exerciseNotes").value;
  
  // Save to backend immediately for each exercise
  await saveCurrentExercise();
  
  if (currentIndex < workoutPlan.length - 1) {
    currentIndex++;
    displayCurrentExercise();
  } else {
    completeWorkout();
  }
}

async function saveCurrentExercise() {
  const exercise = workoutPlan[currentIndex];
  const data = workoutData[currentIndex];
  
  if (!data || (!data.sets && !data.rounds)) return; // No data to save
  
  try {
    const entries = [];
    const date = $("logDate").value;
    
    if (exercise.type === "simple") {
      // Save simple exercise
      if (data.sets) {
        for (let i = 0; i < data.sets.length; i++) {
          const setData = data.sets[i];
          if (setData && (setData.reps || setData.weight)) {
            entries.push({
              input_id: `BLK-${exercise.block_id}.S${i}`,
              actual_reps: setData.reps ? parseInt(setData.reps) : null,
              actual_weight: setData.weight || null
            });
          }
        }
      }
    } else {
      // Save complex exercise
      if (data.rounds) {
        data.rounds.forEach((round, roundIndex) => {
          if (round) {
            round.forEach((member, memberIndex) => {
              if (member && (member.reps || member.weight)) {
                const roundData = exercise.rounds[roundIndex];
                const memberData = roundData?.members[memberIndex];
                if (memberData?.input_id) {
                  entries.push({
                    input_id: memberData.input_id,
                    actual_reps: member.reps ? parseInt(member.reps) : null,
                    actual_weight: member.weight || null
                  });
                }
              }
            });
          }
        });
      }
    }
    
    const blockNotes = [];
    if (data.notes) {
      blockNotes.push({
        block_id: parseInt(exercise.block_id) || 0,
        notes: data.notes
      });
    }
    
    if (entries.length > 0 || blockNotes.length > 0) {
      const response = await fetch("/log_from_template", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date: date,
          entries: entries,
          block_notes: blockNotes
        })
      });
      
      const result = await response.json();
      if (!result.success) {
        console.error("Failed to save exercise:", result.error);
      }
    }
    
  } catch (error) {
    console.error("Error saving exercise:", error);
  }
}

function completeWorkout() {
  hide("viewLogger");
  show("viewComplete");
  
  // Update progress to 100%
  $("progressBar").style.width = "100%";
}
</script>
{% endblock %}
