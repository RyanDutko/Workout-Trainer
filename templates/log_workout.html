
{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Log Workout</h1>

  <!-- Date Selection & Plan Loading -->
  <div class="mb-4 flex items-center gap-2">
    <label for="logDate" class="font-medium">Date:</label>
    <input id="logDate" type="date" class="border px-2 py-1 rounded">
    <button id="loadDayBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Load Day</button>
  </div>

  <!-- Planned Workouts Preview -->
  <div id="viewPreview" class="mb-6 hidden">
    <h2 class="text-xl font-semibold mb-2">Planned for <span id="previewDate"></span></h2>
    <div id="previewList" class="space-y-2 mb-4"></div>
    <button id="beginBtn" class="bg-green-600 text-white px-4 py-2 rounded font-semibold">Begin Logging</button>
  </div>

  <!-- Workout Logging Wizard -->
  <div id="viewLogger" class="hidden">
    <!-- Progress Bar -->
    <div class="mb-4">
      <div class="flex justify-between text-sm text-gray-600 mb-1">
        <span>Exercise <span id="currentExercise">1</span> of <span id="totalExercises">1</span></span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Current Exercise -->
    <div class="bg-white border rounded-lg p-4 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h2 id="exerciseTitle" class="text-xl font-semibold"></h2>
        <span id="exerciseType" class="text-sm bg-gray-100 px-2 py-1 rounded"></span>
      </div>
      
      <!-- Simple Exercise Interface -->
      <div id="simpleInterface" class="hidden">
        <div id="setsContainer" class="space-y-3"></div>
      </div>

      <!-- Complex Exercise Interface -->
      <div id="complexInterface" class="hidden">
        <div class="mb-3">
          <span class="text-sm font-medium text-gray-600">Structure: <span id="complexStructure"></span></span>
        </div>
        <div id="complexContainer" class="space-y-4"></div>
      </div>

      <!-- Notes Section -->
      <div class="mt-4">
        <label class="block text-sm font-medium mb-1">Exercise Notes</label>
        <textarea id="exerciseNotes" rows="2" class="w-full border rounded p-2 text-sm" placeholder="Any notes about this exercise..."></textarea>
      </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between">
      <button id="prevBtn" class="border border-gray-300 px-4 py-2 rounded text-gray-700 hover:bg-gray-50">
        ← Previous
      </button>
      <button id="nextBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Log & Continue →
      </button>
    </div>
  </div>

  <!-- Completion Screen -->
  <div id="viewComplete" class="hidden text-center py-8">
    <div class="text-green-600 mb-4">
      <i class="fas fa-check-circle text-6xl"></i>
    </div>
    <h2 class="text-2xl font-bold mb-2">Workout Complete!</h2>
    <p class="text-gray-600 mb-4">All exercises have been logged successfully.</p>
    <div class="space-x-4">
      <button onclick="window.location.href='/'" class="bg-blue-600 text-white px-4 py-2 rounded">
        Back to Dashboard
      </button>
      <button onclick="window.location.reload()" class="border border-gray-300 px-4 py-2 rounded text-gray-700">
        Log Another Day
      </button>
    </div>
  </div>

  <div id="msg" class="mt-4 text-sm"></div>
  <div id="templateError" class="hidden text-red-600 text-sm mt-2"></div>
</div>

<script>
let workoutPlan = [];
let currentIndex = 0;
let workoutData = {}; // Store all logged data

function $(id) { return document.getElementById(id); }
function show(id) { $(id).classList.remove('hidden'); }
function hide(id) { $(id).classList.add('hidden'); }

// Initialize
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().slice(0, 10);
  $("logDate").value = today;

  $("loadDayBtn").addEventListener("click", loadPlannedWorkouts);
  $("beginBtn").addEventListener("click", startWorkoutWizard);
  $("prevBtn").addEventListener("click", previousExercise);
  $("nextBtn").addEventListener("click", logAndContinue);
});

async function loadPlannedWorkouts() {
  const date = $("logDate").value;
  if (!date) return;

  try {
    $("msg").textContent = "Loading planned workouts...";
    
    const response = await fetch(`/logging_template?date=${encodeURIComponent(date)}`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    workoutPlan = data.blocks || [];
    
    if (workoutPlan.length === 0) {
      $("msg").textContent = "No planned workouts found for this date.";
      return;
    }

    displayPlannedWorkouts(date);
    $("msg").textContent = "";
    
  } catch (error) {
    console.error("Error loading workouts:", error);
    $("templateError").textContent = "Failed to load planned workouts";
    show("templateError");
  }
}

function displayPlannedWorkouts(date) {
  $("previewDate").textContent = new Date(date).toLocaleDateString();
  const list = $("previewList");
  list.innerHTML = "";

  workoutPlan.forEach((exercise, index) => {
    const card = document.createElement("div");
    card.className = "bg-gray-50 border rounded p-3";
    
    let description = "";
    let exerciseName = "";
    
    if (exercise.type === "simple") {
      exerciseName = exercise.title;
      const sets = exercise.planned_sets || exercise.sets || 1;
      const reps = exercise.members?.[0]?.planned_reps || exercise.reps || '';
      const weight = exercise.members?.[0]?.planned_weight || exercise.weight || '';
      description = `${sets} sets x ${reps} @ ${weight}`;
    } else if (exercise.rounds && exercise.rounds.length > 0) {
      exerciseName = exercise.title;
      description = `${exercise.rounds.length} round${exercise.rounds.length > 1 ? 's' : ''}`;
    } else {
      exerciseName = exercise.exercise_name || exercise.title || 'Exercise';
      const sets = exercise.sets || 1;
      const reps = exercise.reps || '';
      const weight = exercise.weight || '';
      description = `${sets} sets x ${reps} @ ${weight}`;
    }

    card.innerHTML = `
      <div class="flex items-center justify-between">
        <span class="font-medium">${exerciseName}</span>
        <span class="text-sm text-gray-600">${description}</span>
      </div>
    `;
    
    list.appendChild(card);
  });

  show("viewPreview");
}

function startWorkoutWizard() {
  if (workoutPlan.length === 0) return;
  
  currentIndex = 0;
  workoutData = {};
  
  hide("viewPreview");
  show("viewLogger");
  
  displayCurrentExercise();
}

function displayCurrentExercise() {
  const exercise = workoutPlan[currentIndex];
  const totalExercises = workoutPlan.length;
  
  // Update progress
  $("currentExercise").textContent = currentIndex + 1;
  $("totalExercises").textContent = totalExercises;
  $("progressPercent").textContent = Math.round((currentIndex / totalExercises) * 100) + "%";
  $("progressBar").style.width = (currentIndex / totalExercises) * 100 + "%";
  
  // Update exercise info - handle both formats
  const exerciseName = exercise.title || exercise.exercise_name || 'Exercise';
  const exerciseType = exercise.type === "simple" || exercise.block_type === "single" ? "Simple" : "Complex";
  
  $("exerciseTitle").textContent = exerciseName;
  $("exerciseType").textContent = exerciseType;
  
  // Clear previous data
  $("exerciseNotes").value = workoutData[currentIndex]?.notes || "";
  
  // Show appropriate interface
  if (exercise.type === "simple" || exercise.block_type === "single") {
    displaySimpleInterface(exercise);
  } else {
    displayComplexInterface(exercise);
  }
  
  // Update navigation buttons
  $("prevBtn").disabled = currentIndex === 0;
  $("nextBtn").textContent = currentIndex === workoutPlan.length - 1 ? "Complete Workout" : "Log & Continue →";
}

function displaySimpleInterface(exercise) {
  hide("complexInterface");
  show("simpleInterface");
  
  const container = $("setsContainer");
  container.innerHTML = "";
  
  // Handle both old and new exercise formats
  const plannedSets = exercise.planned_sets || exercise.sets || 1;
  const plannedReps = exercise.members?.[0]?.planned_reps || exercise.reps || '';
  const plannedWeight = exercise.members?.[0]?.planned_weight || exercise.weight || '';
  
  for (let setNum = 1; setNum <= plannedSets; setNum++) {
    const setDiv = document.createElement("div");
    setDiv.className = "flex items-center gap-3 p-3 bg-gray-50 rounded";
    
    const existingData = workoutData[currentIndex]?.sets?.[setNum - 1] || {};
    
    setDiv.innerHTML = `
      <div class="w-16 text-center font-medium">Set ${setNum}</div>
      <div class="flex-1">
        <label class="block text-xs text-gray-600 mb-1">Reps</label>
        <input type="number" 
               class="w-full border rounded px-2 py-1" 
               placeholder="${plannedReps}"
               value="${existingData.reps || ''}"
               onchange="updateSetData(${setNum - 1}, 'reps', this.value)">
      </div>
      <div class="flex-1">
        <label class="block text-xs text-gray-600 mb-1">Weight</label>
        <input type="text" 
               class="w-full border rounded px-2 py-1" 
               placeholder="${plannedWeight}"
               value="${existingData.weight || ''}"
               onchange="updateSetData(${setNum - 1}, 'weight', this.value)">
      </div>
    `;
    
    container.appendChild(setDiv);
  }
}

function displayComplexInterface(exercise) {
  hide("simpleInterface");
  show("complexInterface");
  
  const rounds = exercise.rounds || [];
  $("complexStructure").textContent = `${rounds.length} round${rounds.length > 1 ? 's' : ''}`;
  
  const container = $("complexContainer");
  container.innerHTML = "";
  
  rounds.forEach((round, roundIndex) => {
    const roundDiv = document.createElement("div");
    roundDiv.className = "border rounded p-3";
    
    const roundHeader = document.createElement("h4");
    roundHeader.className = "font-medium mb-2";
    roundHeader.textContent = `Round ${round.round_index}`;
    roundDiv.appendChild(roundHeader);
    
    const membersDiv = document.createElement("div");
    membersDiv.className = "space-y-2";
    
    (round.members || []).forEach((member, memberIndex) => {
      const memberDiv = document.createElement("div");
      memberDiv.className = "flex items-center gap-2 text-sm";
      
      const existingData = workoutData[currentIndex]?.rounds?.[roundIndex]?.[memberIndex] || {};
      
      memberDiv.innerHTML = `
        <div class="w-24 font-medium">${member.name}</div>
        <input type="number" 
               class="w-16 border rounded px-1 py-0.5" 
               placeholder="${member.planned_reps || ''}"
               value="${existingData.reps || ''}"
               onchange="updateRoundData(${roundIndex}, ${memberIndex}, 'reps', this.value)">
        <span class="text-xs">reps @</span>
        <input type="text" 
               class="w-20 border rounded px-1 py-0.5" 
               placeholder="${member.planned_weight || ''}"
               value="${existingData.weight || ''}"
               onchange="updateRoundData(${roundIndex}, ${memberIndex}, 'weight', this.value)">
      `;
      
      membersDiv.appendChild(memberDiv);
    });
    
    roundDiv.appendChild(membersDiv);
    container.appendChild(roundDiv);
  });
}

function updateSetData(setIndex, field, value) {
  if (!workoutData[currentIndex]) workoutData[currentIndex] = { sets: [] };
  if (!workoutData[currentIndex].sets[setIndex]) workoutData[currentIndex].sets[setIndex] = {};
  workoutData[currentIndex].sets[setIndex][field] = value;
}

function updateRoundData(roundIndex, memberIndex, field, value) {
  if (!workoutData[currentIndex]) workoutData[currentIndex] = { rounds: [] };
  if (!workoutData[currentIndex].rounds[roundIndex]) workoutData[currentIndex].rounds[roundIndex] = [];
  if (!workoutData[currentIndex].rounds[roundIndex][memberIndex]) {
    workoutData[currentIndex].rounds[roundIndex][memberIndex] = {};
  }
  workoutData[currentIndex].rounds[roundIndex][memberIndex][field] = value;
}

function previousExercise() {
  if (currentIndex > 0) {
    // Save current notes
    if (!workoutData[currentIndex]) workoutData[currentIndex] = {};
    workoutData[currentIndex].notes = $("exerciseNotes").value;
    
    currentIndex--;
    displayCurrentExercise();
  }
}

async function logAndContinue() {
  // Save current exercise data
  if (!workoutData[currentIndex]) workoutData[currentIndex] = {};
  workoutData[currentIndex].notes = $("exerciseNotes").value;
  
  // Save to backend immediately for each exercise
  await saveCurrentExercise();
  
  if (currentIndex < workoutPlan.length - 1) {
    currentIndex++;
    displayCurrentExercise();
  } else {
    completeWorkout();
  }
}

async function saveCurrentExercise() {
  const exercise = workoutPlan[currentIndex];
  const data = workoutData[currentIndex];
  
  if (!data || (!data.sets && !data.rounds)) return; // No data to save
  
  try {
    const entries = [];
    const date = $("logDate").value;
    
    if (exercise.type === "simple") {
      // Save simple exercise
      if (data.sets) {
        for (let i = 0; i < data.sets.length; i++) {
          const setData = data.sets[i];
          if (setData && (setData.reps || setData.weight)) {
            entries.push({
              input_id: `BLK-${exercise.block_id}.S${i}`,
              actual_reps: setData.reps ? parseInt(setData.reps) : null,
              actual_weight: setData.weight || null
            });
          }
        }
      }
    } else {
      // Save complex exercise
      if (data.rounds) {
        data.rounds.forEach((round, roundIndex) => {
          if (round) {
            round.forEach((member, memberIndex) => {
              if (member && (member.reps || member.weight)) {
                const roundData = exercise.rounds[roundIndex];
                const memberData = roundData?.members[memberIndex];
                if (memberData?.input_id) {
                  entries.push({
                    input_id: memberData.input_id,
                    actual_reps: member.reps ? parseInt(member.reps) : null,
                    actual_weight: member.weight || null
                  });
                }
              }
            });
          }
        });
      }
    }
    
    const blockNotes = [];
    if (data.notes) {
      blockNotes.push({
        block_id: parseInt(exercise.block_id) || 0,
        notes: data.notes
      });
    }
    
    if (entries.length > 0 || blockNotes.length > 0) {
      const response = await fetch("/log_from_template", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date: date,
          entries: entries,
          block_notes: blockNotes
        })
      });
      
      const result = await response.json();
      if (!result.success) {
        console.error("Failed to save exercise:", result.error);
      }
    }
    
  } catch (error) {
    console.error("Error saving exercise:", error);
  }
}

function completeWorkout() {
  hide("viewLogger");
  show("viewComplete");
  
  // Update progress to 100%
  $("progressBar").style.width = "100%";
}
</script>
{% endblock %}
