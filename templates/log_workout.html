{% extends "base.html" %}

{% block title %}Log Workout - Personal Trainer{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <!-- Logging Mode Selection -->
    <div id="mode-selection" class="text-center">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h2 class="mb-4"><i class="fas fa-dumbbell me-2 text-primary"></i>Log Workout</h2>
                <p class="text-muted mb-4">Choose your logging method:</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card h-100 border-primary" style="cursor: pointer;" onclick="selectMode('live')">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-stopwatch fa-3x text-primary mb-3"></i>
                                <h5>Live Workout</h5>
                                <p class="text-muted mb-0">Track exercises as you perform them with live clock and mobile-friendly interface</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-success" style="cursor: pointer;" onclick="selectMode('post')">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-edit fa-3x text-success mb-3"></i>
                                <h5>Log After Workout</h5>
                                <p class="text-muted mb-0">Quick form to log completed exercises after your workout is done</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Workout Mode - Workout Not Started State -->
    <div id="workout-not-started" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-stopwatch me-2 text-primary"></i>Live Workout</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="backToModeSelection()">
                <i class="fas fa-arrow-left me-1"></i>Back
            </button>
        </div>
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h3 class="mb-3 text-center">Ready to Start?</h3>
                <p class="text-muted mb-4 text-center">Today's plan: <span id="workout-count">0</span> exercises</p>

                <!-- Today's Plan Preview -->
                <div id="plan-preview" class="mb-4">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading plan...</span>
                    </div>
                </div>

                <div class="text-center">
                    <button class="btn btn-primary btn-lg px-5" onclick="beginWorkout()">
                        <i class="fas fa-play me-2"></i>Begin Workout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post-Workout Logging Mode -->
    <div id="post-workout-mode" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-edit me-2 text-success"></i>Log After Workout</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="backToModeSelection()">
                <i class="fas fa-arrow-left me-1"></i>Back
            </button>
        </div>
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <form id="postWorkoutForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="postExerciseName" class="form-label">Exercise Name</label>
                            <input type="text" class="form-control" id="postExerciseName" required 
                                   placeholder="e.g., Bench Press, Squats">
                        </div>
                        <div class="col-md-6">
                            <label for="postWorkoutDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="postWorkoutDate" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="postSets" class="form-label">Sets</label>
                            <input type="number" class="form-control" id="postSets" min="1" max="20" required>
                        </div>
                        <div class="col-md-4">
                            <label for="postReps" class="form-label">Reps</label>
                            <input type="text" class="form-control" id="postReps" required 
                                   placeholder="e.g., 8, 10-12, 8/6/4">
                        </div>
                        <div class="col-md-4">
                            <label for="postWeight" class="form-label">Weight</label>
                            <input type="text" class="form-control" id="postWeight" required 
                                   placeholder="e.g., 185lbs, bodyweight">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="postNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="postNotes" rows="3" 
                                  placeholder="How did it feel? Any observations?"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Log Exercise
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="addAnotherExercise()">
                            <i class="fas fa-plus me-2"></i>Log Another Exercise
                        </button>
                    </div>
                </form>
                
                <!-- Recently Logged (for this session) -->
                <div id="recentlyLogged" style="display: none;" class="mt-4">
                    <h6>Recently Logged This Session:</h6>
                    <div id="recentLogsList" class="list-group list-group-flush">
                        <!-- Recent logs will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Workout State -->
    <div id="workout-active" style="display: none;">
        <!-- Workout Header -->
        <div class="row mb-3">
            <div class="col-6">
                <small class="text-muted">Exercise <span id="current-exercise-num">1</span> of <span id="total-exercises">1</span></small>
            </div>
            <div class="col-6 text-end">
                <div id="live-clock" class="badge bg-secondary fs-6">00:00:00</div>
            </div>
        </div>

        <!-- Current Exercise Card -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body p-4">
                <h3 id="exercise-name" class="text-center mb-3">Exercise Name</h3>
                <div class="text-center mb-4">
                    <div class="badge bg-info fs-6" id="exercise-target">3x10 @ 100lbs</div>
                </div>

                <!-- Workout Status Options -->
                <div class="mb-4">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="workoutStatus" id="statusCompleted" value="completed" checked>
                        <label class="btn btn-outline-success" for="statusCompleted">Complete</label>

                        <input type="radio" class="btn-check" name="workoutStatus" id="statusSkipped" value="skipped">
                        <label class="btn btn-outline-warning" for="statusSkipped">Skip</label>

                        <input type="radio" class="btn-check" name="workoutStatus" id="statusSubstituted" value="substituted">
                        <label class="btn btn-outline-info" for="statusSubstituted">Substitute</label>
                    </div>
                </div>

                <!-- Skip Reason (hidden by default) -->
                <div id="skipReasonContainer" class="mb-3" style="display: none;">
                    <label for="skipReason" class="form-label">Why skipping?</label>
                    <select class="form-select" id="skipReason">
                        <option value="">Select reason...</option>
                        <option value="ran_out_of_time">Ran out of time</option>
                        <option value="too_tired">Too tired/fatigued</option>
                        <option value="machine_taken">Machine was taken</option>
                        <option value="different_gym">At different gym</option>
                        <option value="injury_concern">Injury concern</option>
                        <option value="equipment_broken">Equipment broken</option>
                        <option value="other">Other reason</option>
                    </select>
                </div>

                <!-- Substitution (hidden by default) -->
                <div id="substitutionContainer" class="mb-3" style="display: none;">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <label for="substitutedExercise" class="form-label">What did you do instead?</label>
                            <input type="text" class="form-control" id="substitutedExercise" placeholder="e.g., leg press, goblet squats">
                        </div>
                        <div class="col-12">
                            <label for="substitutionReason" class="form-label">Why substitute?</label>
                            <select class="form-select" id="substitutionReason">
                                <option value="">Select reason...</option>
                                <option value="machine_taken">Machine was taken</option>
                                <option value="different_gym">At different gym</option>
                                <option value="equipment_broken">Equipment broken</option>
                                <option value="felt_better">Felt better for my body</option>
                                <option value="injury_prevention">Injury prevention</option>
                                <option value="other">Other reason</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sets Logging -->
                <div id="setsSection" class="mb-4">
                    <h6 class="mb-3">Log Your Sets:</h6>
                    <div id="setsContainer">
                        <!-- Sets will be populated here -->
                    </div>

                    <!-- Quick Fill -->
                    <div class="mt-3">
                        <small class="text-muted d-block mb-2">Quick fill all sets:</small>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="quickFillAllSets('planned')">As Planned</button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="quickFillAllSets('plus1')">+1 Rep</button>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="quickFillAllSets('minus1')">-1 Rep</button>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label for="workoutNotes" class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" id="workoutNotes" rows="2" placeholder="How did it feel? Easy, challenging, etc."></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="logCurrentExercise()">
                        <i class="fas fa-check me-2"></i>Log & Continue
                    </button>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-secondary w-100" onclick="previousExercise()" id="prevBtn">
                                <i class="fas fa-arrow-left me-1"></i>Previous
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-danger w-100" onclick="endWorkout()">
                                <i class="fas fa-stop me-1"></i>End Workout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workout Complete State -->
    <div id="workout-complete" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center p-5">
                <i class="fas fa-trophy fa-3x text-success mb-3"></i>
                <h2 class="text-success mb-3">Workout Complete!</h2>
                <p class="text-muted mb-4">Great job! All exercises logged.</p>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                    <button class="btn btn-outline-secondary" onclick="startNewWorkout()">
                        <i class="fas fa-plus me-2"></i>Start Another Workout
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global workout state
let currentWorkoutPlan = [];
let currentExerciseIndex = 0;
let workoutStartTime = null;
let clockInterval = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setupWorkoutStatusListeners();
    
    // Set today's date for post-workout form
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('postWorkoutDate').value = today;
    
    // Setup post-workout form handler
    document.getElementById('postWorkoutForm').addEventListener('submit', handlePostWorkoutSubmit);
});

// Mode selection functions
function selectMode(mode) {
    document.getElementById('mode-selection').style.display = 'none';
    
    if (mode === 'live') {
        document.getElementById('workout-not-started').style.display = 'block';
        loadTodaysPlan(); // Only load plan when live mode is selected
    } else if (mode === 'post') {
        document.getElementById('post-workout-mode').style.display = 'block';
    }
}

function backToModeSelection() {
    // Hide all mode-specific sections
    document.getElementById('workout-not-started').style.display = 'none';
    document.getElementById('workout-active').style.display = 'none';
    document.getElementById('post-workout-mode').style.display = 'none';
    
    // Show mode selection
    document.getElementById('mode-selection').style.display = 'block';
    
    // Stop live clock if it's running
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }
}

// Post-workout logging functions
function handlePostWorkoutSubmit(e) {
    e.preventDefault();
    
    const exerciseName = document.getElementById('postExerciseName').value;
    const sets = parseInt(document.getElementById('postSets').value);
    const reps = document.getElementById('postReps').value;
    const weight = document.getElementById('postWeight').value;
    const notes = document.getElementById('postNotes').value;
    const date = document.getElementById('postWorkoutDate').value;
    
    // Create workout data
    const workoutData = {
        exercise_name: exerciseName,
        sets: sets,
        reps: reps,
        weight: weight,
        notes: notes,
        date: date
    };
    
    // Submit to server
    fetch('/save_workout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(workoutData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Add to recently logged list
            addToRecentlyLogged(workoutData);
            
            // Clear form for next entry
            document.getElementById('postExerciseName').value = '';
            document.getElementById('postSets').value = '';
            document.getElementById('postReps').value = '';
            document.getElementById('postWeight').value = '';
            document.getElementById('postNotes').value = '';
            
            // Show success message
            showSuccessMessage('Exercise logged successfully!');
        } else {
            alert('Error logging exercise: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging exercise');
    });
}

function addAnotherExercise() {
    // Just clear the exercise name and focus on it
    document.getElementById('postExerciseName').value = '';
    document.getElementById('postExerciseName').focus();
}

function addToRecentlyLogged(workoutData) {
    const recentSection = document.getElementById('recentlyLogged');
    const recentList = document.getElementById('recentLogsList');
    
    // Show the recent section
    recentSection.style.display = 'block';
    
    // Create new list item
    const listItem = document.createElement('div');
    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    listItem.innerHTML = `
        <div>
            <strong>${workoutData.exercise_name}</strong><br>
            <small class="text-muted">${workoutData.sets}x${workoutData.reps} @ ${workoutData.weight}</small>
        </div>
        <small class="text-muted">${workoutData.date}</small>
    `;
    
    // Add to top of list
    recentList.insertBefore(listItem, recentList.firstChild);
    
    // Keep only last 5 entries
    while (recentList.children.length > 5) {
        recentList.removeChild(recentList.lastChild);
    }
}

function showSuccessMessage(message) {
    // Create and show a temporary success message
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const form = document.getElementById('postWorkoutForm');
    form.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

function loadTodaysPlan() {
    const today = new Date().toISOString().split('T')[0];

    fetch(`/get_plan/${today}`)
        .then(response => response.json())
        .then(data => {
            currentWorkoutPlan = data.exercises || [];
            document.getElementById('workout-count').textContent = currentWorkoutPlan.length;

            // Show plan preview
            const previewContainer = document.getElementById('plan-preview');
            if (currentWorkoutPlan.length > 0) {
                let previewHtml = '<div class="list-group list-group-flush">';
                currentWorkoutPlan.forEach((exercise, index) => {
                    previewHtml += `
                        <div class="list-group-item border-0 py-2">
                            <strong>${exercise.exercise_name.charAt(0).toUpperCase() + exercise.exercise_name.slice(1)}</strong>
                            <span class="badge bg-light text-dark ms-2">${exercise.sets}x${exercise.reps} @ ${exercise.weight}</span>
                        </div>
                    `;
                });
                previewHtml += '</div>';
                previewContainer.innerHTML = previewHtml;
            } else {
                previewContainer.innerHTML = '<p class="text-muted">No exercises planned for today. <a href="/weekly_plan">Set up your plan</a></p>';
            }
        })
        .catch(error => {
            console.error('Error loading plan:', error);
            document.getElementById('plan-preview').innerHTML = '<p class="text-danger">Error loading plan</p>';
        });
}

function beginWorkout() {
    if (currentWorkoutPlan.length === 0) {
        alert('No workout plan for today. Please set up your weekly plan first.');
        return;
    }

    workoutStartTime = new Date();
    currentExerciseIndex = 0;

    // Switch to workout view
    document.getElementById('workout-not-started').style.display = 'none';
    document.getElementById('workout-active').style.display = 'block';

    // Start live clock
    startLiveClock();

    // Load first exercise
    loadCurrentExercise();
}

function startLiveClock() {
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('live-clock').textContent = timeString;
    }

    updateClock(); // Update immediately
    clockInterval = setInterval(updateClock, 1000);
}

function loadCurrentExercise() {
    if (currentExerciseIndex >= currentWorkoutPlan.length) {
        completeWorkout();
        return;
    }

    const exercise = currentWorkoutPlan[currentExerciseIndex];
    const totalExercises = currentWorkoutPlan.length;

    // Update header
    document.getElementById('current-exercise-num').textContent = currentExerciseIndex + 1;
    document.getElementById('total-exercises').textContent = totalExercises;

    // Update exercise info
    document.getElementById('exercise-name').textContent = exercise.exercise_name.charAt(0).toUpperCase() + exercise.exercise_name.slice(1);
    document.getElementById('exercise-target').textContent = `${exercise.sets}x${exercise.reps} @ ${exercise.weight}`;

    // Create set inputs
    const setsContainer = document.getElementById('setsContainer');
    setsContainer.innerHTML = '';

    for (let i = 1; i <= exercise.sets; i++) {
        setsContainer.innerHTML += `
            <div class="row mb-2 align-items-center">
                <div class="col-3">
                    <span class="fw-bold">Set ${i}:</span>
                </div>
                <div class="col-5">
                    <input type="number" class="form-control" id="set${i}Reps" 
                           placeholder="${exercise.reps}" min="0" max="50">
                </div>
                <div class="col-4">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="setReps(${i}, '${exercise.reps}')" title="As planned">
                            ${exercise.reps}
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setReps(${i}, ${parseInt(exercise.reps) + 1})" title="+1">
                            +1
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Reset form state
    document.getElementById('statusCompleted').checked = true;
    document.getElementById('workoutNotes').value = '';
    document.getElementById('skipReasonContainer').style.display = 'none';
    document.getElementById('substitutionContainer').style.display = 'none';
    document.getElementById('setsSection').style.display = 'block';

    // Update previous button
    const prevBtn = document.getElementById('prevBtn');
    if (currentExerciseIndex === 0) {
        prevBtn.disabled = true;
        prevBtn.innerHTML = '<i class="fas fa-arrow-left me-1"></i>Previous';
    } else {
        prevBtn.disabled = false;
        prevBtn.innerHTML = '<i class="fas fa-arrow-left me-1"></i>Previous';
    }
}

function setupWorkoutStatusListeners() {
    document.querySelectorAll('input[name="workoutStatus"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const skipContainer = document.getElementById('skipReasonContainer');
            const substitutionContainer = document.getElementById('substitutionContainer');
            const setsSection = document.getElementById('setsSection');

            if (this.value === 'skipped') {
                skipContainer.style.display = 'block';
                substitutionContainer.style.display = 'none';
                setsSection.style.display = 'none';
            } else if (this.value === 'substituted') {
                skipContainer.style.display = 'none';
                substitutionContainer.style.display = 'block';
                setsSection.style.display = 'block';
            } else {
                skipContainer.style.display = 'none';
                substitutionContainer.style.display = 'none';
                setsSection.style.display = 'block';
            }
        });
    });
}

function setReps(setNumber, reps) {
    document.getElementById(`set${setNumber}Reps`).value = reps;
}

function quickFillAllSets(type) {
    const exercise = currentWorkoutPlan[currentExerciseIndex];
    const plannedReps = parseInt(exercise.reps);
    let repsValue;

    switch(type) {
        case 'planned':
            repsValue = plannedReps;
            break;
        case 'plus1':
            repsValue = plannedReps + 1;
            break;
        case 'minus1':
            repsValue = Math.max(1, plannedReps - 1);
            break;
    }

    for (let i = 1; i <= exercise.sets; i++) {
        document.getElementById(`set${i}Reps`).value = repsValue;
    }
}

function logCurrentExercise() {
    const exercise = currentWorkoutPlan[currentExerciseIndex];
    const workoutStatus = document.querySelector('input[name="workoutStatus"]:checked').value;
    let notes = document.getElementById('workoutNotes').value;

    // Build workout data based on status
    let workoutData = {
        exercise_name: exercise.exercise_name,
        sets: exercise.sets,
        reps: exercise.reps,
        weight: exercise.weight,
        notes: notes,
        status: workoutStatus,
        date: new Date().toISOString().split('T')[0]
    };

    if (workoutStatus === 'skipped') {
        const skipReason = document.getElementById('skipReason').value;
        if (!skipReason) {
            alert('Please select a reason for skipping this exercise');
            return;
        }
        workoutData.skip_reason = skipReason;
        workoutData.sets = 0;
        workoutData.reps = 0;
        workoutData.weight = 0;
    } else if (workoutStatus === 'substituted') {
        const substitutedExercise = document.getElementById('substitutedExercise').value;
        const substitutionReason = document.getElementById('substitutionReason').value;

        if (!substitutedExercise || !substitutionReason) {
            alert('Please fill in what exercise you substituted and why');
            return;
        }

        workoutData.exercise_name = substitutedExercise;
        workoutData.original_exercise = exercise.exercise_name;
        workoutData.substitution_reason = substitutionReason;
    }

    if (workoutStatus === 'completed' || workoutStatus === 'substituted') {
        // Collect actual reps performed
        const setReps = [];
        let allSetsHaveReps = true;

        for (let i = 1; i <= exercise.sets; i++) {
            const reps = document.getElementById(`set${i}Reps`).value;
            if (!reps || reps === '') {
                allSetsHaveReps = false;
                break;
            }
            setReps.push(parseInt(reps));
        }

        if (!allSetsHaveReps) {
            alert('Please fill in reps for all sets');
            return;
        }

        workoutData.reps_performed = setReps;
    }

    // Log the exercise
    fetch('/log_multi_workout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            exercises: [workoutData],
            date: workoutData.date
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Move to next exercise
            currentExerciseIndex++;
            loadCurrentExercise();
        } else {
            alert('Error logging exercise: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging exercise');
    });
}

function previousExercise() {
    if (currentExerciseIndex > 0) {
        currentExerciseIndex--;
        loadCurrentExercise();
    }
}

function completeWorkout() {
    // Stop clock
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }

    // Switch to complete view
    document.getElementById('workout-active').style.display = 'none';
    document.getElementById('workout-complete').style.display = 'block';
}

function endWorkout() {
    if (confirm('Are you sure you want to end your workout early?')) {
        completeWorkout();
    }
}

function startNewWorkout() {
    // Reset everything
    currentExerciseIndex = 0;
    workoutStartTime = null;

    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }

    // Show initial state
    document.getElementById('workout-complete').style.display = 'none';
    document.getElementById('workout-active').style.display = 'none';
    document.getElementById('workout-not-started').style.display = 'block';

    // Reload plan
    loadTodaysPlan();
}
</script>
{% endblock %}