{% extends "base.html" %}

{% block title %}Log Workout{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-dumbbell text-primary"></i>
                        Log Today's Workout
                    </h4>
                    <small class="text-muted" id="currentDate"></small>
                </div>

                <div class="card-body">
                    <!-- Dynamic Logging Form -->
                    <form id="workoutForm" class="needs-validation" novalidate>
                        <div id="dynamicLoggingContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading your workout template...</p>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success btn-lg w-100" id="submitBtn" disabled>
                                    <i class="fas fa-save"></i> Save Workout
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="/dashboard" class="btn btn-secondary btn-lg w-100">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let workoutTemplate = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    const currentDate = new Date().toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('currentDate').textContent = currentDate;

    loadWorkoutTemplate();
});

function loadWorkoutTemplate() {
    const today = new Date().toISOString().split('T')[0];

    fetch(`/logging_template?date=${today}`)
        .then(response => response.json())
        .then(data => {
            workoutTemplate = data;
            renderDynamicLoggingUI(data);
            document.getElementById('submitBtn').disabled = false;
        })
        .catch(error => {
            console.error('Error loading template:', error);
            renderFallbackUI();
        });
}

function renderDynamicLoggingUI(template) {
    const container = document.getElementById('dynamicLoggingContainer');

    if (!template.blocks || template.blocks.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No exercises planned for today</p>';
        return;
    }

    let html = '';

    template.blocks.forEach((block, blockIdx) => {
        if (block.type === 'simple') {
            html += renderSimpleBlock(block, blockIdx);
        } else if (block.type === 'rounds') {
            html += renderRoundsBlock(block, blockIdx);
        }
    });

    container.innerHTML = html;
}

function renderSimpleBlock(block, blockIdx) {
    let html = `
        <div class="card mb-4" data-block-idx="${blockIdx}" data-block-type="simple">
            <div class="card-header">
                <h6 class="mb-0">${block.title}</h6>
                <small class="text-muted">Planned: ${block.planned_sets} sets Ã— ${block.planned_reps} reps @ ${block.planned_weight}</small>
            </div>
            <div class="card-body">
    `;

    // Create input fields for each set
    block.sets.forEach((set, setIdx) => {
        html += `
            <div class="row mb-3 border-bottom pb-2">
                <div class="col-md-1 d-flex align-items-center">
                    <strong>Set ${set.set_number}</strong>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Reps</label>
                    <input type="number" class="form-control" 
                           placeholder="${set.planned_reps}" 
                           data-input-id="${set.input_id}"
                           data-field="actual_reps">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Weight</label>
                    <input type="text" class="form-control" 
                           placeholder="${set.planned_weight.value}${set.planned_weight.unit}" 
                           data-input-id="${set.input_id}"
                           data-field="actual_weight">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Notes</label>
                    <input type="text" class="form-control" 
                           placeholder="Optional notes for this set"
                           data-input-id="${set.input_id}"
                           data-field="notes">
                </div>
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;

    return html;
}

function renderRoundsBlock(block, blockIdx) {
    let html = `
        <div class="card mb-4" data-block-idx="${blockIdx}" data-block-type="rounds">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-repeat"></i> ${block.title}
                </h6>
                <small>Log each exercise for each round</small>
            </div>
            <div class="card-body">
    `;

    block.rounds.forEach((round, roundIdx) => {
        html += `
            <div class="mb-4">
                <h6 class="text-secondary border-bottom pb-2">Round ${round.round_index}</h6>
                <div class="row">
        `;

        round.members.forEach((member, memberIdx) => {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="border rounded p-2">
                        <label class="form-label small fw-bold">
                            ${member.name}
                            ${member.tempo ? `<span class="badge bg-secondary">${member.tempo}</span>` : ''}
                        </label>
                        <div class="input-group input-group-sm mb-1">
                            <input type="number" class="form-control" 
                                   placeholder="${member.planned_reps}" 
                                   data-input-id="${member.input_id}"
                                   data-field="actual_reps">
                            <span class="input-group-text">reps</span>
                        </div>
                        <div class="input-group input-group-sm mb-1">
                            <input type="text" class="form-control" 
                                   placeholder="${member.planned_weight.value}" 
                                   data-input-id="${member.input_id}"
                                   data-field="actual_weight">
                            <span class="input-group-text">${member.planned_weight.unit}</span>
                        </div>
                        <small class="text-muted">
                            Planned: ${member.planned_reps} @ ${member.planned_weight.value}${member.planned_weight.unit}
                        </small>
                    </div>
                </div>
            `;
        });

        html += '</div></div>';
    });

    html += '</div></div>';
    return html;
}

function renderFallbackUI() {
    const container = document.getElementById('dynamicLoggingContainer');
    container.innerHTML = `
        <div class="alert alert-info">
            <h6>Manual Logging</h6>
            <p>Template loading failed. You can still log exercises manually.</p>
            <button type="button" class="btn btn-primary btn-sm" onclick="addManualExercise()">
                <i class="fas fa-plus"></i> Add Exercise
            </button>
        </div>
        <div id="manualEntries"></div>
    `;
}

function addManualExercise() {
    const entriesContainer = document.getElementById('manualEntries');
    const entryId = `manual-${Date.now()}`;

    const html = `
        <div class="card mb-3" id="${entryId}">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Exercise</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sets</label>
                        <input type="number" class="form-control" min="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Reps</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Weight</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeManualExercise('${entryId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    entriesContainer.insertAdjacentHTML('beforeend', html);
}

function removeManualExercise(entryId) {
    document.getElementById(entryId).remove();
}

// Form submission handler
document.getElementById('workoutForm').addEventListener('submit', function(e) {
    e.preventDefault();

    if (workoutTemplate) {
        submitFromTemplate();
    } else {
        submitManualWorkout();
    }
});

function submitFromTemplate() {
    const processedBlocks = [];

    workoutTemplate.blocks.forEach((templateBlock, blockIdx) => {
        const blockElement = document.querySelector(`[data-block-idx="${blockIdx}"]`);

        if (templateBlock.type === 'simple') {
            const processedSets = [];

            templateBlock.sets.forEach(set => {
                const repsInput = blockElement.querySelector(`[data-input-id="${set.input_id}"][data-field="actual_reps"]`);
                const weightInput = blockElement.querySelector(`[data-input-id="${set.input_id}"][data-field="actual_weight"]`);
                const notesInput = blockElement.querySelector(`[data-input-id="${set.input_id}"][data-field="notes"]`);

                processedSets.push({
                    set_number: set.set_number,
                    actual_reps: repsInput ? (repsInput.value || set.planned_reps) : set.planned_reps,
                    actual_weight: weightInput ? (weightInput.value || set.planned_weight.value) : set.planned_weight.value,
                    notes: notesInput ? notesInput.value : ''
                });
            });

            processedBlocks.push({
                ...templateBlock,
                sets: processedSets
            });
        } else if (templateBlock.type === 'rounds') {
            const processedRounds = [];

            templateBlock.rounds.forEach(round => {
                const processedMembers = [];

                round.members.forEach(member => {
                    const repsInput = blockElement.querySelector(`[data-input-id="${member.input_id}"][data-field="actual_reps"]`);
                    const weightInput = blockElement.querySelector(`[data-input-id="${member.input_id}"][data-field="actual_weight"]`);

                    processedMembers.push({
                        ...member,
                        actual_reps: repsInput ? (repsInput.value || member.planned_reps) : member.planned_reps,
                        actual_weight: weightInput ? (weightInput.value || member.planned_weight.value) : member.planned_weight.value
                    });
                });

                processedRounds.push({
                    ...round,
                    members: processedMembers
                });
            });

            processedBlocks.push({
                ...templateBlock,
                rounds: processedRounds
            });
        }
    });

    const submitData = {
        date: workoutTemplate.date,
        blocks: processedBlocks
    };

    fetch('/log_from_template', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(submitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… Workout logged successfully!\n\n${data.message}`);
            window.location.href = '/dashboard';
        } else {
            alert('Error logging workout: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging workout. Please try again.');
    });
}

function submitManualWorkout() {
    const exercises = [];
    const manualEntries = document.querySelectorAll('#manualEntries .card');

    manualEntries.forEach(entry => {
        const inputs = entry.querySelectorAll('input');
        if (inputs.length >= 4 && inputs[0].value.trim()) {
            exercises.push({
                exercise: inputs[0].value.trim(),
                sets: parseInt(inputs[1].value) || 1,
                reps: inputs[2].value.trim(),
                weight: inputs[3].value.trim()
            });
        }
    });

    if (exercises.length === 0) {
        alert('Please add at least one exercise');
        return;
    }

    const submitData = {
        exercises: exercises,
        date: new Date().toISOString().split('T')[0]
    };

    fetch('/save_workout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(submitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… Workout saved successfully!\n\n${data.message}`);
            window.location.href = '/dashboard';
        } else {
            alert('Error saving workout: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving workout. Please try again.');
    });
}
</script>
{% endblock %}