{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Log Workout</h1>

  <div class="mb-4 flex items-center gap-2">
    <label for="logDate" class="font-medium">Date:</label>
    <input id="logDate" type="date" class="border px-2 py-1 rounded">
    <button id="loadDayBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Load Day</button>
  </div>

  <div id="viewPreview" class="mb-6 hidden">
    <h2 class="text-xl font-semibold mb-2">Planned for <span id="previewDate"></span></h2>
    <div id="previewList" class="space-y-2"></div>
    <button id="beginBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">Begin logging</button>
  </div>

  <div id="viewLogger" class="hidden">
    <div class="flex items-baseline gap-2 mb-2">
      <h2 id="blockTitle" class="text-xl font-semibold"></h2>
      <span id="blockPlan" class="text-sm text-gray-600"></span>
    </div>
    <div id="blockBody" class="space-y-3"></div>
    <div class="mt-2">
      <label class="block text-sm font-medium mb-1">Notes (for this block)</label>
      <textarea id="blockNotes" rows="3" class="w-full border rounded p-2"></textarea>
    </div>
    <div class="mt-4 flex justify-between">
      <button id="prevBtn" class="border px-4 py-2 rounded">Back</button>
      <button id="saveNextBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Log &amp; continue</button>
    </div>
  </div>

  <div id="msg" class="mt-4 text-sm"></div>
  <div id="templateError" class="hidden text-red-600 text-sm mt-2"></div>
</div>

<script>
let template = null;     // { date, blocks: [...] }
let mode = "preview";    // "preview" | "active"
let cursor = 0;          // index of current block
let draft = {};          // input_id -> { reps, weight }
let notesDraft = {};     // block_id -> notes

function $(id){ return document.getElementById(id); }
function show(id){ $(id).classList.remove('hidden'); }
function hide(id){ $(id).classList.add('hidden'); }

async function fetchTemplate(dateStr) {
  const resp = await fetch(`/logging_template?date=${encodeURIComponent(dateStr)}`);
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const data = await resp.json();
  const tpl = data.template || { date: data.date, blocks: data.blocks };
  if (!tpl || !Array.isArray(tpl.blocks)) throw new Error("Bad template payload");
  return tpl;
}

function renderPreview() {
  $("previewDate").textContent = template.date;
  const list = $("previewList");
  list.innerHTML = "";
  template.blocks.forEach((b) => {
    const el = document.createElement("div");
    el.className = "border rounded p-2";
    if (b.type === "simple") {
      el.textContent = `${b.title} — ${b.planned_sets || 1} sets`;
    } else {
      const rounds = (b.rounds || []).length || 1;
      el.textContent = `${b.title} — ${rounds} rounds`;
    }
    list.appendChild(el);
  });
  show("viewPreview");
}

function inputRow(label, inputId, plannedReps, plannedWeight) {
  const row = document.createElement("div");
  row.className = "grid grid-cols-3 gap-2 items-center";
  const lab = document.createElement("div");
  lab.textContent = label;
  const reps = document.createElement("input");
  reps.type = "number";
  reps.min = "0";
  reps.placeholder = plannedReps ?? "";
  reps.className = "border p-1 rounded";
  reps.dataset.inputId = inputId;
  reps.dataset.field = "reps";

  const wt = document.createElement("input");
  wt.type = "text";
  wt.placeholder = plannedWeight ?? "";
  wt.className = "border p-1 rounded";
  wt.dataset.inputId = inputId;
  wt.dataset.field = "weight";

  reps.addEventListener("input", syncDraft);
  wt.addEventListener("input", syncDraft);

  row.appendChild(lab);
  row.appendChild(reps);
  row.appendChild(wt);
  return row;
}

function syncDraft(e){
  const iid = e.target.dataset.inputId;
  const field = e.target.dataset.field;
  draft[iid] = draft[iid] || {};
  if (field === "reps") draft[iid].reps = e.target.value === "" ? null : Number(e.target.value);
  if (field === "weight") draft[iid].weight = e.target.value;
}

function renderBlock() {
  const b = template.blocks[cursor];
  $("blockTitle").textContent = b.title;
  $("blockBody").innerHTML = "";
  $("blockNotes").value = notesDraft[b.block_id || b.title] || "";

  if (b.type === "simple") {
    // Expand N sets from planned_sets (default 1)
    const sets = Math.max(1, Number(b.planned_sets || 1));
    $("blockPlan").textContent = `Plan: ${sets} set${sets>1?"s":""}`;
    // Build S0..S{N-1} input rows
    for (let s = 0; s < sets; s++) {
      const baseId = (b.block_id || "").replace("BLK-","") || "0";
      const iid = `BLK-${baseId}.S${s}`;
      const row = inputRow(`Set ${s+1}`, iid, (b.members?.[0]?.planned_reps ?? ""), (b.members?.[0]?.planned_weight ?? ""));
      $("blockBody").appendChild(row);
    }
  } else {
    const rounds = b.rounds || [];
    $("blockPlan").textContent = `Plan: ${rounds.length || 1} round${rounds.length>1?"s":""}`;

    rounds.forEach((r) => {
      const det = document.createElement("details");
      const sum = document.createElement("summary");
      sum.textContent = `Round ${r.round_index}`;
      det.appendChild(sum);

      (r.members || []).forEach((m, i) => {
        const row = inputRow(m.name || `Movement ${i+1}`, m.input_id, m.planned_reps, m.planned_weight);
        row.classList.add("ml-4");
        det.appendChild(row);
      });
      $("blockBody").appendChild(det);
    });
  }

  $("prevBtn").disabled = (cursor === 0);
  $("saveNextBtn").textContent = (cursor === template.blocks.length - 1) ? "Save day" : "Log & continue";
}

async function saveCurrentAndNext() {
  const b = template.blocks[cursor];
  const entries = [];
  // Gather entries for this block
  if (b.type === "simple") {
    const sets = Math.max(1, Number(b.planned_sets || 1));
    const baseId = (b.block_id || "").replace("BLK-","") || "0";
    for (let s = 0; s < sets; s++) {
      const iid = `BLK-${baseId}.S${s}`;
      const d = draft[iid] || {};
      if (d.reps != null || (d.weight && d.weight !== "")) {
        entries.push({ input_id: iid, actual_reps: d.reps, actual_weight: d.weight });
      }
    }
  } else {
    (b.rounds || []).forEach((r) => {
      (r.members || []).forEach((m) => {
        const d = draft[m.input_id] || {};
        if (d.reps != null || (d.weight && d.weight !== "")) {
          entries.push({ input_id: m.input_id, actual_reps: d.reps, actual_weight: d.weight });
        }
      });
    });
  }

  const blockIdKey = b.block_id || b.title; // prefer numeric id when present
  const block_notes = [{
    block_id: Number((b.block_id || "BLK-0").replace("BLK-","")) || 0,
    notes: $("blockNotes").value || ""
  }];

  const body = {
    date: $("logDate").value,
    entries,
    block_notes
  };

  $("msg").textContent = "Saving…";
  const resp = await fetch("/log_from_template", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const data = await resp.json();
  if (!resp.ok || !data.success) {
    $("msg").textContent = "Save failed: " + (data.error || resp.status);
    return;
  }
  $("msg").textContent = `Saved ${data.saved} input(s).`;

  // Advance
  if (cursor < template.blocks.length - 1) {
    cursor++;
    renderBlock();
  } else {
    // Finished the day
   mode = "preview";
    hide("viewLogger");
    show("viewPreview");
  }
}

// Wire up UI
window.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().slice(0,10);
  $("logDate").value = today;

  $("loadDayBtn").addEventListener("click", async () => {
    try {
      template = await fetchTemplate($("logDate").value);
      hide("viewLogger");
      show("viewPreview");
      renderPreview();
      $("templateError").classList.add("hidden");
      $("msg").textContent = "";
    } catch (e) {
      $("templateError").textContent = "Template loading failed";
      $("templateError").classList.remove("hidden");
    }
  });

  $("beginBtn").addEventListener("click", () => {
    if (!template || !template.blocks || template.blocks.length === 0) return;
    cursor = 0;
    hide("viewPreview");
    show("viewLogger");
    renderBlock();
  });

  $("prevBtn").addEventListener("click", () => {
    if (cursor > 0) {
      cursor--;
      renderBlock();
    }
  });
  $("saveNextBtn").addEventListener("click", saveCurrentAndNext);
});
</script>
{% endblock %}