
{% extends "base.html" %}

{% block title %}Progression - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-chart-line me-2"></i>AI Progression Management</h1>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <!-- Instructions Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h6><i class="fas fa-info-circle me-2"></i>How This Works</h6>
                <p class="mb-0">
                    1. Get AI-powered progression suggestions based on your current plan and workout history<br>
                    2. Review suggestions organized by workout day<br>
                    3. Approve/reject changes with one click<br>
                    4. Approved changes automatically update your weekly plan
                </p>
            </div>
        </div>

        <!-- Get Suggestions -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <button id="getProgressionBtn" class="btn btn-primary btn-lg">
                    <i class="fas fa-robot me-2"></i>Get AI Progression Suggestions
                </button>
                
                <div id="loadingSpinner" class="mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing your progress and generating suggestions...</p>
                </div>
            </div>
        </div>

        <!-- Progression Review - Organized by Day -->
        <div id="progressionReview" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-clipboard-check me-2"></i>Review Progression Suggestions</h4>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="selectAllToggle" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAllToggle">
                        Select All
                    </label>
                </div>
            </div>

            <div id="dayByDayProgression">
                <!-- Days will be populated here -->
            </div>

            <!-- Apply Button -->
            <div class="text-center mt-4">
                <button id="applyProgressionBtn" class="btn btn-success btn-lg" onclick="applySelectedProgressions()" disabled>
                    <i class="fas fa-check me-2"></i>Confirm Progressions (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="successMessage" class="alert alert-success mt-4" style="display: none;">
            <i class="fas fa-check-circle me-2"></i>
            <span id="successText"></span>
        </div>

        <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let weeklyPlan = {};
let progressionSuggestions = {};
let selectedProgressions = new Set();

document.getElementById('getProgressionBtn').addEventListener('click', function() {
    const btn = this;
    const spinner = document.getElementById('loadingSpinner');
    const reviewSection = document.getElementById('progressionReview');
    
    // Show loading state
    btn.disabled = true;
    spinner.style.display = 'block';
    reviewSection.style.display = 'none';
    hideMessages();
    
    // First get weekly plan, then get progressions
    Promise.all([fetchWeeklyPlan(), fetchProgressions()])
        .then(([planData, progressionData]) => {
            weeklyPlan = planData;
            progressionSuggestions = progressionData;
            
            renderProgressionReview();
            reviewSection.style.display = 'block';
        })
        .catch(err => {
            showError('Failed to get progression suggestions. Please try again.');
            console.error('Error:', err);
        })
        .finally(() => {
            spinner.style.display = 'none';
            btn.disabled = false;
        });
});

function fetchWeeklyPlan() {
    return fetch('/api/weekly_plan')
        .then(response => response.json());
}

function fetchProgressions() {
    return fetch('/get_progression', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        return parseGrokSuggestions(data.suggestions);
    });
}

function parseGrokSuggestions(rawText) {
    const lines = rawText.split('\n');
    const suggestions = {};
    
    for (let line of lines) {
        if (line.trim().startsWith('â€¢ ') && line.includes(':')) {
            const cleanLine = line.trim().substring(2);
            const colonIndex = cleanLine.indexOf(':');
            
            if (colonIndex > 0) {
                const exerciseName = cleanLine.substring(0, colonIndex).trim().toLowerCase();
                const suggestion = cleanLine.substring(colonIndex + 1).trim();
                
                // Parse the suggestion
                const isProgression = !suggestion.toLowerCase().includes('stay at');
                let reasoning = '';
                let newValue = '';
                
                if (isProgression) {
                    // Extract new weight/reps from suggestion
                    const weightMatch = suggestion.match(/(\d+)\s*(lbs?|kg)/i);
                    const repMatch = suggestion.match(/(\d+)\s*reps?/i);
                    
                    if (weightMatch) newValue = weightMatch[0];
                    else if (repMatch) newValue = repMatch[1] + ' reps';
                    else newValue = suggestion;
                } else {
                    // Extract reasoning for staying at current weight
                    const dashIndex = suggestion.indexOf(' - ');
                    if (dashIndex > 0) {
                        reasoning = suggestion.substring(dashIndex + 3).trim();
                    }
                }
                
                suggestions[exerciseName] = {
                    isProgression,
                    suggestion: suggestion,
                    newValue,
                    reasoning,
                    selected: false
                };
            }
        }
    }
    
    return suggestions;
}

function renderProgressionReview() {
    const container = document.getElementById('dayByDayProgression');
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    let html = '';
    
    days.forEach(day => {
        const dayExercises = weeklyPlan[day] || [];
        
        if (dayExercises.length > 0) {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">${day.charAt(0).toUpperCase() + day.slice(1)}</h6>
                    </div>
                    <div class="card-body">
            `;
            
            dayExercises.forEach(exercise => {
                const exerciseName = exercise.exercise_name.toLowerCase();
                const suggestion = progressionSuggestions[exerciseName];
                const isChanged = suggestion && suggestion.isProgression;
                
                html += `
                    <div class="row align-items-center py-2 border-bottom ${isChanged ? 'bg-warning bg-opacity-10 border-warning' : ''}">
                        <div class="col-md-6">
                            <strong class="${isChanged ? 'text-warning' : ''}">${exercise.exercise_name}</strong>
                            <br>
                            <small class="text-muted">Current: ${exercise.sets}x${exercise.reps} @ ${exercise.weight}</small>
                            ${isChanged ? `<br><small class="text-success"><i class="fas fa-arrow-up me-1"></i>Suggested: ${suggestion.newValue}</small>` : ''}
                            ${suggestion && !suggestion.isProgression ? `<br><small class="text-info"><i class="fas fa-pause me-1"></i>${suggestion.reasoning}</small>` : ''}
                        </div>
                        <div class="col-md-6 text-end">
                            ${isChanged ? `
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox" id="progression_${exerciseName}" 
                                           onchange="toggleProgression('${exerciseName}')">
                                    <label class="form-check-label" for="progression_${exerciseName}">
                                        Apply Change
                                    </label>
                                </div>
                            ` : `
                                <span class="badge bg-secondary">No Change</span>
                            `}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
    });
    
    if (html === '') {
        html = '<p class="text-muted text-center">No exercises found in weekly plan.</p>';
    }
    
    container.innerHTML = html;
    updateApplyButton();
}

function toggleProgression(exercise) {
    const checkbox = document.getElementById(`progression_${exercise}`);
    
    if (checkbox.checked) {
        selectedProgressions.add(exercise);
    } else {
        selectedProgressions.delete(exercise);
    }
    
    // Update the select all toggle state
    const allProgressionExercises = Object.keys(progressionSuggestions).filter(ex => progressionSuggestions[ex].isProgression);
    const allSelected = allProgressionExercises.every(ex => selectedProgressions.has(ex));
    document.getElementById('selectAllToggle').checked = allSelected;
    
    updateApplyButton();
}

function toggleSelectAll() {
    const selectAllToggle = document.getElementById('selectAllToggle');
    const isSelectingAll = selectAllToggle.checked;
    
    selectedProgressions.clear();
    
    Object.keys(progressionSuggestions).forEach(exercise => {
        if (progressionSuggestions[exercise].isProgression) {
            const checkbox = document.getElementById(`progression_${exercise}`);
            if (checkbox) {
                checkbox.checked = isSelectingAll;
                if (isSelectingAll) {
                    selectedProgressions.add(exercise);
                }
            }
        }
    });
    
    updateApplyButton();
}

function clearAllSelections() {
    selectedProgressions.clear();
    
    Object.keys(progressionSuggestions).forEach(exercise => {
        const checkbox = document.getElementById(`progression_${exercise}`);
        if (checkbox) checkbox.checked = false;
    });
    
    document.getElementById('selectAllToggle').checked = false;
    updateApplyButton();
}

function updateApplyButton() {
    const btn = document.getElementById('applyProgressionBtn');
    const count = selectedProgressions.size;
    
    document.getElementById('selectedCount').textContent = count;
    btn.disabled = count === 0;
}

function applySelectedProgressions() {
    if (selectedProgressions.size === 0) return;
    
    const btn = document.getElementById('applyProgressionBtn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Applying Changes...';
    
    // Build changes array
    const changes = Array.from(selectedProgressions).map(exercise => {
        const suggestion = progressionSuggestions[exercise];
        const change = { exercise_name: exercise };
        
        // Parse new values from suggestion
        const weightMatch = suggestion.suggestion.match(/(\d+)\s*(lbs?|kg)/i);
        const repMatch = suggestion.suggestion.match(/(\d+)\s*reps?/i);
        
        if (weightMatch) {
            change.weight = weightMatch[0];
        }
        if (repMatch) {
            change.reps = repMatch[1];
        }
        
        return change;
    });
    
    fetch('/apply_progression', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            document.getElementById('progressionReview').style.display = 'none';
            selectedProgressions.clear();
        } else {
            showError(data.error || 'Failed to apply changes');
        }
    })
    .catch(err => {
        showError('Error applying changes');
        console.error('Error:', err);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function showSuccess(message) {
    document.getElementById('successText').textContent = message;
    document.getElementById('successMessage').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('successMessage').style.display = 'none';
}

function hideMessages() {
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
}
</script>
{% endblock %}
