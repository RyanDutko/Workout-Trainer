
{% extends "base.html" %}

{% block title %}History - Personal Trainer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-history me-2"></i>Workout History</h1>
</div>

<!-- Filters and Controls -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label for="dateFilter" class="form-label">Filter by Date</label>
                <input type="date" class="form-control" id="dateFilter" onchange="filterWorkouts()">
            </div>
            <div class="col-md-3">
                <label for="exerciseFilter" class="form-label">Filter by Exercise</label>
                <select class="form-control" id="exerciseFilter" onchange="filterWorkouts()">
                    <option value="">All Exercises</option>
                    {% set exercises = workouts | map(attribute=0) | list | unique %}
                    {% for exercise in exercises %}
                        <option value="{{ exercise }}">{{ exercise.title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortBy" class="form-label">Sort by</label>
                <select class="form-control" id="sortBy" onchange="sortWorkouts()">
                    <option value="date-desc">Date (Newest First)</option>
                    <option value="date-asc">Date (Oldest First)</option>
                    <option value="exercise">Exercise Name</option>
                    <option value="weight">Weight</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if workouts %}
            <div class="table-responsive">
                <table class="table table-hover" id="workoutsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Exercise</th>
                            <th>Sets</th>
                            <th>Reps</th>
                            <th>Weight</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for workout in workouts %}
                            {% set exercise, sets, reps, weight, date, notes, workout_id = workout %}
                            <tr data-workout-id="{{ workout_id }}" data-date="{{ date }}" data-exercise="{{ exercise }}" data-weight="{{ weight }}">
                                <td>{{ date }}</td>
                                <td><strong>{{ exercise.title() }}</strong></td>
                                <td>{{ sets }}</td>
                                <td>{{ reps }}</td>
                                <td>{{ weight }}</td>
                                <td>{{ notes or '-' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorkout({{ workout_id }}, '{{ exercise }}', {{ sets }}, '{{ reps }}', '{{ weight }}', '{{ notes or '' }}', '{{ date }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkout({{ workout_id }}, '{{ exercise }}', '{{ date }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-dumbbell fa-3x text-muted mb-3"></i>
                <h5>No workouts logged yet</h5>
                <p class="text-muted">Start by <a href="{{ url_for('log_workout') }}">logging your first workout</a>!</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Edit Workout Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Workout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editWorkoutForm">
                    <input type="hidden" id="editWorkoutId">
                    <div class="mb-3">
                        <label for="editExercise" class="form-label">Exercise</label>
                        <input type="text" class="form-control" id="editExercise" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editSets" class="form-label">Sets</label>
                            <input type="number" class="form-control" id="editSets" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editReps" class="form-label">Reps</label>
                            <input type="text" class="form-control" id="editReps" placeholder="e.g. 12 or 10/10/8" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editWeight" class="form-label">Weight</label>
                            <input type="text" class="form-control" id="editWeight" placeholder="e.g. 185lbs" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditedWorkout">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this workout?</p>
                <div class="alert alert-warning">
                    <strong id="deleteWorkoutDetails"></strong>
                </div>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Workout</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let workoutToDelete = null;
let workoutToEdit = null;

function editWorkout(workoutId, exercise, sets, reps, weight, notes, date) {
    workoutToEdit = workoutId;
    
    document.getElementById('editWorkoutId').value = workoutId;
    document.getElementById('editExercise').value = exercise;
    document.getElementById('editSets').value = sets;
    document.getElementById('editReps').value = reps;
    document.getElementById('editWeight').value = weight;
    document.getElementById('editNotes').value = notes || '';
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

function deleteWorkout(workoutId, exercise, date) {
    workoutToDelete = workoutId;
    document.getElementById('deleteWorkoutDetails').textContent = `${exercise.charAt(0).toUpperCase() + exercise.slice(1)} on ${date}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

document.getElementById('saveEditedWorkout').addEventListener('click', function() {
    if (workoutToEdit) {
        const updatedData = {
            workout_id: workoutToEdit,
            exercise_name: document.getElementById('editExercise').value,
            sets: parseInt(document.getElementById('editSets').value),
            reps: document.getElementById('editReps').value,
            weight: document.getElementById('editWeight').value,
            notes: document.getElementById('editNotes').value
        };
        
        fetch('/edit_workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the row in the table
                const row = document.querySelector(`tr[data-workout-id="${workoutToEdit}"]`);
                if (row) {
                    const cells = row.querySelectorAll('td');
                    cells[1].innerHTML = `<strong>${updatedData.exercise_name.charAt(0).toUpperCase() + updatedData.exercise_name.slice(1)}</strong>`;
                    cells[2].textContent = updatedData.sets;
                    cells[3].textContent = updatedData.reps;
                    cells[4].textContent = updatedData.weight;
                    cells[5].textContent = updatedData.notes || '-';
                    
                    // Update data attributes for filtering
                    row.setAttribute('data-exercise', updatedData.exercise_name);
                    row.setAttribute('data-weight', updatedData.weight);
                }
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                
                // Show success message
                showAlert('Workout updated successfully', 'success');
            } else {
                showAlert('Error updating workout: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error updating workout', 'danger');
        });
        
        workoutToEdit = null;
    }
});

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (workoutToDelete) {
        fetch('/delete_workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                workout_id: workoutToDelete
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-workout-id="${workoutToDelete}"]`);
                if (row) {
                    row.remove();
                }
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                
                // Show success message
                showAlert('Workout deleted successfully', 'success');
            } else {
                showAlert('Error deleting workout: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error deleting workout', 'danger');
        });
        
        workoutToDelete = null;
    }
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

function filterWorkouts() {
    const dateFilter = document.getElementById('dateFilter').value;
    const exerciseFilter = document.getElementById('exerciseFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#workoutsTable tbody tr');
    
    rows.forEach(row => {
        const rowDate = row.dataset.date;
        const rowExercise = row.dataset.exercise.toLowerCase();
        
        let showRow = true;
        
        if (dateFilter && rowDate !== dateFilter) {
            showRow = false;
        }
        
        if (exerciseFilter && rowExercise !== exerciseFilter) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function sortWorkouts() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.querySelector('#workoutsTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        switch(sortBy) {
            case 'date-desc':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'date-asc':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'exercise':
                return a.dataset.exercise.localeCompare(b.dataset.exercise);
            case 'weight':
                return parseFloat(b.dataset.weight) - parseFloat(a.dataset.weight);
            default:
                return 0;
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function clearFilters() {
    document.getElementById('dateFilter').value = '';
    document.getElementById('exerciseFilter').value = '';
    document.getElementById('sortBy').value = 'date-desc';
    filterWorkouts();
    sortWorkouts();
}
</script>
{% endblock %}
